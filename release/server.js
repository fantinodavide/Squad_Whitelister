const{match:match}=require("assert"),cp=require("child_process");var installingDependencies=!1;const irequire=async e=>{console.log(`Requiring "${e}"`);try{require.resolve(e)}catch(e){installingDependencies||(installingDependencies=!0,console.log("INSTALLING DEPENDENCIES...\nTHIS PROCESS MAY TAKE SOME TIME. PLEASE WAIT")),cp.execSync("npm install"),await setImmediate((()=>{})),console.log("DEPENDECIES INSTALLED")}try{return require(e)}catch(s){console.log(`Could not include "${e}". Restart the script`),restartProcess(0,1)}};installUpdateDependencies=async()=>{console.log("INSTALLING/UPDATING DEPENDENCIES...\nTHIS PROCESS MAY TAKE SOME TIME. PLEASE WAIT"),cp.execSync("npm install")};var subcomponent_status={discord_bot:!1,squadjs:[]},subcomponent_data={discord_bot:{invite_link:""},squadjs:[],database:{root_user_registered:!1},updater:{updating:!1}},apiDocsJson=null;async function init(){const e=(await irequire("./package.json")).version,s=await irequire("fs-extra"),t=await irequire("node-stream-zip"),n=await irequire("https"),o=await irequire("http"),i=await irequire("express"),r=i(),a=await irequire("path"),l=await irequire("mongodb"),c=l.MongoClient,d=l.ObjectID,u=await irequire("crypto"),p=await irequire("body-parser"),_=await irequire("cookie-parser"),m=await irequire("nocache"),g=await irequire("log4js"),f=await irequire("axios"),y=(await irequire("minimist"))(process.argv.slice(2)),h=(await irequire("node-run-cmd"),await irequire("express-force-ssl")),w=await irequire("find-free-port"),{mainModule:b}=await irequire("process"),v=await irequire("discord.js"),{io:S}=await irequire("socket.io-client"),$=await irequire("dns"),{rateLimit:k}=await irequire("express-rate-limit"),D=require("util").promisify($.lookup);try{(await irequire("dotenv")).config()}catch(e){console.error(e)}var I=0,A=null;const O=y.c||"conf.json",q=console.log,C=console.error;let E=new Date;const x=a.join(__dirname,"logs",E.toISOString().replace(/T/g,"_").replace(/(:|-|\.|Z)/g,"")+".log");s.existsSync("logs")||s.mkdirSync("logs"),s.existsSync(x)||s.writeFileSync(x,""),g.configure({appenders:{App:{type:"file",filename:x}},categories:{default:{appenders:["App"],level:"all"}}});const j=g.getLogger("App");console.log("Log-file:",x);var T,R={http:void 0,https:void 0,configs:{https:{port:void 0},http:{port:void 0}},logging:{requests:!1}},P={ws:null,initDone:!1},L=[];var M,F;const U=new Map,N=new Map,B=k({windowMs:6e4,limit:1e3,standardHeaders:"draft-8",legacyHeaders:!1,ipv6Subnet:56}),G=k({windowMs:6e4,limit:50,standardHeaders:"draft-8",legacyHeaders:!1,ipv6Subnet:56}),H=k({windowMs:6e4,limit:500,standardHeaders:"draft-8",legacyHeaders:!1,ipv6Subnet:56}),z=k({windowMs:36e5,limit:3,standardHeaders:"draft-8",legacyHeaders:!1,ipv6Subnet:56}),J=k({windowMs:3e4,limit:6,standardHeaders:"draft-8",legacyHeaders:!1,ipv6Subnet:56});async function W(){try{const s=await X(),t=await s.collection("app_metadata").findOne({key:"app_version"}),n=t?t.value:null;if(n!==e){if(console.log(" > First start after update detected"),console.log(`   Previous version: ${n||"none (first install)"}`),console.log(`   Current version: ${e}`),"1.6.10"===e)await async function(){try{const e=await X(),s=await e.collection("keys").deleteMany({});console.log(`   > Cleared ${s.deletedCount} API key(s)`)}catch(e){console.error("   > Error clearing API keys:",e)}}(),await async function(){try{const e=await X(),s=await e.collection("sessions").deleteMany({});console.log(`   > Cleared ${s.deletedCount} Session(s)`)}catch(e){console.error("   > Error clearing Sessions:",e)}}();await s.collection("app_metadata").updateOne({key:"app_version"},{$set:{value:e,updated_at:new Date}},{upsert:!0}),console.log(" > First-start scripts completed")}else console.log(` > Normal start (version ${e})`)}catch(e){console.error(" > Error checking first start status:",e)}}function V(){async function o(e,s="",t=!1,n=!1){const o=`/${e}/${s}?${t}`;let i,r=!1;const a=U.get(o);a&&(r=!0,i=a);const l=Date.now();if(a&&!n||(await C(),i=await function(e,s="",t=!1){let n=new Promise(((n,o)=>{X((o=>{o.collection("lists").findOne({output_path:e},((i,r)=>{if(i)ee(res,i);else if(null!=r){let i=s&&""!=s?{clan_code:s}:{},a="",l=[],c=[],d=[],u=[],p=[];const _=oe(6);o.collection("clans").find(i).toArray(((i,m)=>{for(let e of m)c[e._id.toString()]=e,d.push(e._id);o.collection("groups").find().sort({group_name:1}).toArray(((i,m)=>{for(let e of m)l[e._id.toString()]=e;l[_]={group_name:_,group_permissions:["reserve"]};const g=[{$match:{approved:!0,id_clan:{$in:d},id_list:r._id}},{$lookup:{from:"players",let:{steamid64:"$steamid64"},pipeline:[{$match:{$expr:{$eq:["$steamid64","$$steamid64"]},discord_user_id:{$exists:!0}}}],as:"serverPlayerData"}},{$sort:{id_clan:1,id_group:1,username_l:1}}];o.collection("whitelists").aggregate(g).toArray(((i,r)=>{if(i)ee(res,i);else if(null!=r){for(let g of r){let f=(g.serverPlayerData&&g.serverPlayerData[0]?g.serverPlayerData[0].discord_username:null)||g.discord_username||"";p.push({username:g.username,steamid64:g.steamid64,eosID:g.eosID,groupId:g.id_group,clanTag:c[g.id_clan].tag,discordUsername:f})}if(s)m();else{const y=[{$match:{steamid64:{$ne:null},discord_roles_ids:{$exists:!0}}},{$lookup:{from:"lists",let:{pl_roles:"$discord_roles_ids"},pipeline:[{$match:{output_path:e}},{$addFields:{int_r:{$setIntersection:["$discord_roles","$$pl_roles"]}}},{$match:{int_r:{$ne:[]}}}],as:"lists"}},{$lookup:{from:"groups",let:{pl_roles:"$discord_roles_ids"},pipeline:[{$addFields:{int_r:{$setIntersection:["$discord_roles","$$pl_roles"]}}},{$match:{int_r:{$ne:[]}}}],as:"groups"}},{$project:{discord_roles_ids:0,"groups.discord_roles":0,"groups.intersection_roles":0,"groups.int_r":0,"groups.require_appr":0}},{$match:{lists:{$ne:[]}}}];o.collection("players").aggregate(y).toArray(((e,s)=>{if(e)res.sendStatus(500),console.error(e);else for(let e of s)if(t)a+=e.username+"\n";else for(let s of e.groups)p.push({username:e.username,steamid64:e.steamid64,eosID:e.eosID,groupId:s._id,clanTag:"Discord Role",discordUsername:null!=e.discord_username?e.discord_username:""});o.collection("configs").findOne({category:"seeding_tracker"},((e,s)=>{if(s&&s.config.reward_enabled&&"true"==s.config.reward_enabled){const e=s.config,t=e.reward_needed_time.value*e.reward_needed_time.option/1e3/60;o.collection("players").find({steamid64:{$ne:null},seeding_points:{$gte:t}}).toArray(((s,t)=>{s&&ee(res,s);const n=t.map((s=>({username:s.username,steamid64:s.steamid64,eosID:s.eosID,groupId:e.reward_group_id,clanTag:"Seeder",discordUsername:null!=s.discord_username?s.discord_username:""})));p.push(...n),m()}))}else m()}))}))}function d(){for(let e of p){if(!l[e.groupId]){console.log("Could not find group with id",e.groupId,l[e.groupId]),o.collection("whitelists").deleteMany({id_group:e.groupId});continue}let s;e.groupId=`${e.groupId}`,""==e.discordUsername||e.discordUsername.startsWith("@")||(e.discordUsername="@"+e.discordUsername),s=T.other.prefer_eosID?e.eosID||e.steamid64:e.steamid64||e.eosID,a+=`Admin=${s}:${l[e.groupId].group_name} // [${e.clanTag}] ${e.username} ${e.discordUsername}\n`,u.includes(e.groupId)||u.push(e.groupId)}a="\n"+a;for(let e of u){const s=l[e];a=`Group=${s.group_name}:${s.group_permissions.join(",")}\n`+a}}function m(){!T.other.whitelist_developers||t||s||p.push({username:"JetDave",steamid64:"76561198419229279",eosID:"0002a9b6e5ca4343beb7578f8d8ac823",groupId:_,clanTag:"SQUAD Whitelister Developer",discordUsername:"@jetdave"}),d(),n(a)}}else n("")}))}))}))}else n(null)}))}))}));return n}(e,s,t)),!i)return null;if(((Date.now()-l>1e3||T.other.force_lists_output_caching)&&!r||n)&&(U.set(o,i),N.set(o,new Date)),r){i=`//////////////////////////////////////////////\n                // Cached\n                // Last update: ${N.get(o).toLocaleString()}\n                //////////////////////////////////////////////\n                `.replace(/^\s*/gm,"")+"\n"+i}return i}j(T.other.automatic_updates,(async()=>{console.log(" > Starting up"),setInterval((()=>{j(T.other.automatic_updates)}),1e3*T.other.update_check_interval_seconds),await W(),await async function(){apiDocsJson=s.readFileSync(a.join(__dirname,"docs/api/docs.json")).toString()}(),function(){function e(){X((async e=>{const s=await e.collection("configs").findOne({category:"seeding_tracker"});if(!s)return;const t=s.config;"fixed_reset"==t.tracking_mode&&t.reset_seeding_time&&t.next_reset&&new Date>new Date(t.next_reset)&&(e.collection("players").updateMany({},{$set:{seeding_points:0}}),e.collection("configs").updateOne({category:"seeding_tracker"},{$set:{"config.next_reset":new Date((new Date).valueOf()+t.reset_seeding_time.value*t.reset_seeding_time.option).toISOString().split("T")[0]}}))}))}e(),setInterval(e,20)}(),await async function(){console.log("Initializing WL List Caches");const e=await X(),s=await e.collection("lists").find().toArray();for(let e of s){const s=`/${e.output_path}/?false`;await o(e.output_path,"",!1);let t=null!=U.get(s);console.log(` > "${e.title}": ${t?"CACHED":"NOT CACHED"}`)}}(),setInterval(q,1e3*T.other.lists_cache_refresh_seconds),function(e=null){if(console.log("Discord BOT"),T.discord_bot&&""!=T.discord_bot.token){const n=new v.Client({intents:[v.GatewayIntentBits.Guilds,v.GatewayIntentBits.GuildMessages,v.GatewayIntentBits.GuildMembers]});n.login(T.discord_bot.token);const o=setTimeout((()=>{console.error(" > Connection timed out. Check your discord_bot configuration."),console.log(" > Proceding without discord bot."),e()}),1e4),i=[{name:"ping",description:"Replies with Pong!"},{name:"listclans",description:"Gives a full list of clans with corresponding info"},{name:"topseed",description:"Gives a list of seeders"},{name:"profile",description:"Links the Discord profile to the Steam profile",options:[{name:"user",description:"Leave empty to get info of yourself, or fill to get info of a specific user",type:6,required:!1}]}];async function s(e){try{const s=await n.guilds.cache.get(T.discord_bot.server_id).members.cache.find((s=>s.id==e));if(s){const t=s.user,n=s._roles;try{X((s=>{s.collection("players").updateOne({discord_user_id:e},{$set:{discord_user_id:e,discord_username:t.username+"#"+t.discriminator,discord_roles_ids:n}},{upsert:!0})}))}catch(e){console.error("updateUserRoles_1",e)}}else X((s=>{s.collection("players").updateOne({discord_user_id:e},{$set:{discord_roles_ids:[]}})}))}catch(e){console.error("updateUserRoles_2",e)}}async function t(e,s,t=0){e.id;X((async e=>{let n=await e.collection("players").find({seeding_points:{$gte:1}}).skip(10*t).limit(11).sort({seeding_points:-1}).toArray();const o=(await e.collection("configs").findOne({category:"seeding_tracker"})).config,i=o.reward_needed_time.value*(o.reward_needed_time.option/1e3/60),r=n.splice(0,10).map(((e,s)=>[`**${10*t+s+1})**`,`${v.hyperlink(e.username,Z(e.steamid64))}`,e.discord_user_id?v.userMention(e.discord_user_id):null,`*${Math.floor(100*(e.seeding_points||0)/i)}%*`].filter((e=>null!=e)).join(" "))),a={embeds:[{color:v.resolveColor(T.app_personalization.accent_color),title:"Top 10 Seeders",description:r.join("\n")}],components:[(new v.ActionRowBuilder).addComponents((new v.ButtonBuilder).setCustomId("topseed:page:"+(+t-1)).setLabel("⮜").setStyle(v.ButtonStyle.Success).setDisabled(t-1<0),(new v.ButtonBuilder).setCustomId("topseed:page:"+(+t+1)).setLabel("⮞").setStyle(v.ButtonStyle.Success).setDisabled(0==n.length))],ephemeral:!1};s.isButton()?(await s.deferUpdate(),await s.message.edit(a)):await s.reply(a)}))}n.on("ready",(async()=>{clearTimeout(o),F=new Proxy(n,{});const t="268564544";subcomponent_data.discord_bot.invite_link=`https://discord.com/api/oauth2/authorize?client_id=${n.user.id}&permissions=${t}&scope=bot%20applications.commands`,console.log(" > Logged-in!"),console.log(`  > Tag: ${n.user.tag}`),console.log(`  > ID: ${n.user.id}`),console.log(`  > Invite: ${subcomponent_data.discord_bot.invite_link}`),e();new v.REST({version:"10"}).setToken(T.discord_bot.token).put(v.Routes.applicationCommands(n.user.id),{body:i});let r=[];if(n.guilds)for(let e of n.guilds.cache)r.push({id:e[1].id,name:e[1].name});async function a(){const e=await n.guilds.cache.get(T.discord_bot.server_id);await e.members.fetch();X((e=>{e.collection("players").find({discord_user_id:{$exists:!0}}).toArray(((e,t)=>{for(let e of t)s(e.discord_user_id)}))}))}""==T.discord_bot.server_id&&r.length>0&&(T.discord_bot.server_id=r[0].id),""!=T.discord_bot.server_id&&(subcomponent_status.discord_bot=!0,a(),setInterval(a,3e5))})),n.on("raw",(async e=>{const s=e.d?.user?.id||"",t=await X();switch(e.t){case"GUILD_MEMBER_UPDATE":let n=e.d.roles;t.collection("players").updateOne({discord_user_id:s},{$set:{discord_user_id:s,discord_username:e.d.user.username+"#"+e.d.user.discriminator,discord_roles_ids:n}},{upsert:!0});break;case"GUILD_MEMBER_REMOVE":t.collection("players").updateOne({discord_user_id:s},{$set:{discord_roles_ids:[]}})}})),n.on("interactionCreate",(async e=>{const o=e.member?e.member.user:e.user,i=`${o.id}`;if(e.isChatInputCommand()){switch(e.commandName){case"ping":await e.deferReply(),await e.followUp("Pong!");break;case"listclans":await e.deferReply(),X((s=>{s.collection("lists").find().toArray(((t,o)=>{const r=[{$lookup:{from:"whitelists",localField:"_id",foreignField:"id_clan",as:"clan_whitelist"}},{$addFields:{uniqueSteamids:{$setUnion:"$clan_whitelist.steamid64"}}},{$addFields:{unique_players:{$size:"$uniqueSteamids"}}},{$project:{_id:0,admins:0,available_groups:0,clan_whitelist:0,uniqueSteamids:0}}];s.collection("clans").aggregate(r).toArray(((s,t)=>{s&&console.error(s);let r=[],a=!0;for(let s of t){let t=[];for(let e of["tag","clan_code","player_limit","unique_players"])"player_limit"==e&&""==s[e]&&(s[e]="ထ"),t.push({name:se(e.replace(/\_/g," ")),value:s[e].toString(),inline:"full_name"!=e});const l=L.sort(),c=Object.keys(l)[0];if(l[c]){let e=[];for(let t of o){const n="https://"+c+":"+R.configs.https.port+"/"+t.output_path+"/"+s.clan_code;e.push(v.hyperlink(t.title,n))}t.push({name:"Whitelist",value:e.join(" - "),inline:!1})}r.push((new v.EmbedBuilder).setColor(T.app_personalization.accent_color).setTitle(se(s.full_name.replace(/\_/g," "))).addFields(...t)),r.length%10==0&&(a?(a=!1,e.reply({content:v.userMention(i),embeds:r})):Y(n.channels.cache.get(e.channelId),{embeds:r},"interaction channel"),r=[])}r.length>0&&n.channels.cache.get(e.channelId).followUp({embeds:r})}))}))}));break;case"profile":let s=null!=e.options.getUser("user"),r=s?e.options.getUser("user"):o;const a=!s;await e.deferReply({ephemeral:a}),X((t=>{t.collection("players").findOne({discord_user_id:s?r.id:i},(async(s,n)=>{if(s)ee(null,s);else{let s=[{name:"Steam "+(n&&n.steamid64?"Username ":""),value:n&&n.steamid64?n.username:"*Not linked*",inline:!0}];if(n&&n.steamid64){s.push({name:"SteamID",value:v.hyperlink(n.steamid64,"https://steamcommunity.com/profiles/"+n.steamid64),inline:!0});const e=(await t.collection("configs").findOne({category:"seeding_tracker"})).config,o=e.reward_needed_time.value*(e.reward_needed_time.option/1e3/60),i=Math.floor(100*(n.seeding_points||0)/o);"true"==e.reward_enabled&&s.push({name:"Seeding Reward",value:`${i}%`,inline:!1});const r=await Q(n.steamid64);for(let e of r.filter((e=>e.approved))){let t="Unlimited";e.expiration&&(t=`Expired ${v.time(e.expiration,"R")}`),s.push({name:e.name,value:t,inline:!0})}}let o=await e.followUp({content:v.userMention(r.id),embeds:[(new v.EmbedBuilder).setColor(T.app_personalization.accent_color).setAuthor({name:r.username,iconURL:r.avatarURL()}).setTitle("Linked Profiles").addFields(...s)],components:[(new v.ActionRowBuilder).addComponents(n&&n.steamid64?(new v.ButtonBuilder).setCustomId("profilelink:steam:unlink").setLabel("Unlink Steam").setStyle(v.ButtonStyle.Danger):(new v.ButtonBuilder).setCustomId("profilelink:steam:link").setLabel("Link Steam").setStyle(v.ButtonStyle.Success))],ephemeral:a});o.interaction.ephemeral||setTimeout((async()=>{try{const e=await(o?.interaction?.webhook?.fetchMessage());e&&e.edit({components:[]})}catch(e){console.error(e)}}),3e4)}}))}));break;case"topseed":t(o,e)}s(i)}else if(e.isButton()){const s=e.customId.split(":");switch(s[0]){case"approval":const n="approve"==s[1];ne({_id:s[2],approve_update:n}),e.reply({content:"Done",ephemeral:!0}),e.message.edit({components:[]});let r=e.message.embeds[0];r.fields.filter((e=>"Approval"==e.name))[0].value=n?":white_check_mark: Approved":":x: Rejected",r.fields.push({name:(n?"Approved":"Rejected")+" by",value:v.userMention(o.id),inline:!0}),e.message.edit({embeds:[r]});break;case"profilelink":if(e.message.mentions.users.find((e=>e.id==i))||e.message.ephemeral){if("steam"===s[1])switch(s[2]){case"link":let t;do{let s=oe(6);t=!1;const n=3e5,o=new Date(Date.now()+n);X((r=>{r.collection("profilesLinking").deleteOne({discordUserId:i},((a,l)=>{r.collection("profilesLinking").findOne({code:s},((a,l)=>{a?(res.sendStatus(500),console.error(a)):null==l?r.collection("profilesLinking").insertOne({source:"Discord",discordUserId:i,code:s,expiration:o},((t,a)=>{t?(res.sendStatus(500),console.error(t)):(e.reply({content:v.userMention(i),embeds:[(new v.EmbedBuilder).setColor(T.app_personalization.accent_color).setTitle("Link Steam Profile").setDescription("Join our Squad server and send in any chat the following code (case-sensitive)").addFields({name:"Linking Code",value:s,inline:!1},{name:"Expiration",value:v.time(o,"R"),inline:!1})],ephemeral:!0}),setInterval((async()=>{r.collection("profilesLinking").deleteOne({_id:a.insertedId})}),n))})):t=!0}))}))}))}while(t);break;case"unlink":if(s[3]){if("confirm"===s[3])try{X((s=>{s.collection("players").updateOne({discord_user_id:i},{$unset:{discord_user_id:1}},((s,t)=>{s?ee(null,s):1==t.modifiedCount?e.reply({content:v.userMention(i)+"\nYour Steam account has been unlinked",ephemeral:!0}):e.reply({content:v.userMention(i)+"\nYou don't have a Steam account to unlink",ephemeral:!0})}))}))}catch(s){e.reply({content:"An error occurred and this interaction cannot be completed",ephemeral:!0}),console.error(s)}}else await e.reply({content:v.userMention(i),embeds:[(new v.EmbedBuilder).setColor(T.app_personalization.accent_color).setTitle("Unlink Steam").setDescription("Do you really want to unlink your steam profile?")],components:[(new v.ActionRowBuilder).addComponents((new v.ButtonBuilder).setCustomId("profilelink:steam:unlink:confirm").setLabel("Confirm").setStyle(v.ButtonStyle.Danger))],ephemeral:!0})}}else e.reply({content:v.userMention(i),embeds:[(new v.EmbedBuilder).setColor(T.app_personalization.accent_color).setTitle("Unauthorized").setDescription("Only the owner of the profile can use this action")],ephemeral:!0});break;case"topseed":"page"==s[1]&&t(o,e,s[2])}}else e.isModalSubmit()&&e.reply({content:"Modal received",ephemeral:!0})}))}else console.log(" > Not configured. Skipping."),e()}((async()=>{await async function(e=null){console.log("Starting SquadJS WebSockets");for(let s in T.squadjs){subcomponent_status.squadjs[s]=!1;const t=T.squadjs[s];await new Promise((async(n,o)=>{if(console.error(` > Connection ${+s+1}: ${t.websocket.host}:${t.websocket.port}`),t.websocket&&""!=t.websocket.token&&""!=t.websocket.host){subcomponent_data.squadjs[s]||(subcomponent_data.squadjs[s]={socket:null,failedReconnections:0,reconnect_int:null,recentErrors:0,isConnecting:!1,isReconnecting:!1});try{const c=(await D(t.websocket.host)).address,d=()=>{if(subcomponent_data.squadjs[s].isConnecting)return;subcomponent_data.squadjs[s].isConnecting=!0;const e=setTimeout((()=>{console.error(`  > Connection ${+s+1}: Timed out. Check your SquadJS WebSocket configuration.`),subcomponent_data.squadjs[s].isConnecting=!1,subcomponent_status.squadjs[s]||(subcomponent_data.squadjs[s].isReconnecting||i(s),n.called||(n.called=!0,n(!1)))}),5e3);if(subcomponent_data.squadjs[s].socket)try{subcomponent_data.squadjs[s].socket.removeAllListeners(),subcomponent_data.squadjs[s].socket.disconnect()}catch(e){}subcomponent_data.squadjs[s].socket=S(`ws://${c}:${t.websocket.port}`,{auth:{token:t.websocket.token},autoUnref:!0,reconnection:!0,reconnectionAttempts:3,reconnectionDelay:5e3,reconnectionDelayMax:3e4,timeout:1e4}),subcomponent_data.squadjs[s].socket.on("connect",(()=>{clearTimeout(e),console.log(`  > Connection ${+s+1}: Connected successfully`),subcomponent_data.squadjs[s].reconnect_int&&(clearInterval(subcomponent_data.squadjs[s].reconnect_int),subcomponent_data.squadjs[s].reconnect_int=null,subcomponent_data.squadjs[s].isReconnecting=!1),subcomponent_status.squadjs[s]=!0,subcomponent_data.squadjs[s].failedReconnections=0,subcomponent_data.squadjs[s].recentErrors=0,subcomponent_data.squadjs[s].isConnecting=!1,P.initDone||(P.initDone=!0),n.called||(n.called=!0,n(!0))})),subcomponent_data.squadjs[s].socket.on("connect_error",(t=>{clearTimeout(e),subcomponent_data.squadjs[s].isConnecting=!1,subcomponent_data.squadjs[s].recentErrors++,subcomponent_status.squadjs[s]||(subcomponent_data.squadjs[s].isReconnecting||i(s),n.called||(n.called=!0,n(!1)))})),subcomponent_data.squadjs[s].socket.on("disconnect",(e=>{subcomponent_status.squadjs[s]=!1,subcomponent_data.squadjs[s].isConnecting=!1,console.log(`SquadJS WebSocket ${+s+1}\n > Disconnected (${e})\n > Trying to reconnect`),subcomponent_data.squadjs[s].isReconnecting||i(s)})),subcomponent_data.squadjs[s].socket.on("reconnect_failed",(()=>{console.error(`  > Connection ${+s+1}: Built-in reconnection failed after maximum attempts`),subcomponent_data.squadjs[s].isReconnecting||i(s)})),r(s)};function i(e,s=30){subcomponent_data.squadjs[e].isReconnecting||(subcomponent_data.squadjs[e].reconnect_int&&(clearInterval(subcomponent_data.squadjs[e].reconnect_int),subcomponent_data.squadjs[e].reconnect_int=null),subcomponent_data.squadjs[e].isReconnecting=!0,console.log(`  > Setting up reconnection interval for connection ${+e+1} (${s}s)`),subcomponent_data.squadjs[e].reconnect_int=setInterval((()=>{if(subcomponent_status.squadjs[e]||subcomponent_data.squadjs[e].isConnecting)return;subcomponent_data.squadjs[e].failedReconnections++;const t=subcomponent_data.squadjs[e].failedReconnections;if(console.log(`SquadJS websocket ${+e+1}\n  > Reconnection attempt ${t} for connection ${+e+1}`),t%5==0){const t=Math.min(300,2*s);if(t>s)return console.log(`  > Increasing reconnection interval to ${t}s`),clearInterval(subcomponent_data.squadjs[e].reconnect_int),subcomponent_data.squadjs[e].reconnect_int=null,void i(e,t)}d()}),1e3*s))}function r(e){const s=subcomponent_data.squadjs[e].socket;s.on("PLAYER_CONNECTED",(async e=>{try{e&&e.player&&e.player.steamID?(await a(e,s),setTimeout((()=>{l(e)}),1e4)):console.log("A player joined with some undefined data",e)}catch(e){console.error("PLAYER_CONNECTED ERROR",e)}})),s.on("PLAYER_DISCONNECTED",(e=>a(e,s))),s.on("CHAT_MESSAGE",(async e=>{switch(await a(e,s),e.message.toLowerCase().replace(/^(!|\/)/,"")){case"test":break;case"playerinfo":const t=await X();await t.collection("players").findOne({steamid64:e.player.steamID},{projection:{_id:0,seeding_points:1}});break;case"profile":l(e,0);break;default:6!=e.message.length||e.message.includes(" ")||X((async t=>{t.collection("profilesLinking").findOne({code:e.message},(async(n,o)=>{if(n)ee(null,n);else if(o)if(o.expiration>new Date){const n=await F.users.fetch(o.discordUserId),i=n.username+(n.discriminator?"#"+n.discriminator:""),r=await t.collection("players").findOne({steamid64:e.player.steamID},{projection:{_id:0,seeding_points:1}});t.collection("players").updateOne({discord_user_id:o.discordUserId},{$set:{steamid64:e.player.steamID,username:e.player.name,discord_user_id:o.discordUserId,discord_username:i,...r}},{upsert:!0},((r,a)=>{t.collection("players").deleteOne({steamid64:e.player.steamID,discord_user_id:{$exists:!1}},((r,a)=>{if(r)return ee(null,r);t.collection("profilesLinking").deleteOne({_id:o._id}),r?ee(null,r):(s.emit("rcon.warn",e.steamID,"Linked Discord profile: "+i,(e=>{})),Y(n,{embeds:[(new v.EmbedBuilder).setColor(T.app_personalization.accent_color).setTitle("Profile Linked").setDescription("Your Discord profile has been linked to a Steam profile").addFields({name:"Steam Username",value:e.name,inline:!0},{name:"SteamID",value:v.hyperlink(e.steamID,"https://steamcommunity.com/profiles/"+e.steamID),inline:!0})]},"user DM"))}))}))}else t.collection("profilesLinking").deleteOne({_id:o._id})}))}))}}))}async function a(e,s=null){if(!e||!e.player||!e.player.steamID)return void console.error("Unable to update player data due to empty player object:",e);const t=await X(),n={username:e.player.name};e.player.eosID&&(n.eosID=e.player.eosID);const o=await Promise.all([t.collection("players").updateOne({steamid64:e.player.steamID},{$set:n},{upsert:!0}),e.player.eosID?t.collection("whitelists").updateMany({steamid64:e.player.steamID,eosID:{$exists:!1}},{$set:{eosID:e.player.eosID}}):null].filter((e=>null!=e))),i=await t.collection("players").findOne({steamid64:e.player.steamID});if(!i?.discord_user_id)try{const n=(await f.get(`https://api.mysquadstats.com/playerLink?steamID=${e.player.steamID}`)).data.data;if(n?.discordID){const o=n.discordID;try{const n=F?await F.users.fetch(o):null,i=n?n.username+(n.discriminator?"#"+n.discriminator:""):null,r=await t.collection("players").findOne({steamid64:e.player.steamID}),a={...r};delete a._id,await t.collection("players").updateOne({discord_user_id:o},{$set:{steamid64:e.player.steamID,username:e.player.name,...o&&{discord_user_id:o},...i&&{discord_username:i},...a}},{upsert:!0}),await t.collection("players").deleteOne({_id:r._id}),s&&s.emit("rcon.warn",e.player.steamID,`Linked Discord profile ${i||""}`.trim(),(e=>{})),n&&Y(n,{embeds:[(new v.EmbedBuilder).setColor(T.app_personalization.accent_color).setTitle("Profile Linked").setDescription("Your Discord profile has been linked to a Steam profile").addFields({name:"Steam Username",value:e.player.name,inline:!0},{name:"SteamID",value:v.hyperlink(e.player.steamID,"https://steamcommunity.com/profiles/"+e.player.steamID),inline:!0})]},"user DM")}catch(e){console.error("Error linking Discord profile using MSS API data:",e)}}}catch(e){console.error("Error fetching Discord link data from MSS API:",e)}return o}async function l(e,t=5e3){X((async n=>{const o=[{$match:{steamid64:e.player.steamID}},{$lookup:{from:"groups",localField:"id_group",foreignField:"_id",as:"group_full_data"}}];n.collection("whitelists").aggregate(o).toArray((async(o,i)=>{o?ee(null,o):n.collection("players").findOne({steamid64:e.player.steamID},(async(o,i)=>{if(o)ee(null,o);else{const o=(await n.collection("configs").findOne({category:"seeding_tracker"})).config,r=o.reward_needed_time.value*(o.reward_needed_time.option/1e3/60),a=Math.floor(100*(i?.seeding_points||0)/r)||0;let l="Welcome "+e.player.name+"\n\n";if(subcomponent_status.squadjs){let s=(await Q(e.player.steamID)).filter((e=>e.approved));if(s.length>0){l+="Groups:\n";for(let e of s)l+=` - ${e.name}`,e.expiration&&(l+=": "+(((e.expiration-new Date)/1e3/60/60).toFixed(1)+"h left")),l+="\n"}}if(subcomponent_status.discord_bot){let e="";if(i&&i.discord_user_id&&""!=i.discord_user_id)try{const s=await F.users.fetch(i.discord_user_id);e=s.username+(s.discriminator?"#"+s.discriminator:"")}catch(e){console.error(`Error fetching Discord user: ${e.message}`)}"true"==o.reward_enabled&&(l+="\nSeeding Reward: "+a+"%"),l+="\nDiscord Username: "+(""!=e?e:"Not linked")}subcomponent_status.squadjs&&T.app_personalization.send_welcome_message&&setTimeout((()=>{try{subcomponent_data.squadjs[s].socket.emit("rcon.warn",e.player.steamID,l,(e=>{}))}catch(e){console.error(`Error sending welcome message: ${e.message}`)}}),t)}}))}))}))}d()}catch(u){console.error(`Error in SquadJS WebSocket ${+s+1} setup:`,u),subcomponent_data.squadjs[s].isConnecting=!1,n.called||(n.called=!0,n(!1))}}else console.log(` > ${+s+1} Not configured. Skipping.`),e&&e(),n(!1)}))}return!0}(),async function(){console.log("Seeding Tracker: Starting");const e=1;async function s(){const e=await X(),s=await e.collection("configs").findOne({category:"seeding_tracker"}),t=s.config;if(!t)return void console.log("Seeding tracker configuration not set, unable to proceed.");if(!t.reward_needed_time)return void console.log("Reward needed time not configured. Unable to track seeding progress.");const n=t.reward_needed_time.value*(t.reward_needed_time.option/1e3/60),o=[],i=[];for(let e in subcomponent_data.squadjs){if(!subcomponent_status.squadjs[e])continue;let s;i[e]=!1;try{s=await K(subcomponent_data.squadjs[e].socket,"rcon.getListPlayers",{},5)}catch(s){console.error(`Seeding tracker (${+e+1}): ${s}`),++subcomponent_data.squadjs[e].recentErrors>5&&subcomponent_status.squadjs&&subcomponent_data.squadjs[e].socket.disconnect();continue}for(let t of s)t.sqJsConnectionIndex=e,o.push(t);s&&s.length>=(t.seeding_start_player_count||2)&&s.length<=t.seeding_player_threshold&&(i[e]=!0)}firstStart=!1,i.includes(!0)&&X((async e=>{if(o&&o.length>0){if("incremental"==s.config.tracking_mode){let t=0;"point_minute"==s.config.time_deduction.option?t=s.config.time_deduction.value:"perc_minute"==s.config.time_deduction.option&&(t=s.config.time_deduction.value*n/100);const i=new Date(Date.now()-s.config.minimum_reward_duration.value*s.config.minimum_reward_duration.option);await e.collection("players").updateMany({steamid64:{$nin:o.map((e=>e.steamID))},$or:[{latest_seeding_activity:{$lt:i}},{seeding_points:{$lt:n}}]},[{$set:{seeding_points:{$max:[0,{$subtract:["$seeding_points",t]}]}}}])}for(let r of o){if(!i[r.sqJsConnectionIndex])continue;const o=await e.collection("players").findOne({steamid64:r.steamID});e.collection("players").findOneAndUpdate({steamid64:r.steamID},{$set:{steamid64:r.steamID,username:r.name,latest_seeding_activity:new Date},$inc:{seeding_points:1}},{upsert:!0,returnDocument:"after"},(async(i,a)=>{if(i)ee(null,i);else if("true"==t.reward_enabled){const i=Math.min(Math.floor(10*o?.seeding_points/n),10)||0,l=Math.min(Math.floor(10*a.value?.seeding_points/n),10)||0,c=10*l;if(l>0&&l>i)if(c<100){subcomponent_data.squadjs[r.sqJsConnectionIndex].socket.emit("rcon.warn",r.steamID,`Seeding Reward: \n\n${c}% completed`,(e=>{}));const e={embeds:[{color:v.resolveColor(T.app_personalization.accent_color),title:`${r.name}`,url:Z(r.steamID),fields:[{name:"Score",value:c+"%",inline:!0},{name:"SteamID",value:v.hyperlink(r.steamID,Z(r.steamID)),inline:!0},{name:"Discord User",value:a.value.discord_user_id?v.userMention(a.value.discord_user_id):"Not Linked",inline:!1}],footer:{text:new Array(10).fill("◼",0,l).fill("◻",l,10).join("")+` ${c}%`,icon_url:T.app_personalization.favicon||T.app_personalization.logo_url},thumbnail:{url:T.app_personalization.logo_url},timestamp:(new Date).toISOString()}],ephemeral:!1};Y(F.channels.cache.get(t.discord_seeding_score_channel),e,"seeding score channel")}else if(100==c){const n=await e.collection("groups").findOne({_id:d(s.config.reward_group_id)});let o=`Seeding Reward Completed!\n\nYou have received: ${n.group_name}\n`;if("fixed_reset"==s.config.tracking_mode?o+=`Active until: ${new Date(s.config.next_reset).toLocaleDateString()}`:"incremental"==s.config.tracking_mode&&(o+="Don't drop below 100% to keep your reward!"),subcomponent_data.squadjs[r.sqJsConnectionIndex].socket.emit("rcon.warn",r.steamID,o,(e=>{})),subcomponent_status.discord_bot){const e=[(new v.EmbedBuilder).setColor(T.app_personalization.accent_color).setTitle(`${r.name} received the Seeding Reward!`).setURL(Z(r.steamID)).addFields({name:"Username",value:r.name,inline:!0},{name:"SteamID",value:v.hyperlink(r.steamID,"https://steamcommunity.com/profiles/"+r.steamID),inline:!0},{name:"Discord User",value:a.value.discord_user_id?v.userMention(a.value.discord_user_id):"Not Linked",inline:!1},{name:"Reward Group",value:n.group_name,inline:!0}).setThumbnail(T.app_personalization.logo_url).setFooter({text:new Array(10).fill("◼",0,10).join("")+" 100%",iconURL:T.app_personalization.favicon||T.app_personalization.logo_url}).setTimestamp(new Date)];Y(F.channels.cache.get(t.discord_seeding_reward_channel),{embeds:e},"seeding reward channel")}}}}))}}}))}s(),console.log("Seeding Tracker: Started"),setInterval(s,60*e*1e3)}();{const o=__dirname+"/ALTERNATIVE PORTS.txt";s.removeSync(o);const i=["certificates/certificate.crt","certificates/fullchain.pem","certificates/default.crt"];let a=re(["certificates/certificate.key","certificates/privkey.pem","certificates/default.key"]),l=re(i);const c=null,u=null,p=process.env.HTTPS_PORT,_="true"===process.env.HTTP_SERVER_DISABLED||"1"===process.env.HTTP_SERVER_DISABLED||T.web_server.http_server_disabled,m="true"===process.env.HTTPS_SERVER_DISABLED||"1"===process.env.HTTPS_SERVER_DISABLED||T.web_server.https_server_disabled;var e=T.web_server.bind_ip;if(_)console.log("HTTP server disabled");else{const g=c?parseInt(c):u?parseInt(u):T.web_server.http_port,y=await new Promise((e=>ae(g,e)));y?R.http=r.listen(y,T.web_server.bind_ip,(function(){console.log(`HTTP server listening at http://${e}:${y}`),R.configs.http.port=y,t(T.web_server.http_port,y)})):console.error("Couldn't start HTTP server")}if(a&&l&&!m){const h=p?parseInt(p):T.web_server.https_port,w=await new Promise((e=>ae(h,e)));console.log("Using Certificate:",l,a);const b={key:s.readFileSync(a),cert:s.readFileSync(l)};R.https=n.createServer(b,r),w?(r.set("forceSSLOptions",{httpsPort:w}),R.configs.https.port=w,R.https.listen(w),console.log(`HTTPS server listening at https://${e}:${w}`),t(T.web_server.https_port,w)):console.error("Couldn't start HTTPS server")}else console.log("HTTPS server disabled");function t(e,t){if(e!=t){const n="!!! WARNING !!! Port "+e+" is not available! Closest free port found: "+t+"\n";console.log(n),s.writeFileSync(o,n,{flag:"a+"})}}!async function(){}(),setInterval(C,6e4)}}))})),r.use(B),r.use(m()),r.set("etag",!1),r.use("/",p.json()),r.use("/",p.urlencoded({extended:!0})),r.use(_()),r.use((function(e,s,t){if(!T.web_server.force_https)return t();h(e,s,t)})),r.use("/",(async function(e,s,t){const n=e.query.apiKey||e.body.apiKey,o=!!n,i=o?n:e.cookies.stok,r=o?"keys":"sessions";if(!i||""===i||"string"!=typeof i)return t();if(o&&"string"!=typeof n)return t();const a=await X();let l={session_expiration:new Date(Date.now()+12e4),login_date:new Date};const c=await a.collection(r).findOne({token:i},{projection:{_id:0}});if(!c)return t();l={...l,...c},o&&(l.id_user=l.inserted_by,delete l.inserted_by);const d=await a.collection("users").findOne({_id:l.id_user},{projection:{_id:0}});if(!d)return t();o&&delete d.access_level;return l={...l,...d},l.session_expiration<=new Date||(e.userSession=l),t()})),r.use("/",((e,s,t)=>e.userSession?H(e,s,t):G(e,s,t))),r.use((function(e,s,t){const n=e.get("host");L[n]?L[n]++:L[n]=1;t()})),r.use(i.static(__dirname+"/dist")),r.use("/api/changepassword",J),r.post("/api/changepassword",((e,s,t)=>{const n=e.body;X((t=>{const o=u.createHash("sha512").update(n.new_password).digest("hex"),i=u.createHash("sha512").update(n.old_password).digest("hex");t.collection("users").updateOne({_id:e.userSession.id_user,password:i},{$set:{password:o}},((e,t)=>{e?ee(500,e):s.send(t)}))}))})),r.use("/api/login",J),r.post("/api/login",((e,s,t)=>{const n=e.body;X((e=>{let t=u.createHash("sha512").update(n.password).digest("hex");e.collection("users").findOne({$or:[{username_lower:n.username.toLowerCase()},{username:n.username}],password:t},((e,t)=>{if(e)s.sendStatus(500),console.error(e);else if(null==t)s.sendStatus(401);else{const e=60*T.web_server.session_duration_hours*60*1e3;let n,o={login_date:new Date,session_expiration:new Date(Date.now()+e),id_user:t._id};do{n=!1,o.token=oe(128),X((e=>{e.collection("sessions").findOne({token:o.token},((t,i)=>{t?(s.sendStatus(500),console.error(t)):null==i?e.collection("sessions").insertOne(o,((e,t)=>{e?(s.sendStatus(500),console.error(e)):(s.cookie("stok",o.token,{expires:o.session_expiration,httpOnly:!0,secure:T.web_server.force_https,sameSite:"strict"}),s.cookie("uid",o.id_user,{expires:o.session_expiration,secure:T.web_server.force_https,sameSite:"strict"}),s.send({status:"login_ok",userDt:o}))})):n=!0}))}))}while(n)}}))}))})),r.use("/api/signup",z),r.post("/api/signup",((e,s,t)=>{const n=e.body;let o,i={username:n.username,username_lower:n.username.toLowerCase(),password:u.createHash("sha512").update(n.password).digest("hex"),access_level:subcomponent_data.database.root_user_registered?100:0,clan_code:n.clan_code,registration_date:new Date,discord_username:n.discord_username};0!=i.access_level||subcomponent_data.database.root_user_registered||(subcomponent_data.database.root_user_registered=!0);const r=60*T.web_server.session_duration_hours*60*1e3;let a={...i};a.login_date=new Date,a.session_expiration=new Date(Date.now()+r),X((e=>{e.collection("users").findOne({username_lower:n.username.toLowerCase()},((t,n)=>{t?(s.sendStatus(500),console.error(t)):null==n?e.collection("users").insertOne(i,((e,t)=>{e?(s.sendStatus(500),console.error(e)):(console.log("\n\n\n\n\ninserted id=>",t.insertedId,"=>",i,"\n\n\n\n\n\n"),o=!1,a.token=oe(128),s.redirect(307,"/api/login"))})):s.status(401).send({message:"Username already exists",field:"username"})}))}))})),r.use("/",(function(e,s,t){if(!R.logging.requests)return t();const n=Object.keys(e.query).length>0,o=n?e.query:e.body,i=E(e);console.log("\nREQ: "+i+"\nSESSION: ",e.userSession,"\nPARM "+(n?"GET":"POST")+": ",o),t()})),r.get("/api/getVersion",((s,t,n)=>{t.send(e)})),r.get("/api/getAppPersonalization",(function(e,s,t){s.send(T.app_personalization)})),r.get("/api/getTabs",((e,s,t)=>{const n=[subcomponent_data.database.root_user_registered?{}:{name:"Root User Registration",order:0,type:"tab",max_access_level:null},{name:"Clans",order:5,type:"tab",max_access_level:5},{name:"Whitelist",order:10,type:"tab",max_access_level:100},{name:"Groups",order:15,type:"tab",max_access_level:100},{name:"Approvals",order:25,type:"tab",max_access_level:30},{name:"Seeding",order:27,type:"tab",max_access_level:30},{name:"Users and Roles",order:30,type:"tab",max_access_level:5},{name:"API",order:35,type:"tab",max_access_level:5},{name:"Configuration",order:40,type:"tab",max_access_level:5}];let o;o=subcomponent_data.updater.updating?[{name:"Updating",order:0,type:"tab",max_access_level:null}]:n.filter((s=>null==s.max_access_level&&!e.userSession||e.userSession&&s.max_access_level&&e.userSession.access_level<=s.max_access_level)),s.send({tabs:o})})),r.get("/api/getContextMenu",((e,s,t)=>{let n=[{name:"",action:"",url:"",method:"",order:0}];M(e)&&(n=n.concat([])),s.send(n)})),r.get("/:basePath/:clan_code?",(async(e,s,t)=>{const n=await o(e.params.basePath,e.params.clan_code,e.query?.usernamesOnly||!1);if(!n)return t();s.type("text/plain"),s.send(n)})),r.get("/dsTest",((e,s,t)=>{s.type("text/plain");const n=[{$match:{steamid64:{$ne:null},discord_roles_ids:{$exists:!0}}},{$lookup:{from:"groups",let:{pl_roles:"$discord_roles_ids"},pipeline:[{$addFields:{int_r:{$setIntersection:["$discord_roles","$$pl_roles"]}}},{$match:{int_r:{$ne:[]}}}],as:"groups"}},{$project:{discord_roles_ids:0,"groups.discord_roles":0,"groups.intersection_roles":0,"groups.int_r":0,"groups.require_appr":0}}];X((e=>{e.collection("players").aggregate(n).toArray(((e,t)=>{if(e)s.sendStatus(500),console.error(e);else{let e="";for(let s of t)for(let t of s.groups)e+="Admin="+s.steamid64+":"+t.group_name+" // [Discord Role] "+s.username+(null!=s.discord_username?" "+s.discord_username:"")+"\n";s.send(e)}}))}))})),r.get("/api/checkSession",((e,s,t)=>{const n={...e.userSession};delete n.password,delete n.token,e.userSession?s.send({status:"session_valid",userSession:n}):s.send({status:"login_required"}).status(401)})),r.use("/",(function(e,s,t=null){Object.keys(e.query).length>0?e.query:e.body,E(e);e.userSession?t():s.send({status:"login_required"}).status(401)})),r.use("/api/restart",((e,s,t)=>{s.send({status:"restarting"}),restartProcess(0,0,y)})),r.use("/api/logout",((e,s,t)=>{s.clearCookie("stok",{httpOnly:!0,secure:T.web_server.force_https,sameSite:"strict"}),s.clearCookie("uid",{secure:T.web_server.force_https,sameSite:"strict"}),X((t=>{t.collection("sessions").deleteOne({token:e.userSession.token},((e,t)=>{e?ee(s,e):s.send({status:"logout_ok"})}))}))})),r.use("/api/users*",((e,s,t)=>{e.userSession&&e.userSession.access_level<=5&&t()})),r.get("/api/users/read/getAll",((e,s,t)=>{e.query;X((t=>{const n=[{$match:{...e.userSession.access_level>=100?{clan_code:e.userSession.clan_code}:{}}},{$lookup:{from:"clans",localField:"clan_code",foreignField:"clan_code",as:"clan_data"}},{$sort:{username:1}},{$project:{password:0}}];t.collection("users").aggregate(n).toArray(((e,t)=>{e?(s.sendStatus(500),console.error(e)):s.send(t)}))}))})),r.post("/api/users/write/remove",((e,s,t)=>{const n=e.body,o=y.demo?{username:{$ne:"demoadmin"}}:{};X((e=>{e.collection("users").deleteOne({_id:d(n._id),...o,access_level:{$gt:1}},((e,t)=>{e?(s.sendStatus(500),console.error(e)):s.send(t)}))}))})),r.post("/api/users/write/updateAccessLevel",((e,s,t)=>{const n=e.body,o=y.demo?{username:{$ne:"demoadmin"}}:{};console.log("\nFilter\n",o),e.userSession.access_level<=parseInt(n.upd)&&X((e=>{e.collection("users").updateOne({_id:d(n._id),...o,access_level:{$gt:1}},{$set:{access_level:parseInt(n.upd)}},((e,t)=>{e?(s.sendStatus(500),console.error(e)):s.send(t)}))}))})),r.use("/api/roles*",((e,s,t)=>{e.userSession&&e.userSession.access_level<=5&&t()})),r.get("/api/roles/read/getAll",((e,s,t)=>{s.send({0:{name:"Root",access_level:0},5:{name:"Admin",access_level:5},30:{name:"Approver",access_level:30},100:{name:"User",access_level:100}})})),r.use("/api/api_keys*",((e,s,t)=>{e.userSession&&e.userSession.access_level<=5&&t()})),r.get("/api/api_keys/read/getAll",((e,s,t)=>{s.send([])})),r.post("/api/api_keys/write/create",((e,s,t)=>null)),r.get("/api/subcomponent/read/:subComp/status",(async(e,s,t)=>{s.send(subcomponent_status[e.params.subComp])})),r.use("/api/config*",((e,s,t)=>{e.userSession&&e.userSession.access_level<=5&&t()}));const l=["database","web_server.bind_ip","web_server.http_port","web_server.https_port","web_server.http_server_disabled","web_server.https_server_disabled",/web_server\.[^\.]*(http)[^\.]*/],c={"web_server.session_duration_hours":{validate:e=>"number"==typeof e&&e>0&&e<=168,errorMessage:"Invalid session duration hours value. (0 < value <= 168)"},"discord_bot.token":{validate:e=>"string"==typeof e&&e.length>50&&"******"!=e,errorMessage:"Invalid Discord bot token format"},"squadjs.*.websocket.token":{validate:e=>"string"==typeof e&&e.length>4&&"******"!=e,errorMessage:"Invalid SquadJS token format"}};function g(e,s){return s.split(".").reduce(((e,s)=>e?.[s]),e)}function w(e,s){const t=s.split("."),n=t.pop(),o=t.reduce(((e,s)=>e?.[s]),e);o&&delete o[n]}function b(e,s){return s.some((s=>s instanceof RegExp?s.test(e):s===e))}function $(e,s=""){let t=[];for(let n in e){const o=s?`${s}.${n}`:n;e[n]&&"object"==typeof e[n]&&!Array.isArray(e[n])?(t.push(o),t=t.concat($(e[n],o))):Array.isArray(e[n])?(t.push(o),e[n].forEach(((e,s)=>{e&&"object"==typeof e&&(t=t.concat($(e,`${o}.${s}`)))}))):t.push(o)}return t}function k(e,s,t,n=null){for(let[o,i]of Object.entries(t)){if(new RegExp("^"+o.replace(/\*/g,"[^.]+")+"$").test(e)&&!i.validate(s,n,e))return{valid:!1,error:i.errorMessage}}return{valid:!0}}function I(e,s,t){if(Array.isArray(e))return e.map(((e,n)=>e&&"object"==typeof e?I(e,`${s}.${n}`,t):e));if(e&&"object"==typeof e){const n={};for(let o in e){const i=s?`${s}.${o}`:o;t.includes(i)||(e[o]&&"object"==typeof e[o]?n[o]=I(e[o],i,t):n[o]=e[o])}return n}return e}function A(e,s){if(Array.isArray(s)&&Array.isArray(e))return s.map(((s,t)=>{const n=e[t];return s&&"object"==typeof s&&!Array.isArray(s)&&n&&"object"==typeof n&&!Array.isArray(n)?A(n,s):s}));if(Array.isArray(s))return s;if(!s||"object"!=typeof s)return s;if(!e||"object"!=typeof e||Array.isArray(e))return s;const t={...e};for(let e in s)s[e]&&"object"==typeof s[e]&&!Array.isArray(s[e])?t[e]=A(t[e]||{},s[e]):t[e]=s[e];return t}async function q(){const e=U.keys();for(let s of e){const e=s.match(/\/(.+)\/(.*)\?(true|false)/i);await o(e[1],e[2],"true"==e[3],!0)}}function C(e=null){return new Promise(((s,t)=>{X((n=>{n.collection("whitelists").deleteOne({expiration:{$lte:new Date}},((n,o)=>{n&&(console.error("removeExpiredPlayers",n),t(n)),e&&e(),s(o)}))}))}))}function E(e,s){const t=e.originalUrl.replace(/\?.*$/,"");let n=[];for(let e of n)if(t.startsWith(e))return e;return t.endsWith("/")?t.substring(0,t.length-1):t}function x(e,s,t){M(e)?t():s.redirect("/")}function j(n=!1,o=null){let i=new Date;console.log("Current version: ",e,"\n > Checking for updates",i.toLocaleString()),f.get("https://api.github.com/repos/fantinodavide/Squad_Whitelister/releases",{timeout:1e4}).then((i=>{const r=i.data[0],l=r.tag_name.toUpperCase().replace("V","").split("."),c=e.toString().split("."),d=T.other.install_beta_versions&&r.prerelease||!r.prerelease,u=parseInt(c[0])<parseInt(l[0]),p=parseInt(c[0])<=parseInt(l[0])&&parseInt(c[1])<parseInt(l[1]),_=parseInt(c[0])<=parseInt(l[0])&&parseInt(c[1])<=parseInt(l[1])&&parseInt(c[2])<parseInt(l[2]);d&&(u||p||_)?(console.log(" > Update found: "+r.tag_name,r.name),n?function(e){const n=e.assets.filter((e=>"release.zip"==e.name))[0].browser_download_url;console.log(" > Downloading update: "+e.tag_name,e.name,n);const o=a.resolve(__dirname,"tmp_update"),i=a.resolve(o,"gitupd.zip");s.existsSync(o)||s.mkdirSync(o);const r=s.createWriteStream(i);f({method:"get",url:n,responseType:"stream"}).then((e=>{e.data.pipe(r)})),r.on("finish",(e=>{setTimeout((()=>{!function(e,n){const o=new t({file:n,storeEntries:!0,skipEntryNameValidation:!0});o.on("ready",(()=>{s.remove(__dirname+"/dist",(()=>{o.extract("release/",__dirname,(async(t,n)=>{o.close(),await installUpdateDependencies(),console.log(" > Extracted",n,"files"),s.remove(e,(()=>{console.log(`${e} folder deleted`);const s=5e3;console.log(" > Restart in",s/1e3,"seconds"),restartProcess(s,0,y)}))}))}))}))}(o,i)}),1e3)})),r.on("error",(e=>{console.error(e)}))}(r):o&&o()):(console.log(" > No updates found"),o&&o())})).catch((e=>{console.error(" > Couldn't check for updates. Proceding startup",e),o&&o()}))}function M(e){return e.userSession&&e.userSession.access_level<=5}r.get("/api/config/read/getFull",(async(e,s,t)=>{let n=JSON.parse(JSON.stringify(T));const o="******",i=$(n);for(let e of i)b(e,l)&&w(n,e);if(n.discord_bot.token=o,n.squadjs?.forEach(((e,s)=>{n.squadjs[s].websocket.token&&(n.squadjs[s].websocket.token=o)})),process.env.HIDDEN_CONFIG_TABS)for(let e of process.env.HIDDEN_CONFIG_TABS.split(";"))try{delete n[e]}catch(e){}!n.app_personalization?.favicon&&n.app_personalization?.logo_url&&(n.app_personalization.favicon=n.app_personalization.logo_url),s.send(n)})),r.use("/api/config/write",((e,s,t)=>{y.demo&&0!=e.userSession.access_level?s.sendStatus(403):t()})),r.post("/api/config/write/update",(async(e,t,n)=>{const o=e.body;let i={};if(process.env.HIDDEN_CONFIG_TABS?.split(";").includes(o.category))return i.status="config_rejected",i.error="Category is hidden",t.send(i);const r=$(o.config,o.category);console.log(r);const a=[],d=[];for(let e of r){if(b(e,l)){a.push(e);continue}const s={[o.category]:o.config},t=k(e,g(s,e),c,s);t.valid||d.push({path:e,error:t.error})}const u=I(o.config,o.category,[...a,...d.map((e=>e.path))]),p=[],_=[];for(let e of a)p.push(e);for(let e of d)p.push(e.path),_.push(`${e.path}: ${e.error} (field ignored)`);if(!("{}"!==JSON.stringify(u)&&"[]"!==JSON.stringify(u)))return i.status="config_rejected",i.error="All fields were invalid or blocked",i.ignoredFields=p,i.warnings=_,t.send(i);try{"squadjs"===o.category&&Array.isArray(u)&&u.forEach(((e,s)=>{const t=T.squadjs?.[s]?.websocket,n=e?.websocket;if(t&&n){const s=void 0!==n.host&&n.host!==t.host,o=void 0!==n.port&&n.port!==t.port,i=!n.token||"******"===n.token;(s||o)&&i&&(e.websocket.token="")}})),T[o.category]=A(T[o.category]||{},u),s.writeFileSync(O+".bak",s.readFileSync(O)),s.writeFileSync(O,JSON.stringify(T,null,"\t")),i.status="config_updated",i.action="reload",p.length>0&&(i.ignoredFields=p,i.warnings=_.length>0?_:p.map((e=>`${e}: Protected field (ignored)`))),t.send(i),["custom_permissions","app_personalization"].includes(o.category)||restartProcess(0,0,y)}catch(e){i.status="error",i.error=e.message,t.send(i)}})),r.use("/api/dbconfig/read/getFull*",((e,s,t)=>{e.userSession&&e.userSession.access_level<=5&&t()})),r.get("/api/dbconfig/read/getFull",(async(e,s,t)=>{e.body;X((e=>{e.collection("configs").find({config:{$exists:!0,$ne:null},category:{$exists:!0,$ne:null}}).toArray(((e,t)=>{e?ee(s,e):t&&s.send(t)}))}))})),r.use("/api/dbconfig/read/:category",((e,s,t)=>{e.userSession&&e.userSession.access_level<=30&&t()})),r.get("/api/dbconfig/read/:category",(async(e,s,t)=>{e.body;X((t=>{t.collection("configs").findOne({category:e.params.category},((e,t)=>{e?ee(s,e):t&&s.send(t.config)}))}))})),r.use("/api/dbconfig/write*",((e,s,t)=>{y.demo&&0!=e.userSession.access_level?s.sendStatus(403):t()})),r.post("/api/dbconfig/write/update",(async(e,s,t)=>{const n=e.body;X((e=>{e.collection("configs").updateOne({category:n.category},{$set:{config:n.config}},{upsert:!0},((e,t)=>{e?ee(s,e):s.send({status:"config_updated",action:"reload"})}))}))})),r.use("/api/custom_permissions/read*",((e,s,t)=>{e.userSession&&e.userSession.access_level<=30?t():s.sendStatus(403)})),r.get("/api/custom_permissions/read/getAll",((e,s,t)=>{s.send(T.custom_permissions)})),r.use("/api/lists/read*",((e,s,t)=>{e.userSession&&e.userSession.access_level<=100&&t()})),r.get("/api/lists/read/getAll",((e,s,t)=>{X((t=>{let n=e.userSession.access_level<100?{}:{hidden_managers:!1};t.collection("lists").find(n).toArray(((e,t)=>{e?ee(s,e):s.send(t)}))}))})),r.use("/api/lists/write*",((e,s,t)=>{e.userSession&&e.userSession.access_level<=10?t():s.sendStatus(401)})),r.use("/api/lists/write/checkPerm",(async(e,s,t)=>{s.send({status:"permission_granted"})})),r.post("/api/lists/write/addNewList",((e,s,t)=>{const n=e.body;X((e=>{const t={title:n.title,output_path:n.output_path,hidden_managers:n.hidden_managers,require_appr:n.require_appr,discord_roles:n.discord_roles};e.collection("lists").insertOne(t,((e,t)=>{e?ee(s,e):s.send({status:"inserted_new_list",...t})}))}))})),r.post("/api/lists/write/deleteList",((e,s,t)=>{const n=e.body;X((e=>{e.collection("whitelists").deleteMany({id_list:d(n.sel_list_id)},((t,o)=>{t?ee(s,t):e.collection("lists").deleteMany({_id:d(n.sel_list_id)},((e,t)=>{e?ee(s,e):s.send({status:"removed_list",...t})}))}))}))})),r.post("/api/lists/write/editList",((e,s,t)=>{const n=e.body;X((e=>{const t={title:n.title,output_path:n.output_path,hidden_managers:n.hidden_managers,require_appr:n.require_appr,discord_roles:n.discord_roles};e.collection("lists").updateOne({_id:d(n.sel_list_id)},{$set:t},((e,t)=>{e?ee(s,e):s.send({status:"edited_list",...t})}))}))})),r.use("/api/whitelist/read*",((e,s,t)=>{e.userSession&&e.userSession.access_level<=100&&t()})),r.get("/api/whitelist/read/getAllClans",((e,s,t)=>{e.query;X((t=>{const n=[{$match:e.userSession.access_level>=100?{clan_code:e.userSession.clan_code}:{}},{$lookup:{from:"whitelists",localField:"_id",foreignField:"id_clan",as:"clan_whitelist"}},{$addFields:{player_count:{$size:"$clan_whitelist"}}},{$project:{clan_whitelist:0}},{$sort:{full_name:1}}];t.collection("clans").aggregate(n).toArray(((e,t)=>{e?(s.sendStatus(500),console.error(e)):s.send(t)}))}))})),r.get("/api/whitelist/read/getAll",((e,s,t)=>{const n=e.query;X((e=>{let t=n.sel_clan_id?{id_clan:d(n.sel_clan_id)}:{};const o=[{$match:{id_list:d(n.sel_list_id),...t}},{$lookup:{from:"groups",localField:"id_group",foreignField:"_id",as:"group_full_data"}},{$lookup:{from:"users",localField:"inserted_by",foreignField:"_id",as:"inserted_by"}},{$lookup:{from:"players",localField:"steamid64",foreignField:"steamid64",as:"serverData"}},{$sort:{id_clan:1,approved:-1,id_group:1,username:1}}];e.collection("whitelists").aggregate(o).toArray(((e,t)=>{e?(s.sendStatus(500),console.error(e)):s.send(t)}))}))})),r.get("/api/whitelist/read/getPendingApprovalClans",((e,s,t)=>{e.query;X((t=>{const n=[{$match:e.userSession.access_level>=100?{clan_code:e.userSession.clan_code}:{}},{$lookup:{from:"whitelists",let:{id_clan:"$_id"},pipeline:[{$match:{$expr:{$eq:["$id_clan","$$id_clan"]},approved:!1}}],as:"whitelists"}},{$sort:{whitelists_data:-1}},{$match:{whitelists:{$exists:!0,$ne:[]}}}];t.collection("clans").aggregate(n).toArray(((e,t)=>{e?(s.sendStatus(500),console.error(e)):(console.log(t),s.send(t))}))}))})),r.get("/api/whitelist/read/getPendingApproval",((e,s,t)=>{const n=e.query;X((e=>{const t=[{$lookup:{from:"whitelists",let:{id_list:"$_id"},pipeline:[{$match:{$expr:{$eq:["$id_list","$$id_list"]},approved:!1,id_clan:d(n.sel_clan_id)}},{$lookup:{from:"groups",localField:"id_group",foreignField:"_id",as:"group_full_data"}},{$lookup:{from:"users",localField:"inserted_by",foreignField:"_id",as:"inserted_by"}},{$sort:{id_clan:1,approved:-1,id_group:1,username:1}}],as:"wl_data"}},{$match:{wl_data:{$exists:!0,$ne:[]}}}];e.collection("lists").aggregate(t).toArray(((e,t)=>{e?(s.sendStatus(500),console.error(e)):s.send(t)}))}))})),r.use("/api/whitelist/write*",((e,s,t)=>{e.userSession&&e.userSession.access_level<=30?t():X(((n,o)=>{let i=e.userSession.access_level>=100?{clan_code:e.userSession.clan_code,admins:e.userSession.id_user.toString()}:{};n.collection("clans").findOne(i,((n,o)=>{n?ee(s,n):null!=o?(console.log("authorizing",e.userSession.username,"=>",o),t()):(console.log("blocking",o),s.sendStatus(401))}))}))})),r.use("/api/whitelist/write/checkPerm",(async(e,s,t)=>{s.send({status:"permission_granted"})})),r.post("/api/whitelist/write/addPlayer",((e,s,t)=>{const n=e.body;n.discordUsername||(n.discordUsername=""),X((t=>{const o=[{$match:e.userSession.access_level>=100?{clan_code:e.userSession.clan_code,admins:e.userSession.id_user.toString()}:{_id:d(n.sel_clan_id)}},{$lookup:{from:"whitelists",localField:"_id",foreignField:"id_clan",as:"clan_whitelist"}},{$addFields:{player_count:{$size:"$clan_whitelist"}}},{$project:{clan_whitelist:0}}];t.collection("clans").aggregate(o).toArray(((o,i)=>{console.log("====>",i);let r=i[0];if(o)console.log("error",o);else if(null!=r)if(""==r.player_limit||r.player_count<parseInt(r.player_limit)||e.userSession.access_level<=5){let o={id_clan:r._id,username:n.username,username_l:n.username.toLowerCase(),steamid64:n.steamid64,id_group:d(n.group),discord_username:n.discordUsername.startsWith("@")||""==n.discordUsername?""+n.discordUsername:"@"+n.discordUsername,inserted_by:d(e.userSession.id_user||e.userSession.id),insertedViaApiKey:!e.userSession.id_user&&!!e.userSession.id,expiration:!(!n.durationHours||""==n.durationHours)&&new Date(Date.now()+60*parseFloat(n.durationHours)*60*1e3),insert_date:new Date,approved:!1,id_list:d(n.sel_list_id)};t.collection("players").findOne({steamid64:n.steamid64},((n,a)=>{a&&a.eosID&&(o.eosID=a.eosID),t.collection("lists").findOne({_id:o.id_list},((n,a)=>{n?ee(s,n):e.userSession.access_level<100||!a.hidden_managers?t.collection("groups").findOne(o.id_group,((n,l)=>{n?console.log("error",n):null!=l?(o.approved=!(l.require_appr||r.confirmation_ovrd||a.require_appr)||e.userSession.access_level<=30,t.collection("whitelists").insertOne(o,((t,n)=>{if(t)console.log("ERR",t);else if(s.send({status:"inserted_new_player",player:{...o,inserted_by:[{username:e.userSession.username}]},...n}),subcomponent_status.discord_bot){let s,t=[];o.approved?s={}:(s=(new v.ActionRowBuilder).addComponents((new v.ButtonBuilder).setCustomId("approval:approve:"+o._id).setLabel("Approve").setStyle(v.ButtonStyle.Success),(new v.ButtonBuilder).setCustomId("approval:reject:"+o._id).setLabel("Reject").setStyle(v.ButtonStyle.Danger)),t.push(s));const n=[(new v.EmbedBuilder).setColor(T.app_personalization.accent_color).setTitle("Whitelist Update").addFields({name:"Username",value:o.username,inline:!0},{name:"SteamID",value:v.hyperlink(o.steamid64,"https://steamcommunity.com/profiles/"+o.steamid64),inline:!0},{name:"Clan",value:i[0].full_name},{name:"Group",value:l.group_name,inline:!0})];o.expiration&&n[0].addFields({name:"Expiration",value:v.time(o.expiration,"R"),inline:!0}),n[0].addFields({name:"Manager",value:e.userSession.username},{name:"List",value:a.title},{name:"Approval",value:o.approved?":white_check_mark: Approved":":hourglass: Pending",inline:!0}),Y(F.channels.cache.get(T.discord_bot.whitelist_updates_channel_id),{embeds:n,components:t},"whitelist updates channel")}}))):s.send({status:"not_inserted",reason:"could find corresponding id"})})):s.sendStatus(402)}))}))}else s.send({status:"not_inserted",reason:"Player limit reached"});else s.sendStatus(401)}))}))})),r.post("/api/whitelist/write/removePlayer",((e,s,t)=>{const n=e.body;X((e=>{e.collection("whitelists").deleteOne({_id:d(n._id)},((e,t)=>{e?ee(s,e):s.send({status:"removing_ok",...t})}))}))})),r.post("/api/whitelist/write/clearList",((e,s,t)=>{const n=e.body;X((e=>{e.collection("whitelists").deleteMany({id_clan:d(n.sel_clan_id),id_list:d(n.sel_list_id)},((e,t)=>{e?ee(s,e):s.send({status:"clearing_ok",...t})}))}))})),r.use("/api/seeding/read*",((e,s,t)=>{e.userSession&&e.userSession.access_level<=30?t():s.sendStatus(401)})),r.get("/api/seeding/read/getPlayers",((e,s,t)=>{X((e=>{e.collection("players").find({seeding_points:{$gte:1},username:{$ne:null}}).toArray(((e,t)=>{e?ee(s,e):s.send(t)}))}))})),r.use("/api/players/read*",((e,s,t)=>{e.userSession&&e.userSession.access_level<=30?t():s.sendStatus(401)})),r.get("/api/players/read/from/steamId/:id",((e,s,t)=>{X((t=>{t.collection("players").findOne({steamid64:e.params.id},((e,t)=>{e?ee(s,e):s.send(t)}))}))})),r.get("/api/players/read/from/eosId/:id",((e,s,t)=>{X((t=>{t.collection("players").findOne({eosID:e.params.id},((e,t)=>{e?ee(s,e):s.send(t)}))}))})),r.get("/api/players/read/from/discordUserId/:id",((e,s,t)=>{X((t=>{t.collection("players").findOne({discord_user_id:e.params.id},((e,t)=>{e?ee(s,e):s.send(t)}))}))})),r.use("/api/players/write*",((e,s,t)=>{e.userSession&&e.userSession.access_level<=10?t():s.sendStatus(401)})),r.post("/api/players/write/seeding_score",((e,s,t)=>{X((async t=>{if(!Array.isArray(e.body.steamIDs)||"boolean"!=typeof e.body.incremental)return s.status(400).send("Invalid input");const n=e.body.steamIDs,o=e.body.incremental?"$inc":"$set",i=e.body.points,r=await t.collection("players").updateMany({steamid64:{$in:n}},{[o]:{seeding_points:i}}).catch((e=>{s.sendStatus(500)}));s.send(r)}))})),r.use("/api/approval/write*",((e,s,t)=>{e.userSession&&e.userSession.access_level<=30?t():s.sendStatus(401)})),r.use("/api/approval/write/setApprovedStatus",((e,s,t)=>{ne(e.body,s)})),r.use("/api/gameGroups/write*",((e,s,t)=>{e.userSession&&e.userSession.access_level<10?t():s.sendStatus(401)})),r.use("/api/gameGroups/write/checkPerm",(async(e,s,t)=>{s.send({status:"permission_granted"})})),r.post("/api/gameGroups/write/newGroup",((e,s,t)=>{const n=e.body;X((e=>{e.collection("groups").insertOne(n,((e,t)=>{e?ee(s,e):s.send({status:"group_created",data:n,dbRes:{...t}})}))}))})),r.post("/api/gameGroups/write/editGroup",((e,s,t)=>{let n={...e.body};delete n._id,X((t=>{t.collection("groups").updateOne({_id:d(e.body._id)},{$set:n},((n,o)=>{n?ee(s,n):t.collection("groups").findOne({_id:d(e.body._id)},((e,t)=>{s.send({status:"edit_ok",...t})}))}))}))})),r.post("/api/gameGroups/write/remove",((e,s,t)=>{X((t=>{t.collection("groups").deleteOne({_id:d(e.body._id)},((n,o)=>{if(n)return ee(s,n);t.collection("whitelists").deleteMany({id_group:d(e.body._id)},((e,t)=>{if(e)return ee(s,e);s.send({status:"removing_ok",groupResult:o,whitelistResult:t})}))}))}))})),r.get("/api/gameGroups/read/getAllGroups",((e,s,t)=>{X((t=>{let n={};function o(){t.collection("groups").find(n).sort({group_name:1}).toArray(((e,t)=>{e?ee(s,e):s.send(t)}))}e.userSession&&e.userSession.access_level>=100?t.collection("clans").findOne({clan_code:e.userSession.clan_code},((e,t)=>{if(e)ee(s,e);else{let e=[];if(t)for(let s of t.available_groups)e.push(d(s));n={_id:{$in:e}},o()}})):o()}))})),r.use("/api/discord*",((...e)=>{ie(30,...e)})),r.use("/api/discord/write",((...e)=>{ie(10,...e)})),r.get("/api/discord/read/getStatus",((e,s,t)=>{s.send(subcomponent_status.discord_bot)})),r.get("/api/discord/read/getRoles",((e,s,t)=>{e.query;if(subcomponent_status.discord_bot){const e=F.guilds.cache.find((e=>e.id==T.discord_bot.server_id));let t=[];for(let s of e.roles.cache)"@everyone"!==s[1].name.toLowerCase()&&t.push({id:s[1].id,name:s[1].name});s.send(t)}else s.sendStatus(404)})),r.get("/api/discord/read/getServers",((e,s,t)=>{e.query;if(subcomponent_status.discord_bot){let e=[];for(let s of F.guilds.cache)e.push({id:s[1].id,name:s[1].name});s.send(e)}else s.sendStatus(404)})),r.get("/api/discord/read/getChannels",(async(e,s,t)=>{e.query;if(subcomponent_status.discord_bot){s.send((await F.guilds.fetch(T.discord_bot.server_id)).channels.cache.filter((e=>4!=e.type)).sort(((e,s)=>{const t=e.parent,n=s.parent;return!t&&n?-1:t&&!n?1:(t||n)&&t.id!==n.id?t.rawPosition-n.rawPosition:e.rawPosition-s.rawPosition})))}else s.sendStatus(404)})),r.get("/api/discord/read/inviteLink",(async(e,s,t)=>{s.send({url:subcomponent_data.discord_bot.invite_link})})),r.use("/api/clans*",((e,s,t)=>{e.userSession&&e.userSession.access_level<10&&t()})),r.get("/api/clans/getAllClans",((e,s,t)=>{X((e=>{e.collection("clans").find().sort({full_name:1,tag:1}).toArray(((e,t)=>{s.send(t)}))}))})),r.post("/api/clans/removeClan",((e,s,t)=>{X((t=>{t.collection("clans").deleteOne({_id:d(e.body._id)},((e,t)=>{e?ee(s,e):s.send({status:"removing_ok",...t})}))}))})),r.post("/api/clans/editClan",((e,s,t)=>{let n={...e.body};delete n._id,X((t=>{t.collection("clans").updateOne({_id:d(e.body._id)},{$set:n},((n,o)=>{n?ee(s,n):t.collection("clans").findOne({_id:d(e.body._id)},((e,t)=>{s.send({status:"edit_ok",...t})}))}))}))})),r.get("/api/clans/getClanUsers",((e,s,t)=>{const n=e.query;X((e=>{e.collection("users").find({clan_code:n.clan_code}).toArray(((e,t)=>{s.send(t)}))}))})),r.get("/api/clans/getClanAdmins",((e,s,t)=>{const n=e.query;X((e=>{e.collection("clans").findOne({_id:d(n._id)},{projection:{admins:1}},((e,t)=>{if(e)ee(s,e);else{let e=t.admins?t.admins:[];s.send(e)}}))}))})),r.post("/api/clans/editClanAdmins",((e,s,t)=>{const n=e.body;X((t=>{t.collection("clans").updateOne({_id:d(e.body._id)},{$set:{admins:n.clan_admins}},((e,t)=>{s.send({status:"edit_ok",...t})}))}))})),r.post("/api/clans/newClan",((e,s,t)=>{const n=e.body;let o;do{let e=oe(8);o=!1,X((t=>{t.collection("clans").findOne({full_name_lower:n.full_name.toLowerCase()},((i,r)=>{let a={...n,clan_code:e};a.full_name_lower=n.full_name.toLowerCase(),i?(s.sendStatus(500),console.error(i)):null==r?t.collection("clans").findOne({clan_code:e},((e,n)=>{e?(s.sendStatus(500),console.error(e)):null==n?t.collection("clans").insertOne(a,((e,t)=>{e?(s.sendStatus(500),console.error(e)):(s.send({status:"clan_created",clan_data:a}),console.log("New clan created:",a))})):o=!0})):(s.send({status:"clan_already_registered"}).status(409),console.log("Trying to register an already registered clan:",a))}))}))}while(o)})),r.use("/api/keys*",((e,s,t)=>{e.userSession&&e.userSession.access_level<=5&&t()})),r.use("/api/keys/checkPerm",((e,s,t)=>{s.send(!0)})),r.get("/api/keys/:id?",(async(e,s,t)=>{const n=[{$lookup:{from:"users",localField:"inserted_by",foreignField:"_id",as:"inserted_by"}},{$lookup:{from:"players",localField:"steamid64",foreignField:"steamid64",as:"serverData"}},{$sort:{access_level:-1}}],o=await X();if(e.params.id){n.unshift({$match:{_id:d(e.params.id)}});const t=(await o.collection("keys").aggregate(n).toArray())[0];return void s.send(t)}const i=await o.collection("keys").aggregate(n).toArray();s.send(i)})),r.post("/api/keys/",(async(e,s,t)=>{const n=await X(),o={name:e.body.name,token:oe(128),access_level:+e.body.access_level,inserted_by:e.userSession.id_user};if(o.access_level<e.userSession.access_level)return void s.status(403).send({message:"You are not authorized to create an API key with access_level lower than yours."});if(await n.collection("keys").findOne({name:o.name}))return void s.status(401).send({message:"An API key with the same name already exists!",field:"name"});await n.collection("keys").findOne({name:o.name})?s.status(401).send({message:"An API key with the same name token already exists, please try again!"}):n.collection("keys").insertOne(o,(async(e,t)=>{if(e)s.sendStatus(500),console.error(e);else{const e=await n.collection("keys").findOne({_id:d(t.insertedId)});s.send({status:"created",data:e})}}))})),r.delete("/api/keys/:id",(async(e,s,t)=>{const n=await X(),o=await n.collection("keys").deleteOne({_id:d(e.params.id)});s.send(o)})),r.use("/api/keys*",((e,s,t)=>{e.userSession&&e.userSession.access_level<=100&&t()})),r.get("/api/docs",(async(e,s,t)=>{s.send(apiDocsJson)})),r.use("/admin*",x),r.use("/admin",(function(e,s,t){i.static("admin")(e,s,t)})),r.use("/api/admin*",x),r.get("/api/admin",((e,s,t)=>{s.send({status:"Ok"})})),r.get("/api/admin/getConfig",((e,s,t)=>s.status(404).send())),r.get("/api/admin/checkInstallUpdate",((e,s,t)=>{s.send({status:"Ok"}),j(!0)})),r.get("/api/admin/restartApplication",((e,s,t)=>{s.send({status:"Ok"}),restartProcess(e.query.delay?e.query.delay:0,0,y)})),r.get("*",((e,s)=>{s.sendFile(__dirname+"/dist/index.html")})),r.use(((e,s,t)=>{s.redirect(404,"/")}))}async function Y(e,s,t="channel"){try{return e?await e.send(s):(console.error(`[Discord] Cannot send message: ${t} not found`),null)}catch(e){const s={50001:`Missing access to ${t}`,50013:`Missing permissions to send message in ${t}`,50007:"Cannot send message to this user (DMs disabled or bot blocked)",10003:`Unknown ${t}`,10004:"Unknown guild",10008:"Unknown message",50035:"Invalid message format",40005:"Request entity too large"}[e.code]||`Failed to send message (${e.message})`;return console.error(`[Discord] ${s}`),null}}function K(e,s,t,n=2){Date.now();return new Promise(((o,i)=>{e.timeout(1e3*n).emit(s,t,((e,s)=>{if(e){Date.now();return i(e)}o(s)}))}))}async function Q(e){const s=await X(),t=await s.collection("groups").find().toArray(),n=await s.collection("configs").findOne({category:"seeding_tracker"}),o=n.config,i=o.reward_needed_time.value*(o.reward_needed_time.option/1e3/60);let r;try{r=d(n.config.reward_group_id)}catch(e){r=null,console.log("FAILED TO CREATE objIdRewardGroup from value:",n.config.reward_group_id,"\n",o)}let a,l=[];r&&(a=n.config.reward_group_id?await s.collection("groups").findOne({_id:r}):null),l.push(...(await s.collection("whitelists").find({steamid64:e}).toArray()).map((e=>{const n=t.find((s=>s._id.toString()==e.id_group.toString()));if(!n)return void s.collection("whitelists").deleteOne({_id:e._id});let o={};return o.id=e.id_group.toString(),o.name=n.group_name,o.expiration=e.expiration,o.approved=e.approved,o.source="Whitelists",o})).filter((e=>null!=e)));const c=[{$match:{steamid64:e,discord_roles_ids:{$exists:!0}}},{$lookup:{from:"groups",let:{pl_roles:"$discord_roles_ids"},pipeline:[{$addFields:{int_r:{$setIntersection:["$discord_roles","$$pl_roles"]}}},{$match:{int_r:{$ne:[]}}}],as:"groups"}},{$project:{discord_roles_ids:0,"groups.discord_roles":0,"groups.intersection_roles":0,"groups.int_r":0,"groups.require_appr":0}},{$match:{lists:{$ne:[]}}}],u=await s.collection("players").aggregate(c).toArray();for(let e of u){Math.round(100*e.seeding_points/i)>=100&&a&&l.push({id:a._id?.toString(),name:a.group_name,expiration:"fixed_reset"==o.tracking_mode&&new Date(o.next_reset),approved:"true"==o.reward_enabled,source:"Seeding"});for(let s of e.groups)l.push({id:s._id,name:s.group_name,expiration:!1,approved:!0,source:"Discord"})}return l}function Z(e){return"https://steamcommunity.com/profiles/"+e}function X(e=()=>{},s=!1){return new Promise(((t,n)=>{if(s){let s,o;process.env.MONGODB_CONNECTION_STRING?s=process.env.MONGODB_CONNECTION_STRING:(s=T.database.mongo.host.includes("://")?T.database.mongo.host:"mongodb://"+T.database.mongo.host+":"+T.database.mongo.port,o=T.database.mongo.database);c.connect(s,(function(s,i){if(s)n(s);else{var r=o?i.db(o):i.db();e(r),t(r)}}))}else e(M),t(M)}))}function ee(e,s){e&&e.sendStatus(500),console.error(s)}function se(e){return e.charAt(0).toUpperCase()+e.slice(1)}function te(e,s){console.log("upgrading conf");for(let t in s)if(void 0!==e[t])if(Array.isArray(s[t])){Array.isArray(e[t])||(e[t]=[e[t]]);for(let n=0;n<s[t].length;n++)n>=e[t].length?e[t].push(JSON.parse(JSON.stringify(s[t][n]))):te(e[t][n],s[t][n])}else"object"==typeof s[t]?("object"==typeof e[t]&&null!==e[t]||(e[t]={}),te(e[t],s[t])):typeof e[t]!=typeof s[t]&&("number"!=typeof s[t]||isNaN(+e[t])?e[t]=s[t]:e[t]=+e[t]);else e[t]=JSON.parse(JSON.stringify(s[t]))}function ne(e,s=null){X((t=>{!e.approve_update||1!=e.approve_update&&"true"!=e.approve_update?t.collection("whitelists").deleteOne({_id:d(e._id)},((e,t)=>{e?ee(s,e):s&&s.send({status:"rejected",...t})})):t.collection("whitelists").updateOne({_id:d(e._id)},{$set:{approved:!0}},((e,t)=>{e?ee(s,e):s&&s.send({status:"approved",...t})}))}))}function oe(e=64){const s=u.randomBytes(e).toString("base64").slice(0,e);return s.match(/^[a-zA-Z\d]{1,}$/)?s:oe(e)}function ie(e,s,t,n){s.userSession&&s.userSession.access_level<=e?n():t.sendStatus(401)}function re(e,t=0){if(t>=e.length)return null;return s.existsSync(e[t])?e[t]:re(e,++t)}function ae(e,s=()=>{},t=15){console.log("Looking for free port close to "+e);const n=T?.web_server?.bind_ip||"0.0.0.0";try{w(e,n,(async function a(l,c){r.push(c);let d=c,u=o.createServer(),p=!1;await u.listen(d,n).on("error",(s=>{console.error(" > Failed",s.port),p=!0;let n=(443==e?4443:8080)+100*i;if(++i<t)try{w(n,a)}catch(e){}else console.error(" > Couldn't find a free port.\n > Terminating process..."),process.exit(1)})),u.close(),p||(console.log(" > Found free port: "+d),s(d))}))}catch(e){}let i=0,r=[]}!function(e){console.log("Current dir: ",__dirname),console.log(`Configuration file path: ${O}`);let t={web_server:{bind_ip:"0.0.0.0",http_server_disabled:"true"==process.env.HTTP_SERVER_DISABLED&&"1"==process.env.HTTP_SERVER_DISABLED||!1,http_port:80,https_server_disabled:"true"==process.env.HTTPS_SERVER_DISABLED&&"1"==process.env.HTTPS_SERVER_DISABLED||!1,https_port:443,force_https:!1,session_duration_hours:168},database:{mongo:{host:process.env.MONGODB_CONNECTION_STRING||"127.0.0.1",port:27017,database:"Whitelister"}},app_personalization:{name:"Whitelister",favicon:"",accent_color:"#ffc40b",logo_url:"https://joinsquad.com/wp-content/themes/squad/img/logo.png",logo_border_radius:"10",title_hidden_in_header:!1,send_welcome_message:!0},discord_bot:{token:"",server_id:"",whitelist_updates_channel_id:""},squadjs:[{websocket:{host:"",port:3e3,token:""}}],custom_permissions:[{name:"Example Custom Permission",permission:"example_custom_perm"}],other:{automatic_updates:!0,update_check_interval_seconds:3600,whitelist_developers:!0,install_beta_versions:!1,logs_max_file_count:10,lists_cache_refresh_seconds:60,prefer_eosID:!0,prepend_date_time_in_console:!1,force_lists_output_caching:!1}};if(s.existsSync(O)){var n={...JSON.parse(s.readFileSync(O,"utf-8").toString())};te(n,t),s.writeFileSync(O,JSON.stringify(n,null,"\t")),e()}else console.log(`Creating config file at path: ${O}`),ae(t.web_server.http_port,(function(n){console.log(`Found for free HTTP port: ${n}`),t.web_server.http_port=n,console.log(`Set HTTP port: ${t.web_server.http_port}`),ae(t.web_server.https_port,(function(n){t.web_server.https_port=n,console.log('Configuration file created, set your parameters and run again "node server".\nTerminating execution...'),s.writeFileSync(O,JSON.stringify(t,null,"\t")),process.env.PROCESS_MANAGER_TYPE&&"DOCKER"==process.env.PROCESS_MANAGER_TYPE.toUpperCase()?e():process.exit(0)}))}))}((()=>{console.log=(...e)=>{const s=`[${(new Date).toISOString()}]`;T?.other?.prepend_date_time_in_console&&e.unshift(s),q(...e),j.trace(...e)},console.error=(...e)=>{const s=`[${(new Date).toISOString()}]`;T?.other?.prepend_date_time_in_console&&e.unshift(s),C(...e),j.error(...e)},s.readdir(a.join(__dirname,"logs"),{withFileTypes:!0},((e,t)=>{(T&&T.other&&t.length>T.other.logs_max_file_count||t.length>10)&&(t=t.slice(0,t.length-T.other.logs_max_file_count)).forEach((e=>{s.remove(a.join(__dirname,"logs",e.name))}))})),console.log("ARGS:",y),console.log("ENV:",process.env),s.watchFile(O,((e,t)=>{console.log("Reloading configuration");let n,o=!1;try{n=JSON.parse(s.readFileSync(O,"utf-8").toString())}catch(e){console.log("Error found in conf.json file. Couldn't reload configuration."),o=!0}o||(T=n,console.log("Reloaded configuration.",T))})),T=JSON.parse(s.readFileSync(O,"utf-8").toString()),console.log(T),function(e=null){{console.log("MongoDB connection");const s=setTimeout((()=>{console.error(" > Connection failed. Check your Database configuration."),restartProcess(0,1,y)}),1e4);X((t=>{t?console.log(" > Successfully connected"):(console.error(" > Unable to connect"),restartProcess(5,1,null,!0)),M=t,clearTimeout(s),e&&e()}),!0)}}((()=>{!function(e){const s={title:"Main",output_path:"wl",hidden_managers:!1,require_appr:!1,discord_roles:[]},t={category:"seeding_tracker",config:{reset_seeding_time:{value:1,option:864e5},reward_needed_time:{value:1,option:36e5},reward_group_id:"",next_reset:"",seeding_player_threshold:50,seeding_start_player_count:2,reward_enabled:"false",discord_seeding_reward_channel:"",discord_seeding_score_channel:"",tracking_mode:"incremental",time_deduction:{value:1,option:"perc_minute"},minimum_reward_duration:{value:1,option:36e5}}};X((async n=>{function o(e){n.listCollections({name:"lists"}).next(((s,t)=>{null==t?i(e):n.collection("lists").countDocuments({},((s,t)=>{0===t?i(e):e()}))}))}function i(e){n.collection("lists").insertOne(s,((s,t)=>{s?ee(res,s):(console.log("Collection 'lists' created.\n",t),n.collection("whitelists").updateMany({id_list:{$exists:!1}},{$set:{id_list:t.insertedId}},((s,t)=>{s?ee(res,s):(console.log("Updated references"),e())})))}))}async function r(e){let t=!1;const o=Object.keys(s);async function i(r){const a=o[r];await n.collection("lists").updateMany({[a]:{$exists:!1}},{$set:{[a]:s[a]}},(async(s,n)=>{s?console.error(s):(n.modifiedCount>0&&(t||(t=!0,console.log("Repairing Lists format"))),r<o.length-1?await i(r+1):e())}))}await i(0)}async function a(e=()=>{}){let s=!1;const o=Object.keys(t.config);async function i(r){const a=`config.${o[r]}`;await n.collection("configs").updateOne({category:"seeding_tracker",[a]:{$exists:!1}},{$set:{[a]:t.config[o[r]]}},(async(t,n)=>{t?console.error(t):(n.modifiedCount>0&&(s||(s=!0,console.log("Repairing SD Config format"))),r<o.length-1?await i(r+1):e())}))}await i(0)}async function l(){console.log("Syncing database indexes");const e={players:["discord_user_id","steamid64","eosID","seeding_points","discord_roles_ids"],sessions:["token"],clans:["clan_code"],groups:[],lists:["output_path"],whitelists:["id_clan","steamid64","eosID","id_group","id_list"],keys:["token"]};for(let s in e){console.log(` > Syncing collection "${s}"`);for(let t of e[s]){let e=!1;await n.collection(s).createIndex({[t]:1}).catch((s=>{e=!0,console.log(`  > "${t}": Fail. Error: ${s}`)})),e||console.log(`  > "${t}": Success`)}}}subcomponent_data.database.root_user_registered=!!await n.collection("users").findOne({access_level:0}),y.demo&&n.collection("users").updateOne({username:"demoadmin"},{$set:{password:u.createHash("sha512").update("demo").digest("hex"),access_level:5}},{upsert:!0}),await l(),n.collection("players").deleteMany({discord_user_id:{$exists:!0},steamid64:{$exists:!1}}),await n.collection("configs").findOne({category:"seeding_tracker",config:{$exists:!0}})||n.collection("configs").updateOne({category:"seeding_tracker"},{$set:{config:{tracking_mode:"incremental"}}},{upsert:!0}),await a(),o((()=>{r(e)}))}))}(V)}))})),process.on("uncaughtException",(function(e){if(console.error("Uncaught Exception",e.message,e.stack),++I>=(y["self-pm"],5))return console.error("Too many errors occurred during the current run. Terminating execution..."),restartProcess(0,1,y);A&&clearTimeout(A),A=setTimeout((()=>{I=0,clearTimeout(A)}),3e5)}))}function restartProcess(e=0,s=0,t=null,n=!1){function o(e){e&&e()}t&&t["self-pm"]&&1==t["self-pm"]||n?(process.on("exit",(function(){console.log("Process terminated\nStarting new process"),require("child_process").spawn(process.argv.shift(),process.argv,{cwd:process.cwd(),detached:!0,stdio:"inherit"})})),setTimeout((()=>{o((()=>{process.exit(s)}))}),e)):setTimeout((()=>{console.log("Terminating execution. Process manager will restart me."),o((()=>{process.exit(s)}))}),e)}function terminateAndSpawnChildProcess(e=0,s=0){process.on("exit",(function(){console.log("Process terminated\nStarting new process"),require("child_process").spawn(process.argv.shift(),process.argv,{cwd:process.cwd(),detached:!0,stdio:"inherit"})})),setTimeout((()=>{process.exit(e)}),s)}init();