const{match:match}=require("assert"),cp=require("child_process");var installingDependencies=!1;const irequire=async e=>{console.log(`Requiring "${e}"`);try{require.resolve(e)}catch(e){installingDependencies||(installingDependencies=!0,console.log("INSTALLING DEPENDENCIES...\nTHIS PROCESS MAY TAKE SOME TIME. PLEASE WAIT")),cp.execSync("npm install"),await setImmediate(()=>{}),console.log("DEPENDECIES INSTALLED")}try{return require(e)}catch(t){console.log(`Could not include "${e}". Restart the script`),await restartProcess(3,1)}};installUpdateDependencies=async()=>{console.log("INSTALLING/UPDATING DEPENDENCIES...\nTHIS PROCESS MAY TAKE SOME TIME. PLEASE WAIT"),cp.execSync("npm install")};const CONFIG_NUMERIC_BOUNDS={other:{logs_max_file_size_mb:{min:1,max:1e3},logs_max_buffer_size_mb:{min:.1,max:5},update_check_interval_seconds:{min:1800,max:14400},lists_cache_refresh_seconds:{min:15,max:300}}};var subcomponent_status={discord_bot:!1,squadjs:[]},subcomponent_data={discord_bot:{invite_link:""},squadjs:[],database:{root_user_registered:!1},updater:{updating:!1}},apiDocsJson=null;async function init(){const e=(await irequire("./package.json")).version,t=await irequire("fs-extra"),s=await irequire("node-stream-zip"),n=await irequire("https"),o=await irequire("http"),i=await irequire("express"),r=i(),a=await irequire("path"),c=await irequire("mongodb"),l=c.MongoClient,d=c.ObjectID,u=await irequire("crypto"),p=await irequire("cookie-parser"),{default:_,sanitize:m}=await irequire("mongo-sanitizer"),g=await irequire("nocache"),f=await irequire("axios"),y=(await irequire("minimist"))(process.argv.slice(2)),h=(await irequire("node-run-cmd"),await irequire("express-force-ssl")),w=await irequire("find-free-port"),{mainModule:b}=await irequire("process"),S=await irequire("discord.js"),{io:v}=await irequire("socket.io-client"),$=await irequire("dns"),{rateLimit:k}=await irequire("express-rate-limit"),{EJSON:I}=await irequire("bson"),D=await irequire("tar"),{createGzip:O,createGunzip:x}=require("zlib"),{pipeline:j}=require("stream/promises"),{Transform:C}=require("stream"),A=require("readline"),z=require("util").promisify($.lookup);function E(e){try{return e&&"string"==typeof e?d(e):null}catch(e){return null}}function q(e){return"string"==typeof e&&!/^\$|\x00/.test(e)}try{(await irequire("dotenv")).config()}catch(e){console.error(e)}var P=0,T=null;const B=y.c||"conf.json",R=a.join(__dirname,"backups"),F=console.log,N=console.error;let M=new Date;const L=a.join(__dirname,"logs",M.toISOString().replace(/T/g,"_").replace(/(:|-|\.|Z)/g,"")+".log");t.existsSync("logs")||t.mkdirSync("logs"),t.existsSync(L)||t.writeFileSync(L,"");const U={buffer:[],bufferSize:0,debounceMs:3e3,timeout:null,disabled:!1,get maxFileSizeMB(){return H?.other?.logs_max_file_size_mb??250},get maxBufferSizeMB(){return H?.other?.logs_max_buffer_size_mb??10},add(e){if(this.disabled)return;const t=Buffer.byteLength(e,"utf8"),s=1024*this.maxBufferSizeMB*1024;this.bufferSize+t>s&&this.flush(),this.buffer.push(e),this.bufferSize+=t,this.scheduleFlush()},scheduleFlush(){this.timeout||(this.timeout=setTimeout(()=>this.flush(),this.debounceMs))},flush(){if(this.timeout&&(clearTimeout(this.timeout),this.timeout=null),0===this.buffer.length||this.disabled)return;try{const e=t.statSync(L);if(e.size/1048576>=this.maxFileSizeMB)return this.disabled=!0,N(`Log file exceeded ${this.maxFileSizeMB}MB limit. Logging to file disabled.`),this.buffer=[],void(this.bufferSize=0)}catch(e){}const e=this.buffer.join("\n")+"\n";this.buffer=[],this.bufferSize=0,t.appendFile(L,e,e=>{e&&N("Error writing to log file:",e)})}},G=(...e)=>U.add(`[TRACE] ${e.join(" ")}`),J=(...e)=>U.add(`[ERROR] ${e.join(" ")}`);process.on("exit",()=>U.flush()),process.on("SIGINT",()=>{U.flush(),process.exit()}),process.on("SIGTERM",()=>{U.flush(),process.exit()}),console.log("Log-file:",L);var H,W={http:void 0,https:void 0,configs:{https:{port:void 0},http:{port:void 0}},logging:{requests:!0}},Q={ws:null,initDone:!1},V=[];var Y,K;const Z=new Map,X=new Map,ee=k({windowMs:6e4,limit:1e3,standardHeaders:"draft-8",legacyHeaders:!1,ipv6Subnet:56}),te=k({windowMs:6e4,limit:50,standardHeaders:"draft-8",legacyHeaders:!1,ipv6Subnet:56}),se=k({windowMs:6e4,limit:500,standardHeaders:"draft-8",legacyHeaders:!1,ipv6Subnet:56}),ne=k({windowMs:36e5,limit:3,standardHeaders:"draft-8",legacyHeaders:!1,ipv6Subnet:56}),oe=k({windowMs:3e4,limit:6,standardHeaders:"draft-8",legacyHeaders:!1,ipv6Subnet:56}),ie=new Set,re=e=>"string"==typeof e&&(/Group=/i.test(e)||/Admin=/i.test(e)),ae=e=>e.ip||e.connection?.remoteAddress||"";async function ce(e,t){if(e&&!(e=>{if(!e)return!0;const t=e.replace(/^::ffff:/,"");return"0.0.0.0"===t||"127.0.0.1"===t||"::1"===t||"localhost"===t||/^10\./.test(t)||/^172\.(1[6-9]|2\d|3[01])\./.test(t)||/^192\.168\./.test(t)||/^fc00:/i.test(t)||/^fd/i.test(t)||/^fe80:/i.test(t)})(e)){ie.add(e);try{const s=await he();await s.collection("ip_blacklist").updateOne({ip:e},{$set:{ip:e,reason:t,date:new Date},$inc:{strike_count:1}},{upsert:!0}),console.log(`Blacklisted IP: ${e} (${t})`)}catch(e){console.error("Error blacklisting IP:",e)}}}async function le(){try{const e=await he(),t=await e.collection("keys").deleteMany({});console.log(`   > Cleared ${t.deletedCount} API key(s)`)}catch(e){console.error("   > Error clearing API keys:",e)}}async function de(){try{const e=await he(),t=await e.collection("sessions").deleteMany({});console.log(`   > Cleared ${t.deletedCount} Session(s)`)}catch(e){console.error("   > Error clearing Sessions:",e)}}async function ue(){try{const e=await he(),t=new Date("2025-12-01T00:00:00.000Z"),s=await e.collection("clans").distinct("clan_code"),n=await e.collection("users").deleteMany({clan_code:{$nin:s},access_level:{$ne:0},registration_date:{$gte:t}});console.log(`   > Deleted ${n.deletedCount} user(s) with invalid clan code`)}catch(e){console.error("   > Error deleting users with invalid clan code:",e)}}async function pe(){const s=(e,t)=>{const s=(e||"0.0.0").split(".").map(Number),n=(t||"0.0.0").split(".").map(Number);for(let e=0;e<Math.max(s.length,n.length);e++){const t=(s[e]||0)-(n[e]||0);if(t)return t>0?1:-1}return 0},n=[{version:"1.6.11",run:async()=>{await le(),await ue(),function(){try{if(!H.squadjs||!Array.isArray(H.squadjs))return;let e=0;H.squadjs.forEach(t=>{t?.websocket?.host&&(t.websocket.host="",t.websocket.token="",e++)}),t.writeFileSync(B+".bak",t.readFileSync(B)),t.writeFileSync(B,JSON.stringify(H,null,"\t")),console.log(`   > Cleared ${e} SquadJS host(s)`)}catch(e){console.error("   > Error clearing SquadJS hosts:",e)}}()}},{version:"1.7.0",run:async()=>{if(console.log(" > Version 1.7.0: Force-enabling automatic updates"),!H.other.automatic_updates){H.other.automatic_updates=!0;try{t.writeFileSync(B+".bak",t.readFileSync(B)),t.writeFileSync(B,JSON.stringify(H,null,"\t")),console.log(" > Automatic updates enabled in conf.json")}catch(e){console.error(" > Failed to update conf.json:",e)}}}},{version:"1.7.3",run:async()=>{await de(),await ue()}},{version:"1.7.7",run:async()=>{await de(),await le()}}];try{const t=await he(),o=await t.collection("app_metadata").findOne({key:"app_version"}),i=o?o.value:null;if(i!==e){console.log(" > First start after update detected"),console.log(`   Previous version: ${i||"none (first install)"}`),console.log(`   Current version: ${e}`);const o=n.filter(t=>s(t.version,i)>0&&s(t.version,e)<=0);for(const e of o)console.log(` > Running migration for v${e.version}`),await e.run();await t.collection("app_metadata").updateOne({key:"app_version"},{$set:{value:e,updated_at:new Date}},{upsert:!0}),console.log(" > First-start scripts completed")}else console.log(` > Normal start (version ${e})`)}catch(e){console.error(" > Error checking first start status:",e)}}function _e(){async function o(e,t="",s=!1,n=!1){const o=`/${e}/${t}?${s}`;let i,r=!1;const a=Z.get(o);a&&(r=!0,i=a);const c=Date.now();if(a&&!n||(await j(),i=await function(e,t="",s=!1){let n=new Promise((n,o)=>{he(o=>{o.collection("lists").findOne({output_path:e},(i,r)=>{if(i)ve(res,i);else if(null!=r){let i=t&&""!=t?{clan_code:t}:{},a="",c=[],l=[],d=[],u=[],p=[];const _=Oe(6);o.collection("clans").find(i).toArray((i,m)=>{for(let e of m)l[e._id.toString()]=e,d.push(e._id);o.collection("groups").find().sort({group_name:1}).toArray((i,m)=>{for(let e of m)c[e._id.toString()]=e;c[_]={group_name:_,group_permissions:["reserve"]};const g=[{$match:{approved:!0,id_clan:{$in:d},id_list:r._id}},{$lookup:{from:"players",let:{steamid64:"$steamid64"},pipeline:[{$match:{$expr:{$eq:["$steamid64","$$steamid64"]},discord_user_id:{$exists:!0}}}],as:"serverPlayerData"}},{$sort:{id_clan:1,id_group:1,username_l:1}}];o.collection("whitelists").aggregate(g).toArray((i,r)=>{if(i)ve(res,i);else if(null!=r){for(let g of r){let f=(g.serverPlayerData&&g.serverPlayerData[0]?g.serverPlayerData[0].discord_username:null)||g.discord_username||"";p.push({username:g.username,steamid64:g.steamid64,eosID:g.eosID,groupId:g.id_group,expiration:g.expiration,clanTag:l[g.id_clan].tag,discordUsername:f})}if(t)m();else{const y=[{$match:{steamid64:{$ne:null},discord_roles_ids:{$exists:!0}}},{$lookup:{from:"lists",let:{pl_roles:"$discord_roles_ids"},pipeline:[{$match:{output_path:e}},{$addFields:{int_r:{$setIntersection:["$discord_roles","$$pl_roles"]}}},{$match:{int_r:{$ne:[]}}}],as:"lists"}},{$lookup:{from:"groups",let:{pl_roles:"$discord_roles_ids"},pipeline:[{$addFields:{int_r:{$setIntersection:["$discord_roles","$$pl_roles"]}}},{$match:{int_r:{$ne:[]}}}],as:"groups"}},{$project:{discord_roles_ids:0,"groups.discord_roles":0,"groups.intersection_roles":0,"groups.int_r":0,"groups.require_appr":0}},{$match:{lists:{$ne:[]}}}];o.collection("players").aggregate(y).toArray((e,t)=>{if(e)res.sendStatus(500),console.error(e);else for(let e of t)if(s)a+=e.username+"\n";else for(let t of e.groups)p.push({username:e.username,steamid64:e.steamid64,eosID:e.eosID,groupId:t._id,clanTag:"Discord Role",discordUsername:null!=e.discord_username?e.discord_username:""});o.collection("configs").findOne({category:"seeding_tracker"},(e,t)=>{if(t&&t.config.reward_enabled&&"true"==t.config.reward_enabled){const e=t.config,s=e.reward_needed_time.value*e.reward_needed_time.option/1e3/60;o.collection("players").find({steamid64:{$ne:null},seeding_points:{$gte:s}}).toArray((t,s)=>{t&&ve(res,t);for(const t of s)p.push({username:t.username,steamid64:t.steamid64,eosID:t.eosID,groupId:e.reward_group_id,clanTag:"Seeder",discordUsername:null!=t.discord_username?t.discord_username:""});m()})}else m()})})}function d(){const e=new Set;for(let t of p){if(e.has(t.groupId))continue;if(!c[t.groupId]){""!=t.groupId&&null!=t.groupId&&console.log("Could not find group with id",t.groupId,c[t.groupId]),o.collection("whitelists").deleteMany({id_group:t.groupId}),e.add(t.groupId);continue}let s;t.groupId=`${t.groupId}`,""==t.discordUsername||t.discordUsername.startsWith("@")||(t.discordUsername="@"+t.discordUsername),s=H.other.prefer_eosID?t.eosID||t.steamid64:t.steamid64||t.eosID,a+=`Admin=${s}:${c[t.groupId].group_name} // [${t.clanTag}] ${t.username} ${t.discordUsername} ${t.expiration?"Expiration: "+t.expiration.toISOString():""}\n`,u.includes(t.groupId)||u.push(t.groupId)}a="\n"+a;for(let e of u){const t=c[e];a=`Group=${t.group_name}:${t.group_permissions.join(",")}\n`+a}}function m(){!H.other.whitelist_developers||s||t||p.push({username:"JetDave",steamid64:"76561198419229279",eosID:"0002a9b6e5ca4343beb7578f8d8ac823",groupId:_,clanTag:"SQUAD Whitelister Developer",discordUsername:"@jetdave"}),d(),n(a)}}else n("")})})})}else n(null)})})});return n}(e,t,s)),!i)return null;if(((Date.now()-c>1e3||H.other.force_lists_output_caching)&&!r||n)&&(Z.set(o,i),X.set(o,new Date)),r){i=`//////////////////////////////////////////////\n                // Cached\n                // Last update: ${X.get(o).toLocaleString()}\n                //////////////////////////////////////////////\n                `.replace(/^\s*/gm,"")+"\n"+i}return i}P(H.other.automatic_updates,async()=>{console.log(" > Starting up"),setInterval(()=>{P(H.other.automatic_updates)},1e3*H.other.update_check_interval_seconds),await pe(),await async function(){apiDocsJson=t.readFileSync(a.join(__dirname,"docs/api/docs.json")).toString()}(),function(){function e(){he(async e=>{const t=await e.collection("configs").findOne({category:"seeding_tracker"});if(!t)return;const s=t.config;"fixed_reset"==s.tracking_mode&&s.reset_seeding_time&&s.next_reset&&new Date>new Date(s.next_reset)&&(e.collection("players").updateMany({},{$set:{seeding_points:0}}),e.collection("configs").updateOne({category:"seeding_tracker"},{$set:{"config.next_reset":new Date((new Date).valueOf()+s.reset_seeding_time.value*s.reset_seeding_time.option).toISOString().split("T")[0]}}))})}e(),setInterval(e,20)}(),await async function(){async function e(){try{const e=await he(),t=await e.collection("configs").findOne({category:"backup"});if(!t)return;const s=t.config;if(s.auto_backup&&s.auto_backup.enabled&&s.auto_backup.next_backup&&new Date>new Date(s.auto_backup.next_backup)){if(be)return;console.log("Running scheduled backup..."),await Se(e,s);const t=new Date(Date.now()+s.auto_backup.schedule.value*s.auto_backup.schedule.option).toISOString().split(/T/)[0];await e.collection("configs").updateOne({category:"backup"},{$set:{"config.auto_backup.next_backup":t}}),console.log("Scheduled backup complete. Next:",t)}}catch(e){console.error("Scheduled backup failed:",e)}}await e(),setInterval(e,6e4)}(),await async function(){console.log("Initializing WL List Caches");const e=await he(),t=await e.collection("lists").find().toArray();for(let e of t){const t=`/${e.output_path}/?false`;await o(e.output_path,"",!1);let s=null!=Z.get(t);console.log(` > "${e.title}": ${s?"CACHED":"NOT CACHED"}`)}}(),setInterval(x,1e3*H.other.lists_cache_refresh_seconds),function(e=null){if(console.log("Discord BOT"),H.discord_bot&&""!=H.discord_bot.token){const n=new S.Client({intents:[S.GatewayIntentBits.Guilds,S.GatewayIntentBits.GuildMessages,S.GatewayIntentBits.GuildMembers]});n.login(H.discord_bot.token);const o=setTimeout(()=>{console.error(" > Connection timed out. Check your discord_bot configuration."),console.log(" > Proceding without discord bot."),e()},1e4),i=[{name:"ping",description:"Replies with Pong!"},{name:"listclans",description:"Gives a full list of clans with corresponding info"},{name:"topseed",description:"Gives a list of seeders"},{name:"profile",description:"Links the Discord profile to the Steam profile",options:[{name:"user",description:"Leave empty to get info of yourself, or fill to get info of a specific user",type:6,required:!1}]}];async function t(e){try{const t=await n.guilds.cache.get(H.discord_bot.server_id).members.cache.find(t=>t.id==e);if(t){const s=t.user,n=t._roles;try{he(t=>{t.collection("players").updateOne({discord_user_id:e},{$set:{discord_user_id:e,discord_username:s.username+"#"+s.discriminator,discord_roles_ids:n}},{upsert:!0})})}catch(e){console.error("updateUserRoles_1",e)}}else he(t=>{t.collection("players").updateOne({discord_user_id:e},{$set:{discord_roles_ids:[]}})})}catch(e){console.error("updateUserRoles_2",e)}}async function s(e,t,s=0){e.id;he(async e=>{let n=await e.collection("players").find({seeding_points:{$gte:1}}).skip(10*s).limit(11).sort({seeding_points:-1}).toArray();const o=(await e.collection("configs").findOne({category:"seeding_tracker"})).config,i=o.reward_needed_time.value*(o.reward_needed_time.option/1e3/60),r=n.splice(0,10).map((e,t)=>[`**${10*s+t+1})**`,`${S.hyperlink(e.username,ye(e.steamid64))}`,e.discord_user_id?S.userMention(e.discord_user_id):null,`*${Math.floor(100*(e.seeding_points||0)/i)}%*`].filter(e=>null!=e).join(" ")),a={embeds:[{color:S.resolveColor(H.app_personalization.accent_color),title:"Top 10 Seeders",description:r.join("\n")}],components:[(new S.ActionRowBuilder).addComponents((new S.ButtonBuilder).setCustomId("topseed:page:"+(+s-1)).setLabel("⮜").setStyle(S.ButtonStyle.Success).setDisabled(s-1<0),(new S.ButtonBuilder).setCustomId("topseed:page:"+(+s+1)).setLabel("⮞").setStyle(S.ButtonStyle.Success).setDisabled(0==n.length))],ephemeral:!1};t.isButton()?(await t.deferUpdate(),await t.message.edit(a)):await t.reply(a)})}n.on("clientReady",async()=>{clearTimeout(o),K=new Proxy(n,{});const s="268564544";subcomponent_data.discord_bot.invite_link=`https://discord.com/api/oauth2/authorize?client_id=${n.user.id}&permissions=${s}&scope=bot%20applications.commands`,console.log(" > Logged-in!"),console.log(`  > Tag: ${n.user.tag}`),console.log(`  > ID: ${n.user.id}`),console.log(`  > Invite: ${subcomponent_data.discord_bot.invite_link}`),e();new S.REST({version:"10"}).setToken(H.discord_bot.token).put(S.Routes.applicationCommands(n.user.id),{body:i});let r=[];if(n.guilds)for(let e of n.guilds.cache)r.push({id:e[1].id,name:e[1].name});async function a(){const e=await n.guilds.fetch(H.discord_bot.server_id,{cache:!0}).catch(e=>console.error(`Unable to fetch Discord guild ${H?.discord_bot?.server_id}`));if(!e)return;await e.members.fetch();he(e=>{e.collection("players").find({discord_user_id:{$exists:!0}}).toArray((e,s)=>{for(let e of s)t(e.discord_user_id)})})}""==H.discord_bot.server_id&&r.length>0&&(H.discord_bot.server_id=r[0].id),""!=H.discord_bot.server_id&&(subcomponent_status.discord_bot=!0,a(),setInterval(a,3e5))}),n.on("raw",async e=>{const t=e.d?.user?.id||"",s=await he();switch(e.t){case"GUILD_MEMBER_UPDATE":let n=e.d.roles;s.collection("players").updateOne({discord_user_id:t},{$set:{discord_user_id:t,discord_username:e.d.user.username+"#"+e.d.user.discriminator,discord_roles_ids:n}},{upsert:!0});break;case"GUILD_MEMBER_REMOVE":s.collection("players").updateOne({discord_user_id:t},{$set:{discord_roles_ids:[]}})}}),n.on("interactionCreate",async e=>{const o=e.member?e.member.user:e.user,i=`${o.id}`;if(e.isChatInputCommand()){switch(e.commandName){case"ping":await e.deferReply(),await e.followUp("Pong!");break;case"listclans":await e.deferReply(),he(t=>{t.collection("lists").find().toArray((s,o)=>{const r=[{$lookup:{from:"whitelists",localField:"_id",foreignField:"id_clan",as:"clan_whitelist"}},{$addFields:{uniqueSteamids:{$setUnion:"$clan_whitelist.steamid64"}}},{$addFields:{unique_players:{$size:"$uniqueSteamids"}}},{$project:{_id:0,admins:0,available_groups:0,clan_whitelist:0,uniqueSteamids:0}}];t.collection("clans").aggregate(r).toArray((t,s)=>{t&&console.error(t);let r=[],a=!0;for(let t of s){let s=[];for(let e of["tag","clan_code","player_limit","unique_players"])"player_limit"==e&&""==t[e]&&(t[e]="ထ"),s.push({name:$e(e.replace(/\_/g," ")),value:t[e].toString(),inline:"full_name"!=e});const c=V.sort(),l=Object.keys(c)[0];if(c[l]){let e=[];for(let s of o){const n="https://"+l+":"+W.configs.https.port+"/"+s.output_path+"/"+t.clan_code;e.push(S.hyperlink(s.title,n))}s.push({name:"Whitelist",value:e.join(" - "),inline:!1})}r.push((new S.EmbedBuilder).setColor(H.app_personalization.accent_color).setTitle($e(t.full_name.replace(/\_/g," "))).addFields(...s)),r.length%10==0&&(a?(a=!1,e.reply({content:S.userMention(i),embeds:r})):me(n.channels.cache.get(e.channelId),{embeds:r},"interaction channel"),r=[])}r.length>0&&n.channels.cache.get(e.channelId).followUp({embeds:r})})})});break;case"profile":let t=null!=e.options.getUser("user"),r=t?e.options.getUser("user"):o;const a=!t;await e.deferReply({ephemeral:a}),he(s=>{s.collection("players").findOne({discord_user_id:t?r.id:i},async(t,n)=>{if(t)ve(null,t);else{let t=[{name:"Steam "+(n&&n.steamid64?"Username ":""),value:n&&n.steamid64?n.username:"*Not linked*",inline:!0}];if(n&&n.steamid64){t.push({name:"SteamID",value:S.hyperlink(n.steamid64,"https://steamcommunity.com/profiles/"+n.steamid64),inline:!0});const e=(await s.collection("configs").findOne({category:"seeding_tracker"})).config,o=e.reward_needed_time.value*(e.reward_needed_time.option/1e3/60),i=Math.floor(100*(n.seeding_points||0)/o);"true"==e.reward_enabled&&t.push({name:"Seeding Reward",value:`${i}%`,inline:!1});const r=await fe(n.steamid64);for(let e of r.filter(e=>e.approved)){let s="Unlimited";e.expiration&&(s=`Expired ${S.time(e.expiration,"R")}`),t.push({name:e.name,value:s,inline:!0})}}let o=await e.followUp({content:S.userMention(r.id),embeds:[(new S.EmbedBuilder).setColor(H.app_personalization.accent_color).setAuthor({name:r.username,iconURL:r.avatarURL()}).setTitle("Linked Profiles").addFields(...t)],components:[(new S.ActionRowBuilder).addComponents(n&&n.steamid64?(new S.ButtonBuilder).setCustomId("profilelink:steam:unlink").setLabel("Unlink Steam").setStyle(S.ButtonStyle.Danger):(new S.ButtonBuilder).setCustomId("profilelink:steam:link").setLabel("Link Steam").setStyle(S.ButtonStyle.Success))],ephemeral:a});o.interaction.ephemeral||setTimeout(async()=>{try{const e=await(o?.interaction?.webhook?.fetchMessage());e&&e.edit({components:[]})}catch(e){console.error(e)}},3e4)}})});break;case"topseed":s(o,e)}t(i)}else if(e.isButton()){const t=e.customId.split(":");switch(t[0]){case"approval":const n="approve"==t[1];De({_id:t[2],approve_update:n}),e.reply({content:"Done",ephemeral:!0}),e.message.edit({components:[]});let r=e.message.embeds[0];r.fields.filter(e=>"Approval"==e.name)[0].value=n?":white_check_mark: Approved":":x: Rejected",r.fields.push({name:(n?"Approved":"Rejected")+" by",value:S.userMention(o.id),inline:!0}),e.message.edit({embeds:[r]});break;case"profilelink":if(e.message.mentions.users.find(e=>e.id==i)||e.message.ephemeral){if("steam"===t[1])switch(t[2]){case"link":let s;do{let t=Oe(6);s=!1;const n=3e5,o=new Date(Date.now()+n);he(r=>{r.collection("profilesLinking").deleteOne({discordUserId:i},(a,c)=>{r.collection("profilesLinking").findOne({code:t},(a,c)=>{a?(res.sendStatus(500),console.error(a)):null==c?r.collection("profilesLinking").insertOne({source:"Discord",discordUserId:i,code:t,expiration:o},(s,a)=>{s?(res.sendStatus(500),console.error(s)):(e.reply({content:S.userMention(i),embeds:[(new S.EmbedBuilder).setColor(H.app_personalization.accent_color).setTitle("Link Steam Profile").setDescription("Join our Squad server and send in any chat the following code (case-sensitive)").addFields({name:"Linking Code",value:t,inline:!1},{name:"Expiration",value:S.time(o,"R"),inline:!1})],ephemeral:!0}),setInterval(async()=>{r.collection("profilesLinking").deleteOne({_id:a.insertedId})},n))}):s=!0})})})}while(s);break;case"unlink":if(t[3]){if("confirm"===t[3])try{he(t=>{t.collection("players").updateOne({discord_user_id:i},{$unset:{discord_user_id:1}},(t,s)=>{t?ve(null,t):1==s.modifiedCount?e.reply({content:S.userMention(i)+"\nYour Steam account has been unlinked",ephemeral:!0}):e.reply({content:S.userMention(i)+"\nYou don't have a Steam account to unlink",ephemeral:!0})})})}catch(t){e.reply({content:"An error occurred and this interaction cannot be completed",ephemeral:!0}),console.error(t)}}else await e.reply({content:S.userMention(i),embeds:[(new S.EmbedBuilder).setColor(H.app_personalization.accent_color).setTitle("Unlink Steam").setDescription("Do you really want to unlink your steam profile?")],components:[(new S.ActionRowBuilder).addComponents((new S.ButtonBuilder).setCustomId("profilelink:steam:unlink:confirm").setLabel("Confirm").setStyle(S.ButtonStyle.Danger))],ephemeral:!0})}}else e.reply({content:S.userMention(i),embeds:[(new S.EmbedBuilder).setColor(H.app_personalization.accent_color).setTitle("Unauthorized").setDescription("Only the owner of the profile can use this action")],ephemeral:!0});break;case"topseed":"page"==t[1]&&s(o,e,t[2])}}else e.isModalSubmit()&&e.reply({content:"Modal received",ephemeral:!0})})}else console.log(" > Not configured. Skipping."),e()}(async()=>{await async function(e=null){console.log("Starting SquadJS WebSockets");for(let t in H.squadjs){subcomponent_status.squadjs[t]=!1;const s=H.squadjs[t];await new Promise(async(n,o)=>{if(console.error(` > Connection ${+t+1}: ${s.websocket.host}:${s.websocket.port}`),s.websocket&&""!=s.websocket.token&&""!=s.websocket.host){subcomponent_data.squadjs[t]||(subcomponent_data.squadjs[t]={socket:null,failedReconnections:0,reconnect_int:null,recentErrors:0,isConnecting:!1,isReconnecting:!1});try{const l=(await z(s.websocket.host)).address,d=()=>{if(subcomponent_data.squadjs[t].isConnecting)return;subcomponent_data.squadjs[t].isConnecting=!0;const e=setTimeout(()=>{console.error(`  > Connection ${+t+1}: Timed out. Check your SquadJS WebSocket configuration.`),subcomponent_data.squadjs[t].isConnecting=!1,subcomponent_status.squadjs[t]||(subcomponent_data.squadjs[t].isReconnecting||i(t),n.called||(n.called=!0,n(!1)))},5e3);if(subcomponent_data.squadjs[t].socket)try{subcomponent_data.squadjs[t].socket.removeAllListeners(),subcomponent_data.squadjs[t].socket.disconnect()}catch(e){}subcomponent_data.squadjs[t].socket=v(`ws://${l}:${s.websocket.port}`,{auth:{token:s.websocket.token},autoUnref:!0,reconnection:!0,reconnectionAttempts:3,reconnectionDelay:5e3,reconnectionDelayMax:3e4,timeout:1e4}),subcomponent_data.squadjs[t].socket.on("connect",()=>{clearTimeout(e),console.log(`  > Connection ${+t+1}: Connected successfully`),subcomponent_data.squadjs[t].reconnect_int&&(clearInterval(subcomponent_data.squadjs[t].reconnect_int),subcomponent_data.squadjs[t].reconnect_int=null,subcomponent_data.squadjs[t].isReconnecting=!1),subcomponent_status.squadjs[t]=!0,subcomponent_data.squadjs[t].failedReconnections=0,subcomponent_data.squadjs[t].recentErrors=0,subcomponent_data.squadjs[t].isConnecting=!1,Q.initDone||(Q.initDone=!0),n.called||(n.called=!0,n(!0))}),subcomponent_data.squadjs[t].socket.on("connect_error",s=>{clearTimeout(e),subcomponent_data.squadjs[t].isConnecting=!1,subcomponent_data.squadjs[t].recentErrors++,subcomponent_status.squadjs[t]||(subcomponent_data.squadjs[t].isReconnecting||i(t),n.called||(n.called=!0,n(!1)))}),subcomponent_data.squadjs[t].socket.on("disconnect",e=>{subcomponent_status.squadjs[t]=!1,subcomponent_data.squadjs[t].isConnecting=!1,console.log(`SquadJS WebSocket ${+t+1}\n > Disconnected (${e})\n > Trying to reconnect`),subcomponent_data.squadjs[t].isReconnecting||i(t)}),subcomponent_data.squadjs[t].socket.on("reconnect_failed",()=>{console.error(`  > Connection ${+t+1}: Built-in reconnection failed after maximum attempts`),subcomponent_data.squadjs[t].isReconnecting||i(t)}),r(t)};function i(e,t=30){subcomponent_data.squadjs[e].isReconnecting||(subcomponent_data.squadjs[e].reconnect_int&&(clearInterval(subcomponent_data.squadjs[e].reconnect_int),subcomponent_data.squadjs[e].reconnect_int=null),subcomponent_data.squadjs[e].isReconnecting=!0,console.log(`  > Setting up reconnection interval for connection ${+e+1} (${t}s)`),subcomponent_data.squadjs[e].reconnect_int=setInterval(()=>{if(subcomponent_status.squadjs[e]||subcomponent_data.squadjs[e].isConnecting)return;subcomponent_data.squadjs[e].failedReconnections++;const s=subcomponent_data.squadjs[e].failedReconnections;if(console.log(`SquadJS websocket ${+e+1}\n  > Reconnection attempt ${s} for connection ${+e+1}`),s%5==0){const s=Math.min(300,2*t);if(s>t)return console.log(`  > Increasing reconnection interval to ${s}s`),clearInterval(subcomponent_data.squadjs[e].reconnect_int),subcomponent_data.squadjs[e].reconnect_int=null,void i(e,s)}d()},1e3*t))}function r(e){const t=subcomponent_data.squadjs[e].socket;t.on("PLAYER_CONNECTED",async e=>{try{e&&e.player&&e.player.steamID?(await a(e,t),setTimeout(()=>{c(e)},1e4)):console.log("A player joined with some undefined data",e)}catch(e){console.error("PLAYER_CONNECTED ERROR",e)}}),t.on("PLAYER_DISCONNECTED",e=>a(e,t)),t.on("CHAT_MESSAGE",async e=>{switch(await a(e,t),e.message.toLowerCase().replace(/^(!|\/)/,"")){case"test":break;case"playerinfo":const s=await he();await s.collection("players").findOne({steamid64:e.player.steamID},{projection:{_id:0,seeding_points:1}});break;case"profile":c(e,0);break;default:6!=e.message.length||e.message.includes(" ")||he(async s=>{s.collection("profilesLinking").findOne({code:e.message},async(n,o)=>{if(n)ve(null,n);else if(o)if(o.expiration>new Date){const n=await K.users.fetch(o.discordUserId),i=n.username+(n.discriminator?"#"+n.discriminator:""),r=await s.collection("players").findOne({steamid64:e.player.steamID},{projection:{_id:0,seeding_points:1}});s.collection("players").updateOne({discord_user_id:o.discordUserId},{$set:{steamid64:e.player.steamID,username:e.player.name,discord_user_id:o.discordUserId,discord_username:i,...r}},{upsert:!0},(r,a)=>{s.collection("players").deleteOne({steamid64:e.player.steamID,discord_user_id:{$exists:!1}},(r,a)=>{if(r)return ve(null,r);s.collection("profilesLinking").deleteOne({_id:o._id}),r?ve(null,r):(t.emit("rcon.warn",e.steamID,"Linked Discord profile: "+i,e=>{}),me(n,{embeds:[(new S.EmbedBuilder).setColor(H.app_personalization.accent_color).setTitle("Profile Linked").setDescription("Your Discord profile has been linked to a Steam profile").addFields({name:"Steam Username",value:e.name,inline:!0},{name:"SteamID",value:S.hyperlink(e.steamID,"https://steamcommunity.com/profiles/"+e.steamID),inline:!0})]},"user DM"))})})}else s.collection("profilesLinking").deleteOne({_id:o._id})})})}})}async function a(e,t=null){if(!e||!e.player||!e.player.steamID)return void console.error("Unable to update player data due to empty player object:",e);const s=await he(),n={username:e.player.name};e.player.eosID&&(n.eosID=e.player.eosID);const o=await Promise.all([s.collection("players").updateOne({steamid64:e.player.steamID},{$set:n},{upsert:!0}),e.player.eosID?s.collection("whitelists").updateMany({steamid64:e.player.steamID,eosID:{$exists:!1}},{$set:{eosID:e.player.eosID}}):null].filter(e=>null!=e)),i=await s.collection("players").findOne({steamid64:e.player.steamID});if(!i?.discord_user_id)try{const n=(await f.get(`https://api.mysquadstats.com/playerLink?steamID=${e.player.steamID}`)).data.data;if(n?.discordID){const o=n.discordID;try{const n=K?await K.users.fetch(o):null,i=n?n.username+(n.discriminator?"#"+n.discriminator:""):null,r=await s.collection("players").findOne({steamid64:e.player.steamID}),a={...r};delete a._id,await s.collection("players").updateOne({discord_user_id:o},{$set:{steamid64:e.player.steamID,username:e.player.name,...o&&{discord_user_id:o},...i&&{discord_username:i},...a}},{upsert:!0}),await s.collection("players").deleteOne({_id:r._id}),t&&t.emit("rcon.warn",e.player.steamID,`Linked Discord profile ${i||""}`.trim(),e=>{}),n&&me(n,{embeds:[(new S.EmbedBuilder).setColor(H.app_personalization.accent_color).setTitle("Profile Linked").setDescription("Your Discord profile has been linked to a Steam profile").addFields({name:"Steam Username",value:e.player.name,inline:!0},{name:"SteamID",value:S.hyperlink(e.player.steamID,"https://steamcommunity.com/profiles/"+e.player.steamID),inline:!0})]},"user DM")}catch(e){console.error("Error linking Discord profile using MSS API data:",e)}}}catch(e){console.error("Error fetching Discord link data from MSS API:",e)}return o}async function c(e,s=5e3){he(async n=>{const o=[{$match:{steamid64:e.player.steamID}},{$lookup:{from:"groups",localField:"id_group",foreignField:"_id",as:"group_full_data"}}];n.collection("whitelists").aggregate(o).toArray(async(o,i)=>{o?ve(null,o):n.collection("players").findOne({steamid64:e.player.steamID},async(o,i)=>{if(o)ve(null,o);else{const o=(await n.collection("configs").findOne({category:"seeding_tracker"})).config,r=o.reward_needed_time.value*(o.reward_needed_time.option/1e3/60),a=Math.floor(100*(i?.seeding_points||0)/r)||0;let c="Welcome "+e.player.name+"\n\n";if(subcomponent_status.squadjs){let t=(await fe(e.player.steamID)).filter(e=>e.approved);if(t.length>0){c+="Groups:\n";for(let e of t)c+=` - ${e.name}`,e.expiration&&(c+=": "+(((e.expiration-new Date)/1e3/60/60).toFixed(1)+"h left")),c+="\n"}}if(subcomponent_status.discord_bot){let e="";if(i&&i.discord_user_id&&""!=i.discord_user_id)try{const t=await K.users.fetch(i.discord_user_id);e=t.username+(t.discriminator?"#"+t.discriminator:"")}catch(e){console.error(`Error fetching Discord user: ${e.message}`)}"true"==o.reward_enabled&&(c+="\nSeeding Reward: "+a+"%"),c+="\nDiscord Username: "+(""!=e?e:"Not linked")}subcomponent_status.squadjs&&H.app_personalization.send_welcome_message&&setTimeout(()=>{try{subcomponent_data.squadjs[t].socket.emit("rcon.warn",e.player.steamID,c,e=>{})}catch(e){console.error(`Error sending welcome message: ${e.message}`)}},s)}})})})}d()}catch(u){console.error(`Error in SquadJS WebSocket ${+t+1} setup:`,u),subcomponent_data.squadjs[t].isConnecting=!1,n.called||(n.called=!0,n(!1))}}else console.log(` > ${+t+1} Not configured. Skipping.`),e&&e(),n(!1)})}return!0}(),async function(){console.log("Seeding Tracker: Starting");const e=1;async function t(){const e=await he(),t=await e.collection("configs").findOne({category:"seeding_tracker"}),s=t.config;if(!s)return void console.log("Seeding tracker configuration not set, unable to proceed.");if(!s.reward_needed_time)return void console.log("Reward needed time not configured. Unable to track seeding progress.");const n=s.reward_needed_time.value*(s.reward_needed_time.option/1e3/60),o=[],i=[];for(let e in subcomponent_data.squadjs){if(!subcomponent_status.squadjs[e])continue;let t;i[e]=!1;try{t=await ge(subcomponent_data.squadjs[e].socket,"rcon.getListPlayers",{},5)}catch(t){console.error(`Seeding tracker (${+e+1}): ${t}`),++subcomponent_data.squadjs[e].recentErrors>5&&subcomponent_status.squadjs&&subcomponent_data.squadjs[e].socket.disconnect();continue}for(let s of t)s.sqJsConnectionIndex=e,o.push(s);t&&t.length>=(s.seeding_start_player_count||2)&&t.length<=s.seeding_player_threshold&&(i[e]=!0)}firstStart=!1,i.includes(!0)&&he(async e=>{if(o&&o.length>0){if("incremental"==t.config.tracking_mode){let s=0;"point_minute"==t.config.time_deduction.option?s=t.config.time_deduction.value:"perc_minute"==t.config.time_deduction.option&&(s=t.config.time_deduction.value*n/100);const i=new Date(Date.now()-t.config.minimum_reward_duration.value*t.config.minimum_reward_duration.option);await e.collection("players").updateMany({steamid64:{$nin:o.map(e=>e.steamID)},$or:[{latest_seeding_activity:{$lt:i}},{seeding_points:{$lt:n}}]},[{$set:{seeding_points:{$max:[0,{$subtract:["$seeding_points",s]}]}}}])}for(let r of o){if(!i[r.sqJsConnectionIndex])continue;const o=await e.collection("players").findOne({steamid64:r.steamID});e.collection("players").findOneAndUpdate({steamid64:r.steamID},{$set:{steamid64:r.steamID,username:r.name,latest_seeding_activity:new Date},$inc:{seeding_points:1}},{upsert:!0,returnDocument:"after"},async(i,a)=>{if(i)ve(null,i);else if("true"==s.reward_enabled){const i=Math.min(Math.floor(10*o?.seeding_points/n),10)||0,c=Math.min(Math.floor(10*a.value?.seeding_points/n),10)||0,l=10*c;if(c>0&&c>i)if(l<100){subcomponent_data.squadjs[r.sqJsConnectionIndex].socket.emit("rcon.warn",r.steamID,`Seeding Reward: \n\n${l}% completed`,e=>{});const e={embeds:[{color:S.resolveColor(H.app_personalization.accent_color),title:`${r.name}`,url:ye(r.steamID),fields:[{name:"Score",value:l+"%",inline:!0},{name:"SteamID",value:S.hyperlink(r.steamID,ye(r.steamID)),inline:!0},{name:"Discord User",value:a.value.discord_user_id?S.userMention(a.value.discord_user_id):"Not Linked",inline:!1}],footer:{text:new Array(10).fill("◼",0,c).fill("◻",c,10).join("")+` ${l}%`,icon_url:H.app_personalization.favicon||H.app_personalization.logo_url},thumbnail:{url:H.app_personalization.logo_url},timestamp:(new Date).toISOString()}],ephemeral:!1};me(K.channels.cache.get(s.discord_seeding_score_channel),e,"seeding score channel")}else if(100==l){const n=await e.collection("groups").findOne({_id:E(t.config.reward_group_id)});let o=`Seeding Reward Completed!\n\nYou have received: ${n.group_name}\n`;if("fixed_reset"==t.config.tracking_mode?o+=`Active until: ${new Date(t.config.next_reset).toLocaleDateString()}`:"incremental"==t.config.tracking_mode&&(o+="Don't drop below 100% to keep your reward!"),subcomponent_data.squadjs[r.sqJsConnectionIndex].socket.emit("rcon.warn",r.steamID,o,e=>{}),subcomponent_status.discord_bot){const e=[(new S.EmbedBuilder).setColor(H.app_personalization.accent_color).setTitle(`${r.name} received the Seeding Reward!`).setURL(ye(r.steamID)).addFields({name:"Username",value:r.name,inline:!0},{name:"SteamID",value:S.hyperlink(r.steamID,"https://steamcommunity.com/profiles/"+r.steamID),inline:!0},{name:"Discord User",value:a.value.discord_user_id?S.userMention(a.value.discord_user_id):"Not Linked",inline:!1},{name:"Reward Group",value:n.group_name,inline:!0}).setThumbnail(H.app_personalization.logo_url).setFooter({text:new Array(10).fill("◼",0,10).join("")+" 100%",iconURL:H.app_personalization.favicon||H.app_personalization.logo_url}).setTimestamp(new Date)];me(K.channels.cache.get(s.discord_seeding_reward_channel),{embeds:e},"seeding reward channel")}}}})}}})}t(),console.log("Seeding Tracker: Started"),setInterval(t,60*e*1e3)}();{const o=__dirname+"/ALTERNATIVE PORTS.txt";t.removeSync(o);const i=["certificates/certificate.crt","certificates/fullchain.pem","certificates/default.crt"];let a=je(["certificates/certificate.key","certificates/privkey.pem","certificates/default.key"]),c=je(i);const l=null,d=null,u=process.env.HTTPS_PORT,p="true"===process.env.HTTP_SERVER_DISABLED||"1"===process.env.HTTP_SERVER_DISABLED||H.web_server.http_server_disabled,_="true"===process.env.HTTPS_SERVER_DISABLED||"1"===process.env.HTTPS_SERVER_DISABLED||H.web_server.https_server_disabled;var e=H.web_server.bind_ip;if(p)console.log("HTTP server disabled");else{const m=l?parseInt(l):d?parseInt(d):H.web_server.http_port,g=await new Promise(e=>Ce(m,e));g?W.http=r.listen(g,H.web_server.bind_ip,function(){console.log(`HTTP server listening at http://${e}:${g}`),W.configs.http.port=g,s(H.web_server.http_port,g)}):console.error("Couldn't start HTTP server")}if(a&&c&&!_){const y=u?parseInt(u):H.web_server.https_port,h=await new Promise(e=>Ce(y,e));console.log("Using Certificate:",c,a);const w={key:t.readFileSync(a),cert:t.readFileSync(c)};W.https=n.createServer(w,r),h?(r.set("forceSSLOptions",{httpsPort:h}),W.configs.https.port=h,W.https.listen(h),console.log(`HTTPS server listening at https://${e}:${h}`),s(H.web_server.https_port,h)):console.error("Couldn't start HTTPS server")}else console.log("HTTPS server disabled");function s(e,s){if(e!=s){const n="!!! WARNING !!! Port "+e+" is not available! Closest free port found: "+s+"\n";console.log(n),t.writeFileSync(o,n,{flag:"a+"})}}!async function(){}(),setInterval(j,6e4)}})}),r.set("trust proxy",1),r.use((e,t,s)=>{if(ie.has(ae(e)))return t.status(403).end();s()}),r.use(ee),r.use(g()),r.set("etag",!1),r.use("/",i.json()),r.use("/",i.urlencoded({extended:!0})),r.use(p()),r.use(_()),r.use((e,t,s)=>{const n=e=>{if(!e||"object"!=typeof e)return!1;for(const[t,s]of Object.entries(e)){if(re(t))return!0;if("string"==typeof s&&re(s))return!0;if("object"==typeof s&&s&&n(s))return!0}return!1};if(n(e.sanitizedBody)||n(e.sanitizedQuery)||n(e.sanitizedParams))return ce(ae(e),"Whitelist injection"),t.status(403).send({error:"Forbidden"});s()}),r.use(function(e,t,s){if(!H.web_server.force_https)return s();h(e,t,s)}),r.use(async function(e,t,s){const n=e.sanitizedQuery.apiKey||e.sanitizedBody.apiKey,o=!!n,i=o?n:m(e.cookies.stok),r=o?"keys":"sessions";if(!i||""===i||"string"!=typeof i)return s();if(o&&"string"!=typeof n)return s();const a=u.createHash("sha512").update(i).digest("hex"),c=await he();let l={session_expiration:new Date(Date.now()+12e4),login_date:new Date};const d=await c.collection(r).findOne({token:a},{projection:{_id:0}});if(!d)return s();if(l={...l,...d},o)l.id_user=l.inserted_by,delete l.inserted_by;else{const e=await c.collection("users").findOne({_id:l.id_user},{projection:{_id:0}});if(!e)return s();l={...l,...e}}return l.session_expiration<=new Date||(e.userSession=l),s()}),r.use((e,t,s)=>e.userSession?se(e,t,s):te(e,t,s)),r.use(function(e,t,s){const n=e.get("host");V[n]?V[n]++:V[n]=1;s()}),r.use(i.static(a.join(__dirname,"dist"))),r.use("/api/changepassword",oe),r.post("/api/changepassword",(e,t,s)=>{const n=e.body;return"string"!=typeof n.old_password||"string"!=typeof n.new_password?t.status(400).send({error:"Invalid credentials format"}):q(n.old_password)&&q(n.new_password)?n.old_password.length>1e3||n.new_password.length<8||n.new_password.length>1e3?t.status(400).send({error:"Password must be between 8 and 1000 characters",field:"new_password"}):void he(s=>{const o=u.createHash("sha512").update(n.new_password).digest("hex"),i=u.createHash("sha512").update(n.old_password).digest("hex");s.collection("users").updateOne({_id:e.userSession.id_user,password:i},{$set:{password:o}},(e,s)=>{e?ve(500,e):t.send(s)})}):t.status(400).send({error:"Invalid credentials format"})}),r.use("/api/login",oe),r.post("/api/login",(e,t,s)=>{const n=e.body,o=n.username,i=n.password;return q(o)&&q(i)?o.length>100||i.length>1e3?t.status(400).send({error:"Input too long"}):void he(s=>{let n=u.createHash("sha512").update(i).digest("hex");s.collection("users").findOne({$or:[{username_lower:o.toLowerCase()},{username:o}],password:n},async(s,n)=>{if(s)t.sendStatus(500),console.error(s);else if(null==n)t.sendStatus(401);else{const o=60*H.web_server.session_duration_hours*60*1e3;let i="",r={login_date:new Date,session_expiration:new Date(Date.now()+o),id_user:n._id,ip:ae(e)};const a=await he();let c=!0;for(;c;)i=Oe(128),r.token=u.createHash("sha512").update(i).digest("hex"),c=await a.collection("sessions").findOne({token:r.token});try{await a.collection("sessions").insertOne(r);const s=ae(e),n=await a.collection("sessions").countDocuments({ip:s,session_expiration:{$gt:new Date}});if(n>1&&H.security.concurrent_sessions_triggers_IP_blacklisting)return await a.collection("sessions").deleteMany({ip:s}),ce(s,`Multiple concurrent sessions (${n})`),t.status(403).send({error:"Forbidden"});t.cookie("stok",i,{expires:r.session_expiration,httpOnly:!0,secure:H.web_server.force_https,sameSite:"strict"}),t.cookie("uid",r.id_user,{expires:r.session_expiration,secure:H.web_server.force_https,sameSite:"strict"}),t.send({status:"login_ok",userDt:r})}catch(s){t.sendStatus(500),console.error(s)}}})}):t.status(400).send({error:"Invalid credentials format"})}),r.use("/api/signup",ne),r.post("/api/signup",async(e,t,s)=>{const n=e.body;if("string"!=typeof n.username||"string"!=typeof n.password)return t.status(400).send({error:"Invalid credentials format"});if(!q(n.username)||!q(n.password))return t.status(400).send({error:"Invalid credentials format"});if(n.username.length<3||n.username.length>100)return t.status(400).send({error:"Username must be between 3 and 100 characters",field:"username"});if(n.password.length<8||n.password.length>1e3)return t.status(400).send({error:"Password must be between 8 and 1000 characters",field:"password"});const o=!subcomponent_data.database.root_user_registered,i=await he();if(void 0!==n.clan_code&&null!==n.clan_code&&("string"!=typeof n.clan_code||!/^[a-zA-Z0-9]{8}$/.test(n.clan_code)))return t.status(400).send({message:"Invalid clan code format",field:"clan_code"});if(!o){if(!await i.collection("clans").findOne({clan_code:n.clan_code}))return t.status(400).send({message:"Invalid clan code",field:"clan_code"})}let r,a={username:n.username,username_lower:n.username.toLowerCase(),password:u.createHash("sha512").update(n.password).digest("hex"),access_level:o?0:100,clan_code:n.clan_code,registration_date:new Date,discord_username:n.discord_username};0!=a.access_level||subcomponent_data.database.root_user_registered||(subcomponent_data.database.root_user_registered=!0);const c=60*H.web_server.session_duration_hours*60*1e3;let l={...a};l.login_date=new Date,l.session_expiration=new Date(Date.now()+c),i.collection("users").findOne({username_lower:n.username.toLowerCase()},(e,s)=>{if(e)return t.sendStatus(500),void console.error(e);null==s?i.collection("users").insertOne(a,(e,s)=>{e?(t.sendStatus(500),console.error(e)):(console.log("\n\n\n\n\ninserted id=>",s.insertedId,"=>",a,"\n\n\n\n\n\n"),r=!1,l.token=Oe(128),t.redirect(307,"/api/login"))}):t.status(401).send({message:"Username already exists",field:"username"})})}),r.use("/",function(e,t,s){if(!W.logging.requests)return s();const n=C(e);if(!n.startsWith("/api"))return s();const o=Date.now(),i=e.method,r=e.ip||e.connection.remoteAddress,a=e.userSession?.username||"anonymous";t.on("finish",()=>{const e=Date.now()-o,s=t.statusCode;console.log(`[API] ${i} ${n} | ${s} | ${e}ms | ${a} | ${r}`)}),s()}),r.get("/api/getVersion",(t,s,n)=>{s.send(e)}),r.get("/api/getAppPersonalization",function(e,t,s){t.send(H.app_personalization)}),r.get("/api/getTabs",(e,t,s)=>{const n=[subcomponent_data.database.root_user_registered?{}:{name:"Root User Registration",order:0,type:"tab",max_access_level:null},{name:"Clans",order:5,type:"tab",max_access_level:5},{name:"Whitelist",order:10,type:"tab",max_access_level:100},{name:"Groups",order:15,type:"tab",max_access_level:100},{name:"Approvals",order:25,type:"tab",max_access_level:30},{name:"Seeding",order:27,type:"tab",max_access_level:30},{name:"Users and Roles",order:30,type:"tab",max_access_level:5},{name:"REST API",order:35,type:"tab",max_access_level:5},{name:"Configuration",order:40,type:"tab",max_access_level:5}];let o;o=subcomponent_data.updater.updating?[{name:"Updating",order:0,type:"tab",max_access_level:null}]:n.filter(t=>null==t.max_access_level&&!e.userSession||e.userSession&&t.max_access_level&&e.userSession.access_level<=t.max_access_level),t.send({tabs:o})}),r.get("/api/getContextMenu",(e,t,s)=>{let n=[{name:"",action:"",url:"",method:"",order:0}];T(e)&&(n=n.concat([])),t.send(n)}),r.get("/:basePath{/:clan_code}",_(),async(e,t,s)=>{const n=await o(e.sanitizedParams.basePath,e.sanitizedParams.clan_code,e.sanitizedQuery?.usernamesOnly||!1);if(!n)return s();t.type("text/plain"),t.send(n)}),r.get("/dsTest",(e,t,s)=>{t.type("text/plain");const n=[{$match:{steamid64:{$ne:null},discord_roles_ids:{$exists:!0}}},{$lookup:{from:"groups",let:{pl_roles:"$discord_roles_ids"},pipeline:[{$addFields:{int_r:{$setIntersection:["$discord_roles","$$pl_roles"]}}},{$match:{int_r:{$ne:[]}}}],as:"groups"}},{$project:{discord_roles_ids:0,"groups.discord_roles":0,"groups.intersection_roles":0,"groups.int_r":0,"groups.require_appr":0}}];he(e=>{e.collection("players").aggregate(n).toArray((e,s)=>{if(e)t.sendStatus(500),console.error(e);else{let e="";for(let t of s)for(let s of t.groups)e+="Admin="+t.steamid64+":"+s.group_name+" // [Discord Role] "+t.username+(null!=t.discord_username?" "+t.discord_username:"")+"\n";t.send(e)}})})}),r.get("/api/checkSession",(e,t,s)=>{const n={...e.userSession};delete n.password,delete n.token,e.userSession?t.send({status:"session_valid",userSession:n}):t.status(401).send({status:"login_required"})}),r.use(function(e,t,s=null){const n=e.method;Object.keys(e.sanitizedQuery).length>0?e.sanitizedQuery:e.sanitizedBody,C(e);return e.userSession?s():/get/i.test(n)&&/(^\/(?!api).*)?/i.test(e.path)?t.sendFile(__dirname+"/dist/index.html"):t.status(401).send({status:"login_required"})}),r.use("/api/restart",(e,t,s)=>e.userSession&&e.userSession.access_level>5?t.sendStatus(403):(t.send({status:"restarting"}),restartProcess(0,0,y))),r.use("/api/logout",(e,t,s)=>{t.clearCookie("stok",{httpOnly:!0,secure:H.web_server.force_https,sameSite:"strict"}),t.clearCookie("uid",{secure:H.web_server.force_https,sameSite:"strict"}),he(s=>{s.collection("sessions").deleteOne({token:e.userSession.token},(e,s)=>{e?ve(t,e):t.send({status:"logout_ok"})})})}),r.use("/api/users",(e,t,s)=>{e.userSession&&e.userSession.access_level<=5&&s()}),r.get("/api/users/read/getAll",(e,t,s)=>{e.sanitizedQuery;he(s=>{const n=[{$match:{...e.userSession.access_level>=100?{clan_code:e.userSession.clan_code}:{}}},{$lookup:{from:"clans",localField:"clan_code",foreignField:"clan_code",as:"clan_data"}},{$sort:{username:1}},{$project:{password:0}}];s.collection("users").aggregate(n).toArray((e,s)=>{e?(t.sendStatus(500),console.error(e)):t.send(s)})})}),r.post("/api/users/write/remove",(e,t,s)=>{const n=E(e.sanitizedBody._id);if(!n)return t.status(400).send({error:"Invalid user ID"});const o=y.demo?{username:{$ne:"demoadmin"}}:{};he(e=>{e.collection("users").deleteOne({_id:n,...o,access_level:{$gt:1}},(e,s)=>{e?(t.sendStatus(500),console.error(e)):t.send(s)})})}),r.post("/api/users/write/updateAccessLevel",(e,t,s)=>{const n=e.sanitizedBody,o=E(n._id);if(!o)return t.status(400).send({error:"Invalid user ID"});const i=y.demo?{username:{$ne:"demoadmin"}}:{};console.log("\nFilter\n",i),e.userSession.access_level<=parseInt(n.upd)&&he(e=>{e.collection("users").updateOne({_id:o,...i,access_level:{$gt:1}},{$set:{access_level:parseInt(n.upd)}},(e,s)=>{e?(t.sendStatus(500),console.error(e)):t.send(s)})})}),r.use("/api/roles",(e,t,s)=>{e.userSession&&e.userSession.access_level<=5&&s()}),r.get("/api/roles/read/getAll",(e,t,s)=>{t.send({0:{name:"Root",access_level:0},5:{name:"Admin",access_level:5},30:{name:"Approver",access_level:30},100:{name:"User",access_level:100}})}),r.use("/api/api_keys",(e,t,s)=>{e.userSession&&e.userSession.access_level<=5&&s()}),r.get("/api/api_keys/read/getAll",(e,t,s)=>{t.send([])}),r.post("/api/api_keys/write/create",(e,t,s)=>null),r.get("/api/subcomponent/read/:subComp/status",_(),async(e,t,s)=>{t.send(subcomponent_status[e.sanitizedParams.subComp])}),r.use("/api/config",(e,t,s)=>{e.userSession&&e.userSession.access_level<=5&&s()});const c={ignoreFields:["database","web_server.bind_ip","web_server.http_port","web_server.https_port","web_server.http_server_disabled","web_server.https_server_disabled",/web_server\.[^\.]*(http)[^\.]*/],validationRules:{"web_server.session_duration_hours":{validate:e=>"number"==typeof e&&e>0&&e<=168,errorMessage:"Invalid session duration hours value. (0 < value <= 168)"},"discord_bot.token":{validate:e=>"string"==typeof e&&e.length>50&&"******"!=e,errorMessage:"Invalid Discord bot token format"},"squadjs.*.websocket.token":{validate:e=>"string"==typeof e&&e.length>4&&"******"!=e,errorMessage:"Invalid SquadJS token format"}},unsanitizedFields:["discord_bot.token","squadjs.*.websocket.host","squadjs.*.websocket.token"]};function l(e,t){return t.split(".").reduce((e,t)=>e?.[t],e)}function w(e,t){const s=t.split("."),n=s.pop(),o=s.reduce((e,t)=>e?.[t],e);o&&delete o[n]}function b(e,t){return t.some(t=>t instanceof RegExp?t.test(e):t===e)}function $(e,t=""){let s=[];for(let n in e){const o=t?`${t}.${n}`:n;e[n]&&"object"==typeof e[n]&&!Array.isArray(e[n])?(s.push(o),s=s.concat($(e[n],o))):Array.isArray(e[n])?(s.push(o),e[n].forEach((e,t)=>{e&&"object"==typeof e&&(s=s.concat($(e,`${o}.${t}`)))})):s.push(o)}return s}function k(e,t,s,n=null){for(let[o,i]of Object.entries(s)){if(new RegExp("^"+o.replace(/\*/g,"[^.]+")+"$").test(e)&&!i.validate(t,n,e))return{valid:!1,path:e,error:i.errorMessage}}return{valid:!0}}function I(e,t,s){if(Array.isArray(e))return e.map((e,n)=>e&&"object"==typeof e?I(e,`${t}.${n}`,s):e);if(e&&"object"==typeof e){const n={};for(let o in e){const i=t?`${t}.${o}`:o;s.includes(i)||(e[o]&&"object"==typeof e[o]?n[o]=I(e[o],i,s):n[o]=e[o])}return n}return e}function O(e,t){if(Array.isArray(t)&&Array.isArray(e))return t.map((t,s)=>{const n=e[s];return t&&"object"==typeof t&&!Array.isArray(t)&&n&&"object"==typeof n&&!Array.isArray(n)?O(n,t):t});if(Array.isArray(t))return t;if(!t||"object"!=typeof t)return t;if(!e||"object"!=typeof e||Array.isArray(e))return t;const s={...e};for(let e in t)t[e]&&"object"==typeof t[e]&&!Array.isArray(t[e])?s[e]=O(s[e]||{},t[e]):s[e]=t[e];return s}async function x(){const e=Z.keys();for(let t of e){const e=t.match(/\/(.+)\/(.*)\?(true|false)/i);await o(e[1],e[2],"true"==e[3],!0)}}function j(e=null){return new Promise((t,s)=>{he(n=>{n.collection("whitelists").deleteOne({expiration:{$lte:new Date}},(n,o)=>{n&&(console.error("removeExpiredPlayers",n),s(n)),e&&e(),t(o)})})})}function C(e,t){const s=e.originalUrl.replace(/\?.*$/,"");let n=[];for(let e of n)if(s.startsWith(e))return e;return s.endsWith("/")?s.substring(0,s.length-1):s}function A(e,t,s){T(e)?s():t.redirect("/")}function P(n=!1,o=null){let i=new Date;console.log("Current version: ",e,"\n > Checking for updates",i.toLocaleString()),f.get("https://api.github.com/repos/fantinodavide/Squad_Whitelister/releases",{timeout:1e4}).then(i=>{const r=Array.isArray(i.data)?i.data.filter(e=>!e.draft&&e.published_at&&e.tag_name):[];r.sort((e,t)=>new Date(t.published_at)-new Date(e.published_at));const c=r[0];if(!c)return void(o&&o());const l=c.tag_name.toUpperCase().replace("V","").split("."),d=e.toString().split("."),u=H.other.install_beta_versions&&c.prerelease||!c.prerelease,p=parseInt(d[0])<parseInt(l[0]),_=parseInt(d[0])<=parseInt(l[0])&&parseInt(d[1])<parseInt(l[1]),m=parseInt(d[0])<=parseInt(l[0])&&parseInt(d[1])<=parseInt(l[1])&&parseInt(d[2])<parseInt(l[2]);u&&(p||_||m)?(console.log(" > Update found: "+c.tag_name,c.name),n?function(e){const n=e.assets.filter(e=>"release.zip"==e.name)[0].browser_download_url;console.log(" > Downloading update: "+e.tag_name,e.name,n);const o=a.resolve(__dirname,"tmp_update"),i=a.resolve(o,"gitupd.zip");t.existsSync(o)||t.mkdirSync(o);const r=t.createWriteStream(i);f({method:"get",url:n,responseType:"stream"}).then(e=>{e.data.pipe(r)}),r.on("finish",e=>{setTimeout(()=>{!function(e,n){const o=new s({file:n,storeEntries:!0,skipEntryNameValidation:!0});o.on("ready",()=>{t.remove(__dirname+"/dist",()=>{o.extract("release/",__dirname,async(s,n)=>{o.close(),await installUpdateDependencies(),console.log(" > Extracted",n,"files"),t.remove(e,()=>{console.log(`${e} folder deleted`);const t=5e3;console.log(" > Restart in",t/1e3,"seconds"),restartProcess(t,0,y)})})})})}(o,i)},1e3)}),r.on("error",e=>{console.error(e)})}(c):o&&o()):(console.log(" > No updates found"),o&&o())}).catch(e=>{console.error(" > Couldn't check for updates. Proceding startup",e),o&&o()})}function T(e){return e.userSession&&e.userSession.access_level<=5}r.get("/api/config/read/getFull",async(e,t,s)=>{let n=JSON.parse(JSON.stringify(H));const o="******",i=$(n);for(let e of i)b(e,c.ignoreFields)&&w(n,e);if(n.discord_bot.token=o,n.squadjs?.forEach((e,t)=>{n.squadjs[t].websocket.token&&(n.squadjs[t].websocket.token=o)}),process.env.HIDDEN_CONFIG_TABS)for(let e of process.env.HIDDEN_CONFIG_TABS.split(";"))try{delete n[e]}catch(e){}!n.app_personalization?.favicon&&n.app_personalization?.logo_url&&(n.app_personalization.favicon=n.app_personalization.logo_url),t.send(n)}),r.use("/api/config/write",(...e)=>{xe(5,...e)}),r.post("/api/config/write/update",async(e,s,n)=>{const o=e.sanitizedBody;let i={};const r=function(e,t){const s=[],n=[];if("string"!=typeof e||!e.trim())return s.push("Category must be a non-empty string"),{valid:!1,errors:s,warnings:n};const o=Object.keys(ke());if(!o.includes(e))return s.push(`Invalid category: ${e}. Must be one of: ${o.join(", ")}`),{valid:!1,errors:s,warnings:n};if("object"!=typeof t||null===t)return s.push("Config data must be an object"),{valid:!1,errors:s,warnings:n};if("squadjs"===e&&!Array.isArray(t))return s.push("squadjs config must be an array"),{valid:!1,errors:s,warnings:n};const i=10,r=500,a=(e,t=0,n={count:0})=>{if(t>i)return s.push(`Config exceeds maximum nesting depth of ${i}`),!1;if("object"==typeof e&&null!==e){const o=Object.keys(e);if(n.count+=o.length,n.count>r)return s.push(`Config exceeds maximum key count of ${r}`),!1;for(let s of o)if(!a(e[s],t+1,n))return!1}return!0};if(!a(t))return{valid:!1,errors:s,warnings:n};const c=CONFIG_NUMERIC_BOUNDS[e];if(c)for(const[e,{min:n,max:o}]of Object.entries(c))void 0!==t[e]&&("number"!=typeof t[e]||t[e]<n||t[e]>o)&&s.push(`${e} must be a number between ${n} and ${o}`);return{valid:0===s.length,errors:s,warnings:n}}(o.category,o.config);if(!r.valid)return i.status="config_rejected",i.error="Invalid config structure",i.errors=r.errors,i.warnings=r.warnings,s.status(400).send(i);if(process.env.HIDDEN_CONFIG_TABS?.split(";").includes(o.category))return i.status="config_rejected",i.error="Category is hidden",s.send(i);const a=$(o.config,o.category),d=[],u=[];for(let e of a){if(b(e,c.ignoreFields)){d.push(e);continue}const t={[o.category]:o.config},s=k(e,l(t,e),c.validationRules,t);s.valid||u.push(s)}const p=I(o.config,o.category,[...d,...u.map(e=>e.path)]),_=[],m=[];for(let e of d)_.push(e);for(let e of u)_.push(e.path),m.push(`${e.path}: ${e.error} (field ignored)`);if(!("{}"!==JSON.stringify(p)&&"[]"!==JSON.stringify(p)))return i.status="config_rejected",i.error="All fields were invalid or blocked",i.ignoredFields=_,i.warnings=m,s.send(i);try{if(function(e,t,s,n){const o=s?.config;if(!o)return;const i=c.unsanitizedFields.filter(e=>e.startsWith(t+".")).map(e=>e.slice(t.length+1));if(!i.length)return;const r=(e,t,s)=>{const[o,...i]=s;if("*"===o){if(!Array.isArray(e)||!Array.isArray(t))return;return void e.forEach((e,s)=>{t[s]&&r(e,t[s],i)})}if(i.length>0)return void(e?.[o]&&t?.[o]&&r(e[o],t[o],i));const a=t?.[o];e&&"object"==typeof e&&(void 0!==a&&a!==n&&a&&q(a)?e[o]=a:delete e[o])};for(const t of i)r(e,o,t.split("."))}(p,o.category,e.body,"******"),!1===p.automatic_updates&&(console.log(" > API attempt to disable automatic_updates blocked"),delete p.automatic_updates),H[o.category]=O(H[o.category]||{},p),t.writeFileSync(B+".bak",t.readFileSync(B)),t.writeFileSync(B,JSON.stringify(H,null,"\t")),i.status="config_updated",i.action="reload",_.length>0&&(i.ignoredFields=_,i.warnings=m.length>0?m:_.map(e=>`${e}: Protected field (ignored)`)),s.send(i),!["custom_permissions","app_personalization"].includes(o.category))return restartProcess(0,0,y)}catch(e){i.status="error",i.error=e.message,s.send(i)}}),r.use("/api/dbconfig/read/getFull",(e,t,s)=>{e.userSession&&e.userSession.access_level<=5&&s()}),r.get("/api/dbconfig/read/getFull",async(e,t,s)=>{e.sanitizedBody;he(e=>{e.collection("configs").find({config:{$exists:!0,$ne:null},category:{$exists:!0,$ne:null}}).toArray((e,s)=>{e?ve(t,e):s&&t.send(s)})})}),r.use("/api/dbconfig/read/:category",(e,t,s)=>{e.userSession&&e.userSession.access_level<=30&&s()}),r.get("/api/dbconfig/read/:category",_(),async(e,t,s)=>{e.sanitizedBody;return"string"!=typeof e.sanitizedParams.category||e.sanitizedParams.category.includes("$")||e.sanitizedParams.category.includes("{")?t.status(400).send({error:"Invalid parameter"}):void he(s=>{s.collection("configs").findOne({category:e.sanitizedParams.category},(e,s)=>{e?ve(t,e):s&&t.send(s.config)})})}),r.use("/api/dbconfig/write",(...e)=>{xe(5,...e)}),r.post("/api/dbconfig/write/update",async(e,t,s)=>{const n=e.sanitizedBody;if(!n.category||"string"!=typeof n.category||!["backup","seeding_tracker","discord","game","server"].includes(n.category))return t.status(400).send({error:"Invalid category"});if(n.category.includes("$"))return t.status(400).send({error:"Invalid category"});if(n.config&&"object"==typeof n.config){const e=(t,s="")=>{for(const n in t){if(n.startsWith("$"))return{error:!0,path:s+n};if(t[n]&&"object"==typeof t[n]&&!Array.isArray(t[n])){const o=e(t[n],s+n+".");if(o.error)return o}}return{error:!1}},s=e(n.config);if(s.error)return t.status(400).send({error:"Invalid config structure at "+s.path})}if("backup"===n.category&&n.config?.auto_backup?.next_backup){const e=new Date(n.config.auto_backup.next_backup);if(isNaN(e.getTime()))return t.status(400).send({error:"Invalid next backup date."});const s=Date.now()+864e5;if(e.getTime()<s){const e=await he().then(e=>e.collection("configs").findOne({category:"backup"})),s=new Date(e?.config?.auto_backup?.next_backup),o=e=>Math.floor(new Date(e).getTime()/6e4);if(!s||o(n.config.auto_backup.next_backup)<o(s))return t.status(400).send({error:"Next backup must be at least 24 hours from now."})}}he(e=>{e.collection("configs").updateOne({category:n.category},{$set:{config:n.config}},{upsert:!0},(e,s)=>{e?ve(t,e):t.send({status:"config_updated",action:"reload"})})})}),r.use("/api/backup",(...e)=>{xe(5,...e)}),r.get("/api/backup/read/list",async(e,s,n)=>{try{if(!t.existsSync(R))return s.send([]);const e=t.readdirSync(R).filter(e=>e.startsWith("backup_")&&e.endsWith(".info.json")).map(e=>{try{return JSON.parse(t.readFileSync(a.join(R,e),"utf-8"))}catch(e){return null}}).filter(Boolean).sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp));s.send(e)}catch(e){ve(s,e)}}),r.post("/api/backup/write/create",async(e,s,n)=>{try{if(be)return s.status(409).send({error:"Backup or restore already in progress"});if(t.existsSync(R)){const e=new Date(Date.now()-864e5),n=t.readdirSync(R).filter(e=>e.startsWith("backup_")&&e.endsWith(".info.json")).some(s=>{try{const n=JSON.parse(t.readFileSync(a.join(R,s),"utf-8"));return n.manual&&new Date(n.timestamp)>e}catch(e){return!1}});if(n)return s.status(429).send({error:"A manual backup was created in the last 24 hours. Limit: 1 manual backup per 24 hours."})}const e=await he(),n=await e.collection("configs").findOne({category:"backup"}),o=n?.config||{},i=await Se(e,o,!0);s.send({status:"backup_created",data:i})}catch(e){ve(s,e)}}),r.post("/api/backup/write/restore",async(e,s,n)=>{try{if(be)return s.status(409).send({error:"Backup or restore already in progress"});const n=e.sanitizedBody;if(!n.name)return s.status(400).send({error:"Missing backup name"});if(n.name.includes("/")||n.name.includes("\\")||n.name.includes(".."))return s.status(400).send({error:"Invalid backup name"});const o=a.join(R,`${n.name}.tar.gz`);if(!t.existsSync(o))return s.status(404).send({error:"Backup not found"});const i=a.resolve(o),r=a.resolve(R);if(!i.startsWith(r))return s.status(400).send({error:"Invalid backup name"});be=!0;const c=a.join(R,`.tmp_restore_${Date.now()}`);try{t.ensureDirSync(c),await D.extract({file:o,cwd:c});const e=await he(),i=new we(e),r=await i.restore(c,{drop:!0});if(!1!==n.restore_config){const e=a.join(c,"conf.json");t.existsSync(e)&&(t.writeFileSync(B+".bak",t.readFileSync(B)),t.copyFileSync(e,B))}s.send({status:"restore_complete",data:r})}finally{t.removeSync(c),be=!1}}catch(e){be=!1,ve(s,e)}}),r.post("/api/backup/write/delete",async(e,s,n)=>{try{const n=e.sanitizedBody;if(!n.name)return s.status(400).send({error:"Missing backup name"});if(n.name.includes("/")||n.name.includes("\\")||n.name.includes(".."))return s.status(400).send({error:"Invalid backup name"});const o=a.join(R,`${n.name}.tar.gz`),i=a.join(R,`${n.name}.info.json`),r=a.resolve(o),c=a.resolve(R);if(!r.startsWith(c))return s.status(400).send({error:"Invalid backup name"});if(!t.existsSync(o))return s.status(404).send({error:"Backup not found"});const l=await he(),d=await l.collection("configs").findOne({category:"backup"});if(d?.config?.auto_backup?.enabled&&d.config.auto_backup.schedule){const e=d.config.auto_backup.schedule,n=3*(e.value*e.option);if(t.existsSync(i)){const e=JSON.parse(t.readFileSync(i,"utf8")),o=new Date(e.timestamp).valueOf(),r=Date.now()-o;if(r<n){const e=Math.ceil((n-r)/864e5);return s.status(403).send({error:`Cannot delete backup created less than 3x the backup frequency. Wait ${e} more day(s).`})}}}t.removeSync(o),t.existsSync(i)&&t.removeSync(i),s.send({status:"backup_deleted"})}catch(e){ve(s,e)}}),r.use("/api/custom_permissions/read",(e,t,s)=>{e.userSession&&e.userSession.access_level<=30?s():t.sendStatus(403)}),r.get("/api/custom_permissions/read/getAll",(e,t,s)=>{t.send(H.custom_permissions)}),r.use("/api/lists/read",(e,t,s)=>{e.userSession&&e.userSession.access_level<=100&&s()}),r.get("/api/lists/read/getAll",(e,t,s)=>{he(s=>{let n=e.userSession.access_level<100?{}:{hidden_managers:!1};s.collection("lists").find(n).toArray((e,s)=>{e?ve(t,e):t.send(s)})})}),r.use("/api/lists/write",(e,t,s)=>{e.userSession&&e.userSession.access_level<=10?s():t.sendStatus(401)}),r.use("/api/lists/write/checkPerm",async(e,t,s)=>t.send({status:"permission_granted"})),r.post("/api/lists/write/addNewList",(e,t,s)=>{const n=e.sanitizedBody;he(e=>{const s={title:n.title,output_path:n.output_path,hidden_managers:n.hidden_managers,require_appr:n.require_appr,discord_roles:n.discord_roles};e.collection("lists").insertOne(s,(e,s)=>{e?ve(t,e):t.send({status:"inserted_new_list",...s})})})}),r.post("/api/lists/write/deleteList",(e,t,s)=>{const n=e.sanitizedBody;he(e=>{e.collection("whitelists").deleteMany({id_list:E(n.sel_list_id)},(s,o)=>{s?ve(t,s):e.collection("lists").deleteMany({_id:E(n.sel_list_id)},(e,s)=>{e?ve(t,e):t.send({status:"removed_list",...s})})})})}),r.post("/api/lists/write/editList",(e,t,s)=>{const n=e.sanitizedBody;he(e=>{const s={title:n.title,output_path:n.output_path,hidden_managers:n.hidden_managers,require_appr:n.require_appr,discord_roles:n.discord_roles};e.collection("lists").updateOne({_id:E(n.sel_list_id)},{$set:s},(e,s)=>{e?ve(t,e):t.send({status:"edited_list",...s})})})}),r.use("/api/whitelist/read",(e,t,s)=>{e.userSession&&e.userSession.access_level<=100&&s()}),r.get("/api/whitelist/read/getAllClans",(e,t,s)=>{e.sanitizedQuery;he(s=>{const n=[{$match:e.userSession.access_level>=100?{clan_code:e.userSession.clan_code}:{}},{$lookup:{from:"whitelists",localField:"_id",foreignField:"id_clan",as:"clan_whitelist"}},{$addFields:{player_count:{$size:"$clan_whitelist"}}},{$project:{clan_whitelist:0}},{$sort:{full_name:1}}];s.collection("clans").aggregate(n).toArray((e,s)=>{e?(t.sendStatus(500),console.error(e)):t.send(s)})})}),r.get("/api/whitelist/read/getAll",(e,t,s)=>{const n=e.sanitizedQuery;he(e=>{let s=n.sel_clan_id?{id_clan:E(n.sel_clan_id)}:{};const o=[{$match:{id_list:E(n.sel_list_id),...s}},{$lookup:{from:"groups",localField:"id_group",foreignField:"_id",as:"group_full_data"}},{$lookup:{from:"users",localField:"inserted_by",foreignField:"_id",as:"inserted_by"}},{$lookup:{from:"players",localField:"steamid64",foreignField:"steamid64",as:"serverData"}},{$sort:{id_clan:1,approved:-1,id_group:1,username:1}}];e.collection("whitelists").aggregate(o).toArray((e,s)=>{e?(t.sendStatus(500),console.error(e)):t.send(s)})})}),r.get("/api/whitelist/read/getPendingApprovalClans",(e,t,s)=>{e.sanitizedQuery;he(s=>{const n=[{$match:e.userSession.access_level>=100?{clan_code:e.userSession.clan_code}:{}},{$lookup:{from:"whitelists",let:{id_clan:"$_id"},pipeline:[{$match:{$expr:{$eq:["$id_clan","$$id_clan"]},approved:!1}}],as:"whitelists"}},{$sort:{whitelists_data:-1}},{$match:{whitelists:{$exists:!0,$ne:[]}}}];s.collection("clans").aggregate(n).toArray((e,s)=>{e?(t.sendStatus(500),console.error(e)):t.send(s)})})}),r.get("/api/whitelist/read/getPendingApproval",(e,t,s)=>{const n=e.sanitizedQuery;he(e=>{const s=[{$lookup:{from:"whitelists",let:{id_list:"$_id"},pipeline:[{$match:{$expr:{$eq:["$id_list","$$id_list"]},approved:!1,id_clan:E(n.sel_clan_id)}},{$lookup:{from:"groups",localField:"id_group",foreignField:"_id",as:"group_full_data"}},{$lookup:{from:"users",localField:"inserted_by",foreignField:"_id",as:"inserted_by"}},{$sort:{id_clan:1,approved:-1,id_group:1,username:1}}],as:"wl_data"}},{$match:{wl_data:{$exists:!0,$ne:[]}}}];e.collection("lists").aggregate(s).toArray((e,s)=>{e?(t.sendStatus(500),console.error(e)):t.send(s)})})}),r.use("/api/whitelist/write",(e,t,s)=>{e.userSession&&e.userSession.access_level<=30?s():he((n,o)=>{let i=e.userSession.access_level>=100?{clan_code:e.userSession.clan_code,admins:e.userSession.id_user.toString()}:{};n.collection("clans").findOne(i,(n,o)=>{n?ve(t,n):null!=o?(console.log("authorizing",e.userSession.username,"=>",o),s()):(console.log("blocking",o),t.sendStatus(401))})})}),r.use("/api/whitelist/write/checkPerm",async(e,t,s)=>t.send({status:"permission_granted"})),r.post("/api/whitelist/write/addPlayer",(e,t,s)=>{const n=e.sanitizedBody;return"string"!=typeof n.username||0===n.username.length||n.username.length>100?t.status(400).send({error:"Invalid username"}):re(n.username)||re(n.steamid64)||re(n.eosID)?(ce(ae(e),"Whitelist injection in addPlayer"),t.status(403).send({error:"Forbidden"})):!n.steamid64||"string"==typeof n.steamid64&&/^\d{17}$/.test(n.steamid64)?!n.eosID||null===n.eosID||""===n.eosID||"string"==typeof n.eosID&&/^[a-f\d]{32}$/.test(n.eosID)?(n.discordUsername||(n.discordUsername=""),void he(s=>{const o=[{$match:e.userSession.access_level>=100?{clan_code:e.userSession.clan_code,admins:e.userSession.id_user.toString()}:{_id:E(n.sel_clan_id)}},{$lookup:{from:"whitelists",localField:"_id",foreignField:"id_clan",as:"clan_whitelist"}},{$addFields:{player_count:{$size:"$clan_whitelist"}}},{$project:{clan_whitelist:0}}];s.collection("clans").aggregate(o).toArray((o,i)=>{console.log("====>",i);let r=i[0];if(o)console.log("error",o);else if(null!=r)if(""==r.player_limit||r.player_count<parseInt(r.player_limit)||e.userSession.access_level<=5){let o={id_clan:r._id,username:n.username,username_l:n.username.toLowerCase(),steamid64:n.steamid64,eosID:n.eosID,id_group:E(n.group),discord_username:n.discordUsername.startsWith("@")||""==n.discordUsername?""+n.discordUsername:"@"+n.discordUsername,inserted_by:e.userSession.id_user,insertedViaApiKey:!e.userSession.id_user&&!!e.userSession.id,expiration:!(!n.durationHours||""==n.durationHours)&&new Date(Date.now()+60*parseFloat(n.durationHours)*60*1e3),insert_date:new Date,approved:!1,id_list:E(n.sel_list_id)};o.steamid64||o.eosID||t.status(400).send({status:"not_inserted",reason:"Player ID not found."}),s.collection("players").findOne(n.eosID?{eosID:n.eosID}:{steamid64:n.steamid64},(n,a)=>{!o.eosID&&a&&a.eosID&&(o.eosID=a.eosID),!o.steamid64&&a&&a.steamid64&&(o.steamid64=a.steamid64),s.collection("lists").findOne({_id:o.id_list},(n,a)=>{n?ve(t,n):e.userSession.access_level<100||!a.hidden_managers?s.collection("groups").findOne(o.id_group,(n,c)=>{n?console.log("error",n):null!=c?(o.approved=!(c.require_appr||r.confirmation_ovrd||a.require_appr)||e.userSession.access_level<=30,s.collection("whitelists").insertOne(o,(s,n)=>{if(s)console.log("ERR",s);else if(t.send({status:"inserted_new_player",player:{...o,inserted_by:[{username:e.userSession.username}]},...n}),subcomponent_status.discord_bot){let t,s=[];o.approved?t={}:(t=(new S.ActionRowBuilder).addComponents((new S.ButtonBuilder).setCustomId("approval:approve:"+o._id).setLabel("Approve").setStyle(S.ButtonStyle.Success),(new S.ButtonBuilder).setCustomId("approval:reject:"+o._id).setLabel("Reject").setStyle(S.ButtonStyle.Danger)),s.push(t));const n=[(new S.EmbedBuilder).setColor(H.app_personalization.accent_color).setTitle("Whitelist Update").addFields({name:"Username",value:o.username,inline:!0},{name:"SteamID",value:S.hyperlink(o.steamid64,"https://steamcommunity.com/profiles/"+o.steamid64),inline:!0},{name:"Clan",value:i[0].full_name},{name:"Group",value:c.group_name,inline:!0})];o.expiration&&n[0].addFields({name:"Expiration",value:S.time(o.expiration,"R"),inline:!0}),n[0].addFields({name:"Manager",value:e.userSession.username},{name:"List",value:a.title},{name:"Approval",value:o.approved?":white_check_mark: Approved":":hourglass: Pending",inline:!0}),me(K.channels.cache.get(H.discord_bot.whitelist_updates_channel_id),{embeds:n,components:s},"whitelist updates channel")}})):t.send({status:"not_inserted",reason:"could find corresponding id"})}):t.sendStatus(402)})})}else t.send({status:"not_inserted",reason:"Player limit reached"});else t.sendStatus(401)})})):t.status(400).send({error:"Invalid eosID"}):t.status(400).send({error:"Invalid steamid64"})}),r.post("/api/whitelist/write/removePlayer",(e,t,s)=>{const n=E(e.sanitizedBody._id);if(!n)return t.status(400).send({error:"Invalid whitelist ID"});he(e=>{e.collection("whitelists").deleteOne({_id:n},(e,s)=>{e?ve(t,e):t.send({status:"removing_ok",...s})})})}),r.post("/api/whitelist/write/clearList",(e,t,s)=>{const n=e.sanitizedBody;he(e=>{e.collection("whitelists").deleteMany({id_clan:E(n.sel_clan_id),id_list:E(n.sel_list_id)},(e,s)=>{e?ve(t,e):t.send({status:"clearing_ok",...s})})})}),r.use("/api/seeding/read",(e,t,s)=>{e.userSession&&e.userSession.access_level<=30?s():t.sendStatus(401)}),r.get("/api/seeding/read/getPlayers",(e,t,s)=>{he(e=>{e.collection("players").find({seeding_points:{$gte:1},username:{$ne:null}}).toArray((e,s)=>{e?ve(t,e):t.send(s)})})}),r.use("/api/players/read",(e,t,s)=>{e.userSession&&e.userSession.access_level<=30?s():t.sendStatus(401)}),r.get("/api/players/read/from/steamId/:id",_(),(e,t,s)=>{if("string"!=typeof e.sanitizedParams.id||!/^\d{17}$/.test(e.sanitizedParams.id))return t.status(400).send({error:"Invalid Steam ID format"});he(s=>{s.collection("players").findOne({steamid64:e.sanitizedParams.id},(e,s)=>{e?ve(t,e):t.send(s)})})}),r.get("/api/players/read/from/eosId/:id",_(),(e,t,s)=>{if("string"!=typeof e.sanitizedParams.id||!/^[a-f0-9]{32}$/i.test(e.sanitizedParams.id))return t.status(400).send({error:"Invalid EOS ID format"});he(s=>{s.collection("players").findOne({eosID:e.sanitizedParams.id},(e,s)=>{e?ve(t,e):t.send(s)})})}),r.get("/api/players/read/from/discordUserId/:id",_(),(e,t,s)=>{if("string"!=typeof e.sanitizedParams.id||!/^\d{17,20}$/.test(e.sanitizedParams.id))return t.status(400).send({error:"Invalid Discord User ID format"});he(s=>{s.collection("players").findOne({discord_user_id:e.sanitizedParams.id},(e,s)=>{e?ve(t,e):t.send(s)})})}),r.use("/api/players/write",(e,t,s)=>{e.userSession&&e.userSession.access_level<=10?s():t.sendStatus(401)}),r.post("/api/players/write/seeding_score",(e,t,s)=>{he(async s=>{if(!Array.isArray(e.sanitizedBody.steamIDs)||"boolean"!=typeof e.sanitizedBody.incremental)return t.status(400).send("Invalid input");if("number"!=typeof e.sanitizedBody.points||e.sanitizedBody.points<0||e.sanitizedBody.points>1e3)return t.status(400).send({error:"Invalid points"});const n=e.sanitizedBody.steamIDs,o=e.sanitizedBody.incremental?"$inc":"$set",i=e.sanitizedBody.points,r=await s.collection("players").updateMany({steamid64:{$in:n}},{[o]:{seeding_points:i}}).catch(e=>{t.sendStatus(500)});t.send(r)})}),r.use("/api/approval/write",(e,t,s)=>{e.userSession&&e.userSession.access_level<=30?s():t.sendStatus(401)}),r.use("/api/approval/write/setApprovedStatus",(e,t,s)=>{De(e.sanitizedBody,t)}),r.use("/api/gameGroups/write",(e,t,s)=>{e.userSession&&e.userSession.access_level<10?s():t.sendStatus(401)}),r.use("/api/gameGroups/write/checkPerm",async(e,t,s)=>t.send({status:"permission_granted"})),r.post("/api/gameGroups/write/newGroup",(e,t,s)=>{const n={};if(["group_name","group_permissions","require_appr","discord_roles"].forEach(t=>{void 0!==e.sanitizedBody[t]&&(n[t]=e.sanitizedBody[t])}),re(n.group_name))return ce(ae(e),"Whitelist injection in newGroup"),t.status(403).send({error:"Forbidden"});he(e=>{e.collection("groups").insertOne(n,(e,s)=>{e?ve(t,e):t.send({status:"group_created",data:n,dbRes:{...s}})})})}),r.post("/api/gameGroups/write/editGroup",(e,t,s)=>{if(re(e.sanitizedBody.group_name))return ce(ae(e),"Whitelist injection in editGroup"),t.status(403).send({error:"Forbidden"});const n={};["group_name","group_permissions","require_appr","discord_roles"].forEach(t=>{void 0!==e.sanitizedBody[t]&&(n[t]=e.sanitizedBody[t])});const o=E(e.sanitizedBody._id);if(!o)return t.status(400).send({error:"Invalid group ID"});he(e=>{e.collection("groups").updateOne({_id:o},{$set:n},(s,n)=>{s?ve(t,s):e.collection("groups").findOne({_id:o},(e,s)=>{t.send({status:"edit_ok",...s})})})})}),r.post("/api/gameGroups/write/remove",(e,t,s)=>{const n=E(e.sanitizedBody._id);if(!n)return t.status(400).send({error:"Invalid group ID"});he(e=>{e.collection("groups").deleteOne({_id:n},(s,o)=>{if(s)return ve(t,s);e.collection("whitelists").deleteMany({id_group:n},(e,s)=>{if(e)return ve(t,e);t.send({status:"removing_ok",groupResult:o,whitelistResult:s})})})})}),r.get("/api/gameGroups/read/getAllGroups",(e,t,s)=>{he(s=>{let n={};function o(){s.collection("groups").find(n).sort({group_name:1}).toArray((e,s)=>{e?ve(t,e):t.send(s)})}e.userSession&&e.userSession.access_level>=100?s.collection("clans").findOne({clan_code:e.userSession.clan_code},(e,s)=>{if(e)ve(t,e);else{let e=[];if(s)for(let t of s.available_groups)e.push(d(t));n={_id:{$in:e}},o()}}):o()})}),r.use("/api/discord",(...e)=>{xe(30,...e)}),r.use("/api/discord/write",(...e)=>{xe(10,...e)}),r.get("/api/discord/read/getStatus",(e,t,s)=>{t.send(subcomponent_status.discord_bot)}),r.get("/api/discord/read/getRoles",(e,t,s)=>{e.sanitizedQuery;if(subcomponent_status.discord_bot){const e=K.guilds.cache.find(e=>e.id==H.discord_bot.server_id);let s=[];for(let t of e.roles.cache)"@everyone"!==t[1].name.toLowerCase()&&s.push({id:t[1].id,name:t[1].name});t.send(s)}else t.sendStatus(404)}),r.get("/api/discord/read/getServers",async(e,t,s)=>{e.sanitizedQuery;if(subcomponent_status.discord_bot){let e=[];for(let t of await K.guilds.fetch())e.push({id:t[1].id,name:t[1].name});t.send(e)}else t.sendStatus(404)}),r.get("/api/discord/read/getChannels",async(e,t,s)=>{e.sanitizedQuery;if(subcomponent_status.discord_bot){const e=await K.guilds.fetch(H.discord_bot.server_id,{cache:!0}).catch(e=>console.error(`Unable to fetch Discord guild ${H?.discord_bot?.server_id}`));if(!e)return t.send([]);t.send(e.channels.cache.filter(e=>4!=e.type).sort((e,t)=>{const s=e.parent,n=t.parent;return!s&&n?-1:s&&!n?1:(s||n)&&s.id!==n.id?s.rawPosition-n.rawPosition:e.rawPosition-t.rawPosition}))}else t.sendStatus(404)}),r.get("/api/discord/read/inviteLink",async(e,t,s)=>{t.send({url:subcomponent_data.discord_bot.invite_link})}),r.use("/api/clans",(e,t,s)=>{e.userSession&&e.userSession.access_level<10&&s()}),r.get("/api/clans/getAllClans",(e,t,s)=>{he(e=>{e.collection("clans").find().sort({full_name:1,tag:1}).toArray((e,s)=>{t.send(s)})})}),r.post("/api/clans/removeClan",(e,t,s)=>{const n=E(e.sanitizedBody._id);if(!n)return t.status(400).send({error:"Invalid clan ID"});he(e=>{e.collection("clans").deleteOne({_id:n},(e,s)=>{e?ve(t,e):t.send({status:"removing_ok",...s})})})}),r.post("/api/clans/editClan",(e,t,s)=>{if(re(e.sanitizedBody.full_name)||re(e.sanitizedBody.tag))return ce(ae(e),"Whitelist injection in editClan"),t.status(403).send({error:"Forbidden"});const n={};["full_name","tag","clan_code","description","discord_server_id","confirmation_ovrd"].forEach(t=>{void 0!==e.sanitizedBody[t]&&(n[t]=e.sanitizedBody[t])});const o=E(e.sanitizedBody._id);if(!o)return t.status(400).send({error:"Invalid clan ID"});he(e=>{e.collection("clans").updateOne({_id:o},{$set:n},(s,n)=>{s?ve(t,s):e.collection("clans").findOne({_id:o},(e,s)=>{t.send({status:"edit_ok",...s})})})})}),r.get("/api/clans/getClanUsers",(e,t,s)=>{const n=e.sanitizedQuery;return n.clan_code&&"string"==typeof n.clan_code?n.clan_code.includes("$")||n.clan_code.includes("{")?t.status(400).send({error:"Invalid clan_code parameter"}):void he(e=>{e.collection("users").find({clan_code:n.clan_code},{password:0}).toArray((e,s)=>{t.send(s)})}):t.status(400).send({error:"Invalid clan_code parameter"})}),r.get("/api/clans/getClanAdmins",(e,t,s)=>{const n=E(e.sanitizedQuery._id);if(!n)return t.status(400).send({error:"Invalid clan ID"});he(e=>{e.collection("clans").findOne({_id:n},{projection:{admins:1}},(e,s)=>{if(e)ve(t,e);else{let e=s.admins?s.admins:[];t.send(e)}})})}),r.post("/api/clans/editClanAdmins",(e,t,s)=>{const n=e.sanitizedBody,o=E(e.sanitizedBody._id);if(!o)return t.status(400).send({error:"Invalid clan ID"});he(e=>{e.collection("clans").updateOne({_id:o},{$set:{admins:n.clan_admins}},(e,s)=>{t.send({status:"edit_ok",...s})})})}),r.post("/api/clans/newClan",(e,t,s)=>{const n=e.sanitizedBody;if(re(n.full_name)||re(n.tag))return ce(ae(e),"Whitelist injection in newClan"),t.status(403).send({error:"Forbidden"});let o;do{let e=Oe(8);o=!1,he(s=>{s.collection("clans").findOne({full_name_lower:n.full_name.toLowerCase()},(i,r)=>{let a={...n,clan_code:e};a.full_name_lower=n.full_name.toLowerCase(),i?(t.sendStatus(500),console.error(i)):null==r?s.collection("clans").findOne({clan_code:e},(e,n)=>{e?(t.sendStatus(500),console.error(e)):null==n?s.collection("clans").insertOne(a,(e,s)=>{e?(t.sendStatus(500),console.error(e)):(t.send({status:"clan_created",clan_data:a}),console.log("New clan created:",a))}):o=!0}):(t.status(409).send({status:"clan_already_registered"}),console.log("Trying to register an already registered clan:",a))})})}while(o)}),r.use("/api/keys",(e,t,s)=>{e.userSession&&e.userSession.access_level<=5?s():t.sendStatus(403)}),r.use("/api/keys/checkPerm",(e,t,s)=>t.send(!0)),r.get("/api/keys{/:id}",_(),async(e,t,s)=>{const n=[{$lookup:{from:"users",localField:"inserted_by",foreignField:"_id",as:"inserted_by"}},{$lookup:{from:"players",localField:"steamid64",foreignField:"steamid64",as:"serverData"}},{$sort:{access_level:-1}},{$project:{token:0}}],o=await he();if(e.sanitizedParams.id){const s=E(e.sanitizedParams.id);if(!s)return t.status(400).send({error:"Invalid key ID"});n.unshift({$match:{_id:s}});const i=(await o.collection("keys").aggregate(n).toArray())[0];return i&&(i.token=null),void t.send(i)}const i=await o.collection("keys").aggregate(n).toArray();i.forEach(e=>e.token=null),t.send(i)}),r.post("/api/keys/",async(e,t,s)=>{const n=await he();if(!e.sanitizedBody.name||"string"!=typeof e.sanitizedBody.name||0===e.sanitizedBody.name.trim().length)return t.status(400).send({message:"API key name is required and must be a non-empty string",field:"name"});if(e.sanitizedBody.name.length>100)return t.status(400).send({message:"API key name must not exceed 100 characters",field:"name"});if(e.sanitizedBody.name.includes("$")||e.sanitizedBody.name.includes("{"))return t.status(400).send({message:"API key name contains invalid characters",field:"name"});const o=Oe(128),i={name:e.sanitizedBody.name.trim(),token:u.createHash("sha512").update(o).digest("hex"),access_level:+e.sanitizedBody.access_level,inserted_by:e.userSession.id_user};if(i.access_level<e.userSession.access_level)return void t.status(403).send({message:"You are not authorized to create an API key with access_level lower than yours."});if(await n.collection("keys").findOne({name:i.name}))return void t.status(401).send({message:"An API key with the same name already exists!",field:"name"});await n.collection("keys").findOne({token:i.token})?t.status(401).send({message:"An API key with the same name token already exists, please try again!"}):n.collection("keys").insertOne(i,async(e,s)=>{if(e)t.sendStatus(500),console.error(e);else{const e=await n.collection("keys").findOne({_id:s.insertedId});t.send({status:"created",data:{...e,token:o}})}})}),r.delete("/api/keys/{:id}",_(),async(e,t,s)=>{const n=await he(),o=E(e.sanitizedParams.id);if(!o)return t.status(400).send({error:"Invalid key ID"});const i=await n.collection("keys").deleteOne({_id:o});t.send(i)}),r.use("/api/keys",(e,t,s)=>{e.userSession&&e.userSession.access_level<=100&&s()}),r.get("/api/docs",async(e,t,s)=>{t.send(apiDocsJson)}),r.use("/admin",A),r.use("/admin",function(e,t,s){i.static("admin")(e,t,s)}),r.use("/api/admin",A),r.get("/api/admin",(e,t,s)=>{t.send({status:"Ok"})}),r.get("/api/admin/getConfig",(e,t,s)=>t.status(404).send()),r.get("/api/admin/checkInstallUpdate",(e,t,s)=>(t.send({status:"Ok"}),P(!0))),r.get("/api/admin/restartApplication",(e,t,s)=>(t.send({status:"Ok"}),restartProcess(e.sanitizedQuery.delay?e.sanitizedQuery.delay:0,0,y))),r.get("{/*splat}",(e,t)=>{t.sendFile(__dirname+"/dist/index.html")}),r.use((e,t,s)=>{t.redirect(404,"/")})}async function me(e,t,s="channel"){try{return e?await e.send(t):(console.error(`[Discord] Cannot send message: ${s} not found`),null)}catch(e){const t={50001:`Missing access to ${s}`,50013:`Missing permissions to send message in ${s}`,50007:"Cannot send message to this user (DMs disabled or bot blocked)",10003:`Unknown ${s}`,10004:"Unknown guild",10008:"Unknown message",50035:"Invalid message format",40005:"Request entity too large"}[e.code]||`Failed to send message (${e.message})`;return console.error(`[Discord] ${t}`),null}}function ge(e,t,s,n=2){Date.now();return new Promise((o,i)=>{e.timeout(1e3*n).emit(t,s,(e,t)=>{if(e){Date.now();return i(e)}o(t)})})}async function fe(e){const t=await he(),s=await t.collection("groups").find().toArray(),n=await t.collection("configs").findOne({category:"seeding_tracker"}),o=n.config,i=o.reward_needed_time.value*(o.reward_needed_time.option/1e3/60);let r;try{r=E(n.config.reward_group_id)}catch(e){r=null,console.log("FAILED TO CREATE objIdRewardGroup from value:",n.config.reward_group_id,"\n",o)}let a,c=[];r&&(a=n.config.reward_group_id?await t.collection("groups").findOne({_id:r}):null),c.push(...(await t.collection("whitelists").find({steamid64:e}).toArray()).map(e=>{const n=s.find(t=>t._id.toString()==e.id_group.toString());if(!n)return void t.collection("whitelists").deleteOne({_id:e._id});let o={};return o.id=e.id_group.toString(),o.name=n.group_name,o.expiration=e.expiration,o.approved=e.approved,o.source="Whitelists",o}).filter(e=>null!=e));const l=[{$match:{steamid64:e,discord_roles_ids:{$exists:!0}}},{$lookup:{from:"groups",let:{pl_roles:"$discord_roles_ids"},pipeline:[{$addFields:{int_r:{$setIntersection:["$discord_roles","$$pl_roles"]}}},{$match:{int_r:{$ne:[]}}}],as:"groups"}},{$project:{discord_roles_ids:0,"groups.discord_roles":0,"groups.intersection_roles":0,"groups.int_r":0,"groups.require_appr":0}},{$match:{lists:{$ne:[]}}}],d=await t.collection("players").aggregate(l).toArray();for(let e of d){Math.round(100*e.seeding_points/i)>=100&&a&&c.push({id:a._id?.toString(),name:a.group_name,expiration:"fixed_reset"==o.tracking_mode&&new Date(o.next_reset),approved:"true"==o.reward_enabled,source:"Seeding"});for(let t of e.groups)c.push({id:t._id,name:t.group_name,expiration:!1,approved:!0,source:"Discord"})}return c}function ye(e){return"https://steamcommunity.com/profiles/"+e}function he(e=()=>{},t=!1){return new Promise((s,n)=>{if(t){let t,o;process.env.MONGODB_CONNECTION_STRING?t=process.env.MONGODB_CONNECTION_STRING:(t=H.database.mongo.host.includes("://")?H.database.mongo.host:"mongodb://"+H.database.mongo.host+":"+H.database.mongo.port,o=H.database.mongo.database);l.connect(t,function(t,i){if(t)n(t);else{var r=o?i.db(o):i.db();e(r),s(r)}})}else e(Y),s(Y)})}!function(e){console.log("Current dir: ",__dirname),console.log(`Configuration file path: ${B}`);let s=ke();if(t.existsSync(B)){var n={...JSON.parse(t.readFileSync(B,"utf-8").toString())};Ie(n,s),t.writeFileSync(B,JSON.stringify(n,null,"\t")),e()}else console.log(`Creating config file at path: ${B}`),Ce(s.web_server.http_port,function(n){console.log(`Found for free HTTP port: ${n}`),s.web_server.http_port=n,console.log(`Set HTTP port: ${s.web_server.http_port}`),Ce(s.web_server.https_port,function(n){s.web_server.https_port=n,console.log('Configuration file created, set your parameters and run again "node server".\nTerminating execution...'),t.writeFileSync(B,JSON.stringify(s,null,"\t")),process.env.PROCESS_MANAGER_TYPE&&"DOCKER"==process.env.PROCESS_MANAGER_TYPE.toUpperCase()?e():process.exit(0)})})}(()=>{const e=function(){try{const e=ke();if(!t.existsSync(B))return{success:!1,error:"Config file does not exist"};let s;try{s=JSON.parse(t.readFileSync(B,"utf-8"))}catch(e){s={}}const n=JSON.parse(JSON.stringify(e)),o=(e,t)=>"boolean"==typeof t?"boolean"==typeof e:"number"==typeof t?"number"==typeof e||!isNaN(+e):"string"==typeof t?"string"==typeof e:Array.isArray(t)?Array.isArray(e):"object"==typeof t&&null!==t&&"object"==typeof e&&null!==e,i=(e,t,s)=>{for(let n in s)void 0!==t[n]&&(Array.isArray(s[n])?Array.isArray(t[n])&&(e[n]=t[n].map((e,t)=>{if("object"==typeof s[n][0]&&"object"==typeof e){const t=JSON.parse(JSON.stringify(s[n][0]));return i(t,e,s[n][0]),t}return o(e,s[n][0])?e:s[n][0]})):"object"==typeof s[n]&&null!==s[n]?"object"==typeof t[n]&&null!==t[n]&&i(e[n],t[n],s[n]):o(t[n],s[n])&&("number"==typeof s[n]&&"string"==typeof t[n]?e[n]=+t[n]:e[n]=t[n]))};i(n,s,e);for(const[e,t]of Object.entries(CONFIG_NUMERIC_BOUNDS))if(n[e])for(const[s,{min:o,max:i}]of Object.entries(t))"number"==typeof n[e][s]&&(n[e][s]=Math.min(Math.max(n[e][s],o),i));if(process.env.MONGODB_CONNECTION_STRING&&(n.database.mongo.host=process.env.MONGODB_CONNECTION_STRING),JSON.stringify(n)===JSON.stringify(s))return{success:!0,repaired:!1};const r=`${B}.backup.${Date.now()}`;return t.copyFileSync(B,r),t.writeFileSync(B,JSON.stringify(n,null,"\t")),{success:!0,backupPath:r,repaired:!0}}catch(e){return console.error(" > Config repair error:",e.message),{success:!1,error:e.message}}}();e.success&&e.repaired&&console.log(`Config file repaired (backup: ${e.backupPath})`),console.log=(...e)=>{const t=`[${(new Date).toISOString()}]`;H?.other?.prepend_date_time_in_console&&e.unshift(t),F(...e),G(...e)},console.error=(...e)=>{const t=`[${(new Date).toISOString()}]`;H?.other?.prepend_date_time_in_console&&e.unshift(t),N(...e),J(...e)},t.readdir(a.join(__dirname,"logs"),{withFileTypes:!0},(e,s)=>{(H&&H.other&&s.length>H.other.logs_max_file_count||s.length>10)&&(s=s.slice(0,s.length-H.other.logs_max_file_count)).forEach(e=>{t.remove(a.join(__dirname,"logs",e.name))})}),console.log("ARGS:",y),console.log("ENV:",process.env),t.watchFile(B,(e,s)=>{console.log("Reloading configuration");let n,o=!1;try{n=JSON.parse(t.readFileSync(B,"utf-8").toString())}catch(e){console.log("Error found in conf.json file. Couldn't reload configuration."),o=!0}o||(H=n,console.log("Reloaded configuration.",H))}),H=JSON.parse(t.readFileSync(B,"utf-8").toString()),console.log(H),function(e=null){{console.log("MongoDB connection");const t=setTimeout(()=>{console.error(" > Connection failed. Check your Database configuration."),restartProcess(0,1,y)},1e4);he(s=>{s?console.log(" > Successfully connected"):(console.error(" > Unable to connect"),restartProcess(5,1,null,!0)),Y=s,clearTimeout(t),e&&e()},!0)}}(()=>{!function(e){const t={title:"Main",output_path:"wl",hidden_managers:!1,require_appr:!1,discord_roles:[]},s={category:"seeding_tracker",config:{reset_seeding_time:{value:1,option:864e5},reward_needed_time:{value:1,option:36e5},reward_group_id:"",next_reset:"",seeding_player_threshold:50,seeding_start_player_count:2,reward_enabled:"false",discord_seeding_reward_channel:"",discord_seeding_score_channel:"",tracking_mode:"incremental",time_deduction:{value:1,option:"perc_minute"},minimum_reward_duration:{value:1,option:36e5}}};he(async n=>{function o(e){n.listCollections({name:"lists"}).next((t,s)=>{null==s?i(e):n.collection("lists").countDocuments({},(t,s)=>{0===s?i(e):e()})})}function i(e){n.collection("lists").insertOne(t,(t,s)=>{t?ve(res,t):(console.log("Collection 'lists' created.\n",s),n.collection("whitelists").updateMany({id_list:{$exists:!1}},{$set:{id_list:s.insertedId}},(t,s)=>{t?ve(res,t):(console.log("Updated references"),e())}))})}async function r(e){let s=!1;const o=Object.keys(t);async function i(r){const a=o[r];await n.collection("lists").updateMany({[a]:{$exists:!1}},{$set:{[a]:t[a]}},async(t,n)=>{t?console.error(t):(n.modifiedCount>0&&(s||(s=!0,console.log("Repairing Lists format"))),r<o.length-1?await i(r+1):e())})}await i(0)}async function a(e=()=>{}){let t=!1;const o=Object.keys(s.config);async function i(r){const a=`config.${o[r]}`;await n.collection("configs").updateOne({category:"seeding_tracker",[a]:{$exists:!1}},{$set:{[a]:s.config[o[r]]}},async(s,n)=>{s?console.error(s):(n.modifiedCount>0&&(t||(t=!0,console.log("Repairing SD Config format"))),r<o.length-1?await i(r+1):e())})}await i(0)}async function c(){console.log("Syncing database indexes");const e={players:["discord_user_id","steamid64","eosID","seeding_points","discord_roles_ids"],sessions:["token"],clans:["clan_code"],groups:[],lists:["output_path"],whitelists:["id_clan","steamid64","eosID","id_group","id_list"],keys:["token"]};for(let t in e){console.log(` > Syncing collection "${t}"`);for(let s of e[t]){let e=!1;await n.collection(t).createIndex({[s]:1}).catch(t=>{e=!0,console.log(`  > "${s}": Fail. Error: ${t}`)}),e||console.log(`  > "${s}": Success`)}}}subcomponent_data.database.root_user_registered=!!await n.collection("users").findOne({access_level:0}),y.demo&&n.collection("users").updateOne({username:"demoadmin"},{$set:{password:u.createHash("sha512").update("demo").digest("hex"),access_level:5}},{upsert:!0}),await c(),n.collection("players").deleteMany({discord_user_id:{$exists:!0},steamid64:{$exists:!1}}),await n.collection("configs").findOne({category:"seeding_tracker",config:{$exists:!0}})||n.collection("configs").updateOne({category:"seeding_tracker"},{$set:{config:{tracking_mode:"incremental"}}},{upsert:!0}),await n.collection("configs").findOne({category:"backup",config:{$exists:!0}})||n.collection("configs").updateOne({category:"backup"},{$set:{config:{auto_backup:{enabled:!0,schedule:{value:1,option:864e5},next_backup:(new Date).toISOString().split(/T/)[0],max_retention_count:10},include_config_file:!0}}},{upsert:!0}),await a(),await async function(){try{const e=await he(),t=await e.collection("configs").findOne({category:"seeding_tracker"});if(!t?.config)return;const s=t.config.reward_needed_time?.value||0,n=t.config.seeding_player_threshold||0,o=t.config.seeding_start_player_count||0;if(0===s&&n>100&&0===o){const t={reset_seeding_time:{value:1,option:864e5},reward_needed_time:{value:1,option:36e5},reward_group_id:"",next_reset:"",seeding_player_threshold:50,seeding_start_player_count:2,reward_enabled:"false",discord_seeding_reward_channel:"",discord_seeding_score_channel:"",tracking_mode:"incremental",time_deduction:{value:1,option:"perc_minute"},minimum_reward_duration:{value:1,option:36e5}};await e.collection("configs").updateOne({category:"seeding_tracker"},{$set:{config:t}}),console.log("Reset seeding tracker config")}}catch(e){console.error("Error resetting seeding tracker config:",e)}}(),await async function(){try{const e=await he(),t=await e.collection("configs").findOne({category:"seeding_tracker"}),s=t?.config?.reward_group_id;let n=null,o=!1,i="";if(null==s)return;if(""===s&&(o=!0,i="Empty reward_group_id"),!o)try{n=await e.collection("groups").findOne({_id:E(s)})}catch(e){o=!0,i="Invalid reward_group_id format"}if(o||n||(o=!0,i=i||"Reward group deleted"),!o){const e=n?.group_permissions||[],t=["ban","immune","kick","changemap","canseeadminchat","config","camera"];e.some(e=>t.includes(e.toLowerCase()))&&(o=!0,i=`Dangerous permissions (${e.join(", ")})`)}if(o){const t=await e.collection("groups").findOne({group_permissions:{$size:1,$all:["reserve"]}});t?(await e.collection("configs").updateOne({category:"seeding_tracker"},{$set:{"config.reward_group_id":t._id.toString()}}),console.log(`Seeding tracker reward group: ${i}, switched to safe group: ${t.group_name}`)):(await e.collection("configs").updateOne({category:"seeding_tracker"},{$set:{"config.reward_group_id":""}}),console.log(`Seeding tracker reward group: ${i}, no safe group found, cleared reference`))}}catch(e){console.error("Error fixing seeding tracker reward group:",e)}}(),await async function(e){try{const t=/Group=|Admin=/i,s={$or:[{steamid64:{$exists:!0,$nin:[null,""],$not:{$regex:/^\d{17}$/}}},{eosID:{$exists:!0,$nin:[null,""],$not:{$regex:/^[a-f\d]{32}$/}}}]},n={$or:[{username:{$regex:t}},{steamid64:{$regex:t}},{eosID:{$regex:t}},{discord_username:{$regex:t}}]},o=await e.collection("whitelists").deleteMany({$or:[s,n]});o.deletedCount>0&&console.log(`Sanitized ${o.deletedCount} whitelist(s) with invalid player IDs or injected names`);const i=await e.collection("groups").deleteMany({group_name:{$regex:t}});i.deletedCount>0&&console.log(`Sanitized ${i.deletedCount} group(s) with injected names`);const r=await e.collection("clans").deleteMany({$or:[{full_name:{$regex:t}},{tag:{$regex:t}}]});r.deletedCount>0&&console.log(`Sanitized ${r.deletedCount} clan(s) with injected names`)}catch(e){console.error("Error sanitizing whitelist data:",e)}}(n),await async function(){try{const e=await he(),t=await e.collection("ip_blacklist").find({}).toArray();t.forEach(e=>ie.add(e.ip)),t.length>0&&console.log(`Loaded ${t.length} blacklisted IP(s)`)}catch(e){console.error("Error loading IP blacklist:",e)}}(),o(()=>{r(e)})})}(_e)})});class we{constructor(e,t={}){this.dbo=e,this.batchSize=t.batchSize||1e3,this.cursorBatchSize=t.cursorBatchSize||500}async backup(e,s=null){let n;if(null===s){n=(await this.dbo.listCollections().toArray()).map(e=>e.name)}else n=s;const o=[];for(const s of n){const n=this.dbo.collection(s),i=await n.estimatedDocumentCount();console.log(`Backing up collection: ${s} (~${i} docs)`);const r=(await n.indexes()).filter(e=>"_id_"!==e.name),c=a.join(e,`${s}.ndjson.gz`),l=t.createWriteStream(c),d=new C({objectMode:!0,transform(e,t,s){try{s(null,I.stringify(e,{relaxed:!1})+"\n")}catch(e){s(e)}}}),u=O(),p=j(d,u,l),_=n.find({},{batchSize:this.cursorBatchSize});let m=0;for await(const e of _){const t=d.write(e);m++,m%5e4==0&&console.log(`  ${s}: ${m} docs processed...`),t||await new Promise(e=>d.once("drain",e))}d.end(),await p,console.log(`  ${s}: ${m} docs backed up`),o.push({name:s,indexes:r,documentCount:m})}const i={dbName:this.dbo.databaseName,date:(new Date).toISOString(),collections:o};return t.writeFileSync(a.join(e,"_meta.json"),JSON.stringify(i,null,2)),i}async restore(e,{drop:s=!1}={}){const n=t.readFileSync(a.join(e,"_meta.json"),"utf-8"),o=JSON.parse(n),i={};for(const n of o.collections){const{name:o,indexes:r,documentCount:c}=n;console.log(`Restoring collection: ${o} (${c} docs)`);const l=this.dbo.collection(o);if(s)try{await l.drop()}catch(e){}const d=a.join(e,`${o}.ndjson.gz`),u=t.createReadStream(d),p=x(),_=A.createInterface({input:u.pipe(p),crlfDelay:1/0});let m=[],g=0,f=0;for await(const e of _){if(!e.trim())continue;const t=I.parse(e);if(m.push(t),m.length>=this.batchSize){try{g+=(await l.insertMany(m,{ordered:!1})).insertedCount}catch(e){if(11e3!==e.code)throw e;g+=e.result?.nInserted||e.insertedCount||0,f+=m.length-(e.result?.nInserted||e.insertedCount||0)}m=[]}}if(m.length>0)try{g+=(await l.insertMany(m,{ordered:!1})).insertedCount}catch(e){if(11e3!==e.code)throw e;g+=e.result?.nInserted||e.insertedCount||0,f+=m.length-(e.result?.nInserted||e.insertedCount||0)}for(const e of r){if("_id_"===e.name)continue;const{key:t,...s}=e;delete s.v;try{await l.createIndex(t,s)}catch(t){console.error(`  Warning: failed to create index ${e.name} on ${o}:`,t.message)}}console.log(`  ${o}: ${g} inserted, ${f} errors`),i[o]={inserted:g,errors:f}}return{collections:o.collections,results:i}}}var be=!1;async function Se(e,s,n=!1){if(be)throw new Error("Backup already in progress");be=!0;try{t.ensureDirSync(R);const o=(new Date).toISOString().replace(/[:.]/g,"-"),i=`backup_${o}`,r=a.join(R,`.tmp_${o}`);t.ensureDirSync(r);try{const o=new we(e,{batchSize:1e3,cursorBatchSize:500}),c=await o.backup(r);!1!==s.include_config_file&&t.existsSync(B)&&t.copyFileSync(B,a.join(r,"conf.json"));const l={name:i,timestamp:(new Date).toISOString(),manual:n,collections:c.collections.map(e=>({name:e.name,documentCount:e.documentCount})),includesConfig:!1!==s.include_config_file&&t.existsSync(B)};t.writeFileSync(a.join(r,"_backup_info.json"),JSON.stringify(l,null,2));const d=a.join(R,`${i}.tar.gz`);await D.create({gzip:!0,file:d,cwd:r},t.readdirSync(r)),t.writeFileSync(a.join(R,`${i}.info.json`),JSON.stringify(l,null,2));const u=s.auto_backup?.max_retention_count||10;return function(e,s){if(!t.existsSync(e))return;const n=t.readdirSync(e).filter(e=>e.startsWith("backup_")&&e.endsWith(".tar.gz")).map(s=>({name:s,path:a.join(e,s),time:t.statSync(a.join(e,s)).mtime.getTime()})).sort((e,t)=>t.time-e.time);if(n.length>s){const e=n.slice(s);for(const s of e){console.log(`Retention: deleting old backup ${s.name}`),t.removeSync(s.path);const e=s.path.replace(".tar.gz",".info.json");t.existsSync(e)&&t.removeSync(e)}}}(R,u),console.log(`Backup complete: ${d}`),l}finally{t.removeSync(r)}}finally{be=!1}}function ve(e,t){e&&e.sendStatus(500),console.error(t)}function $e(e){return e.charAt(0).toUpperCase()+e.slice(1)}function ke(){return{web_server:{bind_ip:"0.0.0.0",http_server_disabled:"true"==process.env.HTTP_SERVER_DISABLED&&"1"==process.env.HTTP_SERVER_DISABLED||!1,http_port:80,https_server_disabled:"true"==process.env.HTTPS_SERVER_DISABLED&&"1"==process.env.HTTPS_SERVER_DISABLED||!1,https_port:443,force_https:!1,session_duration_hours:168},database:{mongo:{host:process.env.MONGODB_CONNECTION_STRING||"127.0.0.1",port:27017,database:"Whitelister"}},app_personalization:{name:"Whitelister",favicon:"",accent_color:"#ffc40b",logo_url:"https://joinsquad.com/wp-content/themes/squad/img/logo.png",logo_border_radius:"10",title_hidden_in_header:!1,send_welcome_message:!0},discord_bot:{token:"",server_id:"",whitelist_updates_channel_id:""},squadjs:[{websocket:{host:"",port:3e3,token:""}}],custom_permissions:[{name:"Example Custom Permission",permission:"example_custom_perm"}],other:{automatic_updates:!0,update_check_interval_seconds:3600,whitelist_developers:!0,install_beta_versions:!1,logs_max_file_count:10,lists_cache_refresh_seconds:60,prefer_eosID:!0,prepend_date_time_in_console:!1,force_lists_output_caching:!1,logs_max_file_size_mb:250,logs_max_buffer_size_mb:.5},security:{concurrent_sessions_triggers_IP_blacklisting:!0}}}function Ie(e,t){console.log("upgrading conf");for(let s in t)if(void 0!==e[s])if(Array.isArray(t[s])){Array.isArray(e[s])||(e[s]=[e[s]]);for(let n=0;n<t[s].length;n++)n>=e[s].length?e[s].push(JSON.parse(JSON.stringify(t[s][n]))):Ie(e[s][n],t[s][n])}else"object"==typeof t[s]?("object"==typeof e[s]&&null!==e[s]||(e[s]={}),Ie(e[s],t[s])):typeof e[s]!=typeof t[s]&&("number"!=typeof t[s]||isNaN(+e[s])?e[s]=t[s]:e[s]=+e[s]);else e[s]=JSON.parse(JSON.stringify(t[s]))}function De(e,t=null){const s=E(e._id);if(!s)return t?t.status(400).send({error:"Invalid whitelist ID"}):void 0;he(n=>{!e.approve_update||1!=e.approve_update&&"true"!=e.approve_update?n.collection("whitelists").deleteOne({_id:s},(e,s)=>{e?ve(t,e):t&&t.send({status:"rejected",...s})}):n.collection("whitelists").updateOne({_id:s},{$set:{approved:!0}},(e,s)=>{e?ve(t,e):t&&t.send({status:"approved",...s})})})}function Oe(e=64){const t=u.randomBytes(e).toString("base64").slice(0,e);return t.match(/^[a-zA-Z\d]{1,}$/)?t:Oe(e)}function xe(e,t,s,n){t.userSession&&t.userSession.access_level<=e?n():s.sendStatus(401)}function je(e,s=0){if(s>=e.length)return null;return t.existsSync(e[s])?e[s]:je(e,++s)}function Ce(e,t=()=>{},s=15){console.log("Looking for free port close to "+e);const n=H?.web_server?.bind_ip||"0.0.0.0";try{w(e,n,async function a(c,l){r.push(l);let d=l,u=o.createServer(),p=!1;await u.listen(d,n).on("error",t=>{console.error(" > Failed",t.port),p=!0;let n=(443==e?4443:8080)+100*i;if(++i<s)try{w(n,a)}catch(e){}else console.error(" > Couldn't find a free port.\n > Terminating process..."),process.exit(1)}),u.close(),p||(console.log(" > Found free port: "+d),t(d))})}catch(e){}let i=0,r=[]}process.on("uncaughtException",function(e){if(console.error("Uncaught Exception",e.message,e.stack),++P>=(y["self-pm"],5))return console.error("Too many errors occurred during the current run. Terminating execution..."),restartProcess(0,1,y);T&&clearTimeout(T),T=setTimeout(()=>{P=0,clearTimeout(T)},3e5)})}async function restartProcess(e=0,t=0,s=null,n=!1){var o;e>0&&await new Promise(t=>setTimeout(t,e)),s&&s["self-pm"]&&1==s["self-pm"]||n?process.on("exit",function(){console.log("Process terminated\nStarting new process"),require("child_process").spawn(process.argv.shift(),process.argv,{cwd:process.cwd(),detached:!0,stdio:"inherit"})}):console.log("Terminating execution. Process manager will restart me."),(o=()=>{process.exit(t)})&&o()}function terminateAndSpawnChildProcess(e=0,t=0){process.on("exit",function(){console.log("Process terminated\nStarting new process"),require("child_process").spawn(process.argv.shift(),process.argv,{cwd:process.cwd(),detached:!0,stdio:"inherit"})}),setTimeout(()=>{process.exit(e)},t)}init();